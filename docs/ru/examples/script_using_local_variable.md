---
title: Передача данных между шаблонами с помощью C#
tags:
    - C#
    - скрипт
    - C#-скрипт
    - кнопка 
hide: 
    - tags
kbId:
---

# Передача данных между шаблонами с помощью кнопки, C#-скрипта и локальной переменной

## Введение

Иногда справочные данные (мастер-данные) требуется копировать в транзакционные данные, чтобы их можно было изменять в целевой записи, не влияя на исходный справочник.

Здесь представлена инструкция, как настроить кнопку для передачи данных из справочника в шаблон записи по нажатию кнопки с использованием C#-скрипта и локальной переменной.

## Прикладная задача

Существует справочник _«Номенклатура продукции»_, который содержит наименования, единицы измерения и стандартную цену товаров.

Также есть шаблон _«Конкурсы»_, в котором содержится информация о проводимых конкурсах на закупку.

С конкурсами связан шаблон _«Позиции в конкурсе»_, в котором хранятся сведения о товарах, добавленных в конкурс на закупку, включая, например,количество и сумму закупки.

Требуется настроить кнопку, которая будет добавлять позиции из справочника, выбранные в таблице, в конкурс на закупку. При этом сведения о выбранных товарах должны копироваться из справочника в шаблон _«Позиции в конкурсе»_. В скопированных позициях можно будет изменять сведения для конкретного конкурса (например, цену), а сведения о товарах в справочнике должны оставаться неизменными.

## Создание кнопки для передачи данных

1. Создайте шаблон записи _«Номенклатура продукции»_ со следующими **атрибутами**:

| Название            | Тип       | Свойства                                                  |
| ------------------- | --------- | --------------------------------------------------------- |
| _Наименование_      | **Текст** | **Использовать как заголовок записей:** флажок установлен |
| _Единица измерения_ | **Текст** |                                                           |
| _Цена_              | **Число** | **Количество знаков после запятой: 2**                    |

2. Добавьте созданные атрибуты на **форму**.
3. Создайте шаблон записи _«Позиции в конкурсе»_ со следующими **атрибутами**:

| Название            | Тип       | Свойства                                                                                                                                                                                                                                                                                                                              |
| ------------------- | --------- | ---------- |
| _Наименование_      | **Текст** | **Использовать как заголовок записей:** флажок установлен |
| _Единица измерения_ | **Текст** |                                        |
| _Цена_              | **Число** | **Количество знаков после запятой: 2** |
| _Количество_        | **Число** | **Количество знаков после запятой: 0** |
| _Сумма_             | **Число** | <p>**Количество знаков после запятой: 2**</p><p>**Вычислять автоматически:** флажок установлен</p><p>**Вычисляемое значение: формула**</p><p>`PRODUCT($Tsena, $Kolichestvo)`</p><p>**Здесь:**</p><p>`PRODUCT()` — вычисление произведения двух чисел.</p><p>`Tsena` — системное имя атрибута _«Цена»_.</p><p>`Kolichestvo` — системное имя атрибута _«Количество»_.</p> |

4. Создайте шаблон записи _«Конкурсы»_ с **атрибутами**:

| Название           | Тип        | Свойства |
| ------------------ | ---------- | ------------------ |
| _Название_         | **Текст**  | **Использовать как заголовок записей:** флажок установлен |
| _Позиции конкурса_ | **Запись** | <p>**Связанный шаблон:** _Позиции в конкурсе_</p><p>**Хранить несколько значений:** флажок установлен</p><p>**Взаимная связь с атрибутом:** **с новым**</p><p>**Название:** _Конкурс_</p> |

1. Добавьте атрибуты _«Название»_ и _«Позиции конкурса»_ на **форму**.
2. Выберите для атрибута _«Позиции конкурса»_ отображение в виде таблицы и добавьте в неё созданные атрибуты.
3. Добавьте для таблицы _«Позиции конкурса»_ кнопку «**Редактировать**».
4. Создайте кнопку _«Добавить позиции в конкурс»_ для шаблона _«Номенклатура продукции»_.
5. На вкладке **«Локальные переменные»** создайте переменную со следующими свойствами:

	- **Отображаемое название:** _Конкурс_
	- **Тип данных: запись**
	- **Системное имя:** _konkurs_
	- **Шаблон:** _Конкурсы_

6.   Добавьте C#-скрипт:

```cs
using System; 
using System.Collections.Generic;
using System.Linq;
using Comindware.Data.Entity;
using Comindware.TeamNetwork.Api.Data.UserCommands;
using Comindware.TeamNetwork.Api.Data;

class Script
{
    public static UserCommandResult Main(UserCommandContext userCommandContext, Comindware.Entities entities)
    {
        var data = userCommandContext.LocalVariables;
        string konkursId = "";
        string notify = "Позиции добавлены в выбранный конкурс";
        // получаем ID конкурса из локальной переменной с системным именем konkurs
        data.TryGetValue("konkurs", out object obj_);
        if (obj_ != null)
        {
            konkursId = (obj_ as object[]).FirstOrDefault().ToString();
        }
        // проверяем, что в таблице выбрана хотя бы одна строка
        if (userCommandContext.ObjectIds.Count() == 0)
        {
            var resultBad0 = new UserCommandResult
            {
        Success = false,
        Commited = false,
        ResultType = UserCommandResultType.Notificate,
        Messages = new[]
        {
          new UserCommandMessage
          {
            Severity = SeverityLevel.Normal,
            Text = "Ни одной позиции не выбрано"
          }
        }
      };
      return resultBad0;
        }
        
        Decimal posNum = 0;
        foreach (string selectId in userCommandContext.ObjectIds)
        {
            Dictionary<string,object> data_new = new Dictionary<string,object>();
			
			// собираем данные из шаблона записи «Номенклатура продукции»
            var data_selectId = Api.TeamNetwork.ObjectService.GetPropertyValues(new String[]{selectId}, new String[]{"Naimenovanie", "Edinitsaizmereniya", "Tsena"});
            // копируем значения атрибутов шаблона «Номенклатура продукции» в атрибуты позиции в конкурсе
            if (data_selectId[selectId].ContainsKey("Naimenovanie"))
                data_new.Add("Naimenovanie", data_selectId[selectId]["Naimenovanie"]);
            if (data_selectId[selectId].ContainsKey("Edinitsaizmereniya"))
                data_new.Add("Edinitsaizmereniya", data_selectId[selectId]["Edinitsaizmereniya"]);
            if (data_selectId[selectId].ContainsKey("Tsena"))
                            data_new.Add("Tsena", data_selectId[selectId]["Tsena"]);
            data_new.Add("Produktsiyanazakupku", data_selectId[selectId]["id"]);
		    // если конкурс выбран, проставляем ссылку на него в текущую позицию
            if (konkursId != "") 
            {
                // Konkurs — системное имя атрибута «Конкурс» шаблона записи «Позиции в конкурсе»
                data_new.Add("Konkurs", konkursId);
            }
            posNum++;

		    // Создаём запись в шаблоне Pozitsiivkonkurse (Позиции в конкурсе) со скопированными данными
            Api.TeamNetwork.ObjectService.CreateWithAlias("Pozitsiivkonkurse", data_new);
        }

    // Завершаем работу скрипта    
    var result = new UserCommandResult
    {
            Success = true,
		    Commited = true,
		    ResultType = UserCommandResultType.Navigate,
            NavigationResult = new UserCommandNavigationResult
            {
                Context = ContextType.Task,
            },
            Messages = new[]
      {
        new UserCommandMessage
        {
	        Severity = SeverityLevel.Normal,
	        Text = notify
        }
      }
    };
    return result;
    }
}
```

11.  Отредактируйте свойства кнопки:

	- **Отображаемое название:** _Добавить позиции в конкурс_
	- **Контекст операции: запись**
	- **Операция: C# скрипт**
	- **Результат выполнения: обновить данные**
	- **Отображать диалоговое окно:** флажок установлен

12.  Нажмите кнопку «**Сохранить**».
13.  Нажмите гиперссылку «**Настроить диалоговое окно**».
14.  Вынесите локальную переменную _«Конкурс»_ на форму и сохраните.
15.  Вынесите кнопку _«Добавить позиции в конкурс»_ на форму таблицы записей шаблона _«Номенклатура продукции»_.

## Тестирование

1. Создайте _«Тестовый конкурс»_.
2. Создайте несколько записей в шаблоне _«Номенклатура продукции»_ и заполните данными.

	_![Пример справочника продукции, доступной к закупке](script_using_local_variable_reference.png)_

3. Выберите одну или несколько позиций в таблице _«Номенклатура продукции»_ и нажмите кнопку _«Добавить позиции в конкурс»_.
4.  Выберите _«Тестовый конкурс»_ в раскрывающемся в списке и нажмите кнопку _«Добавить позиции в конкурс»_.
5. Перейдите к записи _«Тестовый конкурс»_, выберите любую позицию и нажмите кнопку «**Редактировать**».
6. Укажите количество продукции для выбранной позиции.

	_![Отображение добавленных позиций в тестовом конкурсе](script_using_local_variable_contest.png)_

--8<-- "related_topics_heading.md"

**[Кнопки. Определение, настройка, удаление][buttons]**

**[Написание скриптов на языке C#][manual_csharp]**

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}
