---
title: Сценарий. Проверка данных записи перед сохранением
tags:
    - проверить результат выражения
    - сценарий
    - валидация данных
hide: tags
kbid: 4919
---

# Сценарий. Проверка данных записи перед сохранением {: #scenario_verify_data}

Для проверки данных перед сохранением записи обычно используется действие «**Показать ошибку**» в правилах для формы. Однако с помощью этого действия может быть затруднительно реализовать сложную логику проверки, либо проверочное выражение будет неудобочитаемым. К тому же чрезмерно сложные правила для формы могут замедлять ввод данных в форму.

В таких случаях для проверки данных перед сохранением записи можно использовать действие «[**Проверить результат выражения**][scenario_actions_validate_expression]» или «[**Проверить результат скрипта**][scenario_actions_validate_csharp]» в сценарии по событию «**Создание записи**», «**Изменение записи**» или «**Нажата кнопка**». Сценарий позволяет наглядно реализовать логику проверки данных произвольной сложности. Кроме того, сценарий срабатывает только при сохранении записи, благодаря чему повышается производительность.

Также при помощи C#-скрипта в действии «**Проверить результат скрипта**» можно изменить значения атрибутов в записи без использования действия «**Изменить значения атрибутов**».

Выражение N3 не позволяет напрямую изменять значения атрибутов, однако с его помощью можно создать **[переменную сценария][scenario_variables]** и поместить в неё необходимые данные для дальнейшего использования.

Здесь представлены следующие варианты проверки данных перед сохранением с помощью:

- [формулы](#настройка-сценария-с-использование-действия-проверить-результат-выражения-и-формулы);
- [выражения N3](#настройка-сценария-с-использование-действия-проверить-результат-выражения-и-выражения-n3);
- [C#-скрипта](#настройка-сценария-с-использованием-действия-проверить-результат-скрипта).

## Прикладная задача

Необходимо настроить сценарий, который будет запрещать сохранение заявки, если не указан комментарий к ней, и изменять значение логического атрибута.

### Исходные данные

Имеется шаблон _«Заявки»_. В нём есть текстовый атрибут _«Комментарий»_ (`Comment`) и логический атрибут _«Заявка заполнена»_ (`RequireFilled`).

## Настройка сценария с использование действия «Проверить результат выражения» и формулы

1. Создайте сценарий.
2. В начальном событии «**Нажата кнопка**» выберите контекстный шаблон _«Заявки»_ и кнопку «**Сохранить**».
3. Добавьте действие «**Проверить результат выражения**» со следующими свойствами:

    - **Сообщение об ошибке:** _Требуется заполнить комментарий_
    - **Выражение: формула**

          ``` cs
          // Введите выражение, которое будет возвращать
          // false, когда сохранение записи запрещено, и
          // true, когда сохранение записи разрешено.
          NOT(EMPTY($Comment))
          ```

4. Добавьте действие «**Изменить значения атрибутов**» со следующими свойствами:

    - **Атрибут:** _Проверка пройдена_
    - **Операция со значениями: заменить**
    - **Значение: формула**

        ``` cs
        true
        ```

### Тестирование сценария

1. Создайте заявку и не заполняйте поле _«Комментарий»_.
2. Нажмите кнопку «**Сохранить**».
3. На экране отобразится сообщение _«Требуется заполнить комментарий»_.
4. Заполните поле _«Комментарий»_ и нажмите кнопку «**Сохранить**».
5. Отобразится сообщение об успешном сохранении записи, а в поле _«Заявка заполнена»_ будет установлен флажок.

## Настройка сценария с использование действия «Проверить результат выражения» и выражения N3

1. Создайте сценарий.
2. В начальном событии «**Нажата кнопка**» выберите контекстный шаблон _«Заявки»_ и кнопку «**Сохранить**».
3. Добавьте действие «**Проверить результат выражения**» со следующими свойствами:

    - **Сообщение об ошибке:** _Требуется заполнить комментарий_
    - **Выражение: N3**

        ``` turtle
        # Импортируем функции для работы
        # с данными текущей записи и переменными
        @prefix object: <http://comindware.com/ontology/object#>.
        @prefix variable: <http://comindware.com/ontology/session/variable#>.
		@prefix operator: <http://comindware.com/ontology/session/operator#>.

        {
            # Находим атрибут Comment (Комментарий)  
            # в шаблоне Requires (Заявки). 
            ("Requires" "Comment") object:findProperty ?CommentAttribute.
            # Проверяем, не является ли
            # ?CommentAttribute пустым.
            if {
                ?item ?CommentAttribute ?.
            }
            # Если в ?CommentAttribute есть данные,
            # возвращаем логическое true
            then {
                # Создаём ?trueValue и помещаем в него
                # логическое значение true
                true -> ?trueValue.
                # Создаём переменную сценария CheckResult
                variable:CheckResult operator:add ?item.
                # создаём переменную TrueValue внутри CheckResult
                # и помещаем в неё значение ?trueValue
                (?item variable:TrueValue) operator:replace ?trueValue.
                # Возвращаем значение ?trueValue
                ?trueValue -> ?value.
            }
            # Если ?CommentAttribute пустой,
            # возвращаем логическое false
            else {
                false -> ?value.
            }
        }
        ```

4. Добавьте действие «**Изменить значения атрибутов**» со следующими свойствами:

    - **Атрибут:** _Проверка пройдена_
    - **Операция со значениями: заменить**
    - **Значение: формула**

        ``` cs
        $$CheckResult->TrueValue
        ```

### Тестирование сценария

1. Создайте заявку и не заполняйте поле _«Комментарий»_.
2. Нажмите кнопку «**Сохранить**».
3. На экране отобразится сообщение _«Требуется заполнить комментарий»_.
4. Заполните поле _«Комментарий»_ и нажмите кнопку «**Сохранить**».
5. Отобразится сообщение об успешном сохранении записи, а в поле _«Заявка заполнена»_ будет установлен флажок.

## Настройка сценария с использованием действия «Проверить результат скрипта»

1. Создайте новый сценарий _«Заполнение заявок»_.
2. В начальном событии «**Нажата кнопка**» выберите контекстный шаблон _«Заявки»_ и кнопку «**Сохранить**».
3. Добавьте действие «**Проверить результат скрипта**» со следующими свойствами:

    - **Сообщение об ошибке:** _Требуется заполнить комментарий_
    - **Выражение:**

    ``` cs
    using System; 
    using System.Collections.Generic;
    using System.Linq;
    using Comindware.Data.Entity;
    using Comindware.TeamNetwork.Api.Data.UserCommands;
    using Comindware.TeamNetwork.Api.Data;

    class Script
    {
        public static bool Main(Object FullObjectId)
        { 
            // Получаем ID текущей записи шаблона «Заявки» из контекста выполнения сценария. 
            var ObjectId = FullObjectId.ToString().Replace("user.", "");
            // Помещаем в CommentData информацию об атрибуте Comment (Комментарий) текущей записи. 
            var CommentData = Api.TeamNetwork.ObjectService.GetPropertyValues(new []{ObjectId}, new []{"Comment"});
            // Получаем значение атрибута Comment (Комментарий) в текущей записи.
            var Comment = data[ObjectId].TryGetValue("Comment", out object OutputRecordArray) && OutputRecordArray != null ? OutputRecordArray as string : null; 
                                                                    
            if(Comment != null)
            {        
             	// Инициализируем словарь атрибутов в виде пар «системное_имя_атрибута:содержимое».
                var Dict = new Dictionary<string,object>
                {
                    { "RequireFilled", true }
                }; 
                // Меняем значение атрибута RequireFilled (Заявка заполнена) в текущей записи.
                Api.TeamNetwork.ObjectService.EditWithAlias(ObjectId, Dict);
                return true;
            }
            else
            {
                return false;
            }

        }
    }
    ```

### Тестирование сценария

1. Создайте заявку и не заполняйте поле _«Комментарий»_.
2. Нажмите кнопку «**Сохранить**».
3. На экране отобразится сообщение _«Требуется заполнить комментарий»_.
4. Заполните поле _«Комментарий»_ и нажмите кнопку «**Сохранить**».
5. Отобразится сообщение об успешном сохранении записи, а в поле _«Заявка заполнена»_ будет установлен флажок.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- _[Событие и действия сценария. Определения, типы, свойства, настройка][scenario_elements]_
- _[Отладка формул, выражений N3, сценариев и C#-скриптов][expression_debug]_

</div>

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}
