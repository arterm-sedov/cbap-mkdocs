---
title: Атрибуты типа «Запись» и «Документ». Формирование и скачивание архива с файлами из связанных записей
tags:
    - C#
    - C#-скрипт
    - скрипт
    - скачать документы
    - документ
    - атрибут типа «Документ»
    - атрибут типа «Запись»
    - скачать файлы
    - скачать архив
hide: tags
kbId: 5077
---

# Атрибуты типа «Запись» и «Документ». Формирование и скачивание архива с файлами из связанных записей {: #download_document_archive_related_record}

## Введение

**{{ productName }}** позволяет прикрепить любые файлы к атрибуту типа «**Документ**». При этом, для каждой записи файл приходится скачивать отдельно.

Атрибут типа «**Запись**» позволяет настроить связь записи шаблона с реестром, в котором хранятся документы. С помощью C#-скрипта можно настроить кнопку для скачивания в одном архиве всех файлов, связанных с определённой записью.

Также при C#-скрипта можно добавить этот архив файлов в атрибут типа «**Документ**».

Здесь представлен пример настройки кнопки, скачивающей все файлы, которые связаны с текущей записью, и добавляющей этот архив в атрибут типа «**Документ**».

## Прикладная задача

Имеется шаблон _«Заявки»_. К заявке можно прикрепить документы. Они хранятся в атрибуте типа «**Документ**» шаблона _«Реестр документов»_, связанного с шаблоном _«Заявки»_.

Необходимо создать кнопку для скачивания архива с документами, прикреплёнными к заявке. Архив также должен прикрепляться к атрибуту _«Архив документов»_ шаблона _«Заявки»_.

## Настройка кнопки для скачивания файлов

Чтобы скачать документы, нужно настроить соответствующую кнопку и скрипт для неё.

1. Создайте **шаблон записи** _«Реестр документов»_ со следующими **атрибутами**:

    | Название       | Системное имя | Тип данных   | Свойства                                               |
    | -------------- | ------------- | ------------ | ------------------------------------------------------ |
    | _Вложения_     | _Attachment_  | **Документ** | <ul><li>**Использовать для поиска записей:** флажок установлен</li><li>**Хранить несколько значений:** флажок установлен</li> |

    !!! warning "Внимание!"

        Для корректного скачивания файлов с помощью C#-скрипта у атрибута типа «**Документ**» рекомендуется установить флажок «**Использовать для поиска записей**». В противном случае скрипт может не сработать.

2. В **шаблоне записи** _«Заявки»_ создайте **атрибут**:

    | Название    | Системное имя | Тип данных | Свойства                                                                                                         |
    | ----------- | ------------- | ---------- | ---------------------------------------------------------------------------------------------------------------- |
    | _Документы_ | _Documents_   | **Запись** | <ul><li>**Связанный шаблон:** _Реестр документов_</li><li>**Хранить несколько значений:** флажок установлен</li> |
    | _Архив документов_ | _Archive_ | **Документ** ||

3. Создайте [**кнопку**][buttons] _«Скачать архив документов»_ со следующими свойствами:

    - **Контекст операции: запись**;
    - **Операция:** **С#-скрипт**;
    - **Результат выполнения: скачать документ**.

4. На вкладке «**Скрипт**» добавьте следующий C#-скрипт:

    ``` cs
    using System; 
    using System.Collections.Generic;
    using System.IO; 
    using Comindware.Data.Entity;
    using Comindware.TeamNetwork.Api.Data.UserCommands;
    using Comindware.TeamNetwork.Api.Data;
    using System.Collections.Generic;
    using System.Linq;

    class Script
    {
        // Функция UserCommandResult указывает, что скрипт выполняется в контексте кнопки
        public static UserCommandResult Main(UserCommandContext userCommandContext, Comindware.Entities entities)
        { 
            // Получаем ID текущей записи шаблона «Заявки» из контекста операции кнопки.
            var id = userCommandContext.ObjectIds[0];
            // Помещаем в массив data идентификаторы записей шаблона «Реестр документов»
            // из атрибута «Документы» текущей записи.
            // Documents — системное имя атрибута «Документы».
            var data = Api.TeamNetwork.ObjectService.GetPropertyValues(new string[] {id}, new [] {"Documents"});
            // По идентификаторам получаем массив записей шаблона «Реестр документов», связанных с текущей записью.
            var DocumentsRecords = data[id].TryGetValue("Documents", out object OutputRecordArray) && OutputRecordArray != null ? OutputRecordArray as object[] : null;
            // Инициализируем словарь файлов для архива в виде пар «имя:содержимое».
            var files = new Dictionary<string, byte[]>();
            // Добавляем файлы в поток для дальнейшего архивирования
            // из каждой записи шаблона «Реестр документов».
            foreach (var DocumentRecord in DocumentsRecords)
            {
                // Получаем идентификатор записи шаблона «Реестр документов».
                var docId = DocumentRecord.ToString();
                // Помещаем в массив documentIds идентификаторы прикреплённых документов.
                // Attachment — системное имя атрибута «Вложения» шаблона «Реестр документов».
                var documentIds = Api.TeamNetwork.ObjectService.GetPropertyValues(new []{docId} , new [] {"Attachment"});
                // По идентификаторам получаем массив прикреплённых документов.
                var documents = documentIds[docId].TryGetValue("Attachment", out object doc_Obj) && doc_Obj != null ? doc_Obj as object[] : null;
                if(documents.Length > 0)
                {
                    // Добавляем в словарь все файлы, прикреплённые к атрибуту «Вложения».
                    foreach(var doc in documents)
                    {
                    // Получаем прикреплённый файл.
                    var fileContent = Api.TeamNetwork.DocumentService.GetContent(doc.ToString());
                    // Помещаем содержимое файла в словарь файлов для архива по имени.
                    files[fileContent.Name] = fileContent.Data;
                    }
                }
            }
            // Формируем архив файлов из словаря files.
            var resultingArchive = Api.TeamNetwork.DocumentService.GetZippedStreams(files);
            // Помещаем результирующий архив в массив байтов.
            byte[] compressedBytes = resultingArchive.ToArray();
            // Инициализируем документ для файла архива.
            var archive = new Document 
            {
                Title = "Data.zip",
                Extension = ".zip"
            };
            // Создаём поток для прикрепления документа с архивом к атрибуту.
            var resultingStream = new MemoryStream();
                    resultingStream.Write(compressedBytes, 0, compressedBytes.Length);
                    resultingStream.Seek(0, SeekOrigin.Begin);

                    // Создаём в потоке файл архива, чтобы передать его в атрибут.
                    string archiveToAttribute = Api.TeamNetwork.DocumentService.CreateDocumentWithStream(archive, resultingStream, "");
                    var AttributeEdit = new Dictionary<string,object>
                    {
                        // op.1 — ID атрибута «Архив документов».
                        { "op.1", archiveToAttribute }
                    };
                    // Прикрепляем архив к атрибуту «Архив документов».
                    Api.TeamNetwork.ObjectService.Edit(id, AttributeEdit);
            // Возвращаем архив для скачивания в качестве результата нажатия кнопки.            
            return new UserCommandResult
            {
                Success = true,
                Commited = true,
                File = new UserCommandFileResult
                {
                    Content = resultingArchive,
                    // Укажите имя архива
                    Name = archive.Title
                }
            };
        }
    }
    ```

5. Поместите на форму шаблона _«Заявки»_ **атрибут** _«Архив документов»_ и **кнопку** _«Скачать архив документов»_.
6. Поместите на форму **атрибут** _«Документы»_ и настройте его **представление** в виде **таблицы**.
7. Поместите в таблицу _«Документы»_ на форме **атрибут** _«Вложения»_ шаблона записи _«Реестр документов»_.
8. В область кнопок таблицы _«Документы»_ поместите кнопки «**Создать**».

## Тестирование

1. Создайте новую запись шаблона _«Заявки»_ и добавьте несколько строк с документами в таблицу _«Документы»_.
2. Сохраните запись.
3. Нажмите кнопку _«Скачать архив документов»_.
4. Браузер скачает архив со всеми файлами, которые связаны с записью шаблона _«Заявки»_.

    !!! note "Примечание"

        Если в браузере отобразится сообщение «**Незащищенное скачивание заблокировано**», нажмите кнопку «**Сохранить**», чтобы продолжить скачивание.

5. В поле _«Архив документов»_ должен появиться архив с файлами, которые связаны с записью шаблона _«Заявки»_.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- _[Атрибут типа «Запись»][attribute_record]_
- _[Атрибут типа «Документ»][attribute_document]_
- _[Кнопки. Определение, настройка, удаление][buttons]_
- _[Написание скриптов на языке C#][manual_csharp]_
- _[Атрибут типа «Документ». Скачивание архива с файлами из таблицы и записи][download_document_archive_csharp]_

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}
