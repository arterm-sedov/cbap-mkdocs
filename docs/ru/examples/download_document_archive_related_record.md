---
title: Атрибут типа «Документ». Скачивание архива с файлами
tags:
    - C#
    - C#-скрипт
    - скрипт
    - скачать документы
    - документ
    - атрибут типа «Документ»
    - атрибут типа «Запись»
    - скачать файлы
    - скачать архив
hide: tags
kbId: 4921
---

# Атрибуты типа «Запись» и «Документ». Скачивание архива с файлами из связанных записей {: #download_document_archive_related_record}

## Введение

**{{ productName }}** позволяет прикрепить любые файлы к атрибуту типа «**Документ**». При этом, для каждой записи файл приходится скачивать отдельно.

Атрибут типа «**Запись**» позволяет настроить связь записи шаблона с документами, которые хранятся в отдельном реестре. С помощью C#-скрипта можно настроить кнопку для скачивания в одном архиве всех файлов, связанных с определённой записью.

Здесь представлен пример настройки кнопки, скачивающей файлы из всех записей, которые связаны с текущей записью посредством атрибута.

## Прикладная задача

Имеется шаблон _«Заявки»_. С ним связан шаблон _«Реестр документов»_, в котором хранятся файлы.

Пользователь должен иметь возможность скачать все файлы из записей шаблона _«Реестр документов»_, которые связаны с записью шаблона _«Заявки»_.

## Настройка кнопки для скачивания файлов

Чтобы скачать документы, нужно настроить соответствующую кнопку и скрипт для неё.

1. Создайте **шаблон записи** _«Реестр документов»_.
2. Создайте следующие **атрибуты**:

    | Название       | Системное имя | Тип данных   | Свойства                                               |
    | -------------- | ------------- | ------------ | ------------------------------------------------------ |
    | _Наименование_ | _Name_        | **Текст**    |                                                        |
    | _Вложение_     | _Attachment_  | **Документ** | **Использовать для поиска записей:** флажок установлен |

    !!! warning "Внимание!"

        Для корректного скачивания файлов с помощью C#-скрипта у атрибута типа **«Документ**» рекомендуется установить флажок «**Использовать для поиска записей**». В противном случае скрипт может не сработать.

3. В **шаблоне записи** _«Заявки»_ создайте **атрибут**:

    | Название    | Системное имя | Тип данных | Свойства                                                                                                         |
    | ----------- | ------------- | ---------- | ---------------------------------------------------------------------------------------------------------------- |
    | _Документы_ | _Documents_   | **Запись** | <ul><li>**Связанный шаблон:** _Реестр документов_</li><li>**Хранить несколько значений:** флажок установлен</li> |

4. Создайте [**кнопку**][buttons] _«Скачать все вложения»_ со следующими свойствами:

    - **Контекст операции: запись**;
    - **Операция:** **С#-скрипт**;
    - **Результат выполнения: скачать документ**.

5. На вкладке «**Скрипт**» добавьте следующий C#-скрипт:

    ``` cs title="Скрипт для скачивания архива с файлами"
    using System; 
    using System.Collections.Generic;
    using System.IO; 
    using System.IO.Compression;
    using Comindware.Data.Entity;
    using Comindware.TeamNetwork.Api.Data.UserCommands;
    using Comindware.TeamNetwork.Api.Data;

    class Script
    {
        public static UserCommandResult Main(UserCommandContext userCommandContext, Comindware.Entities entities)
        { 
            var id = userCommandContext.ObjectIds[0];
            // Укажите системное имя атрибута «Документы» шаблона «Заявки»
            var data = Api.TeamNetwork.ObjectService.GetPropertyValues(new string[] {id}, new [] {"Documents"});
            // Из контекста записи шаблона «Заявки» получаем ID связанных записей
            // Укажите системное имя атрибута «Документы» шаблона «Заявки»
            var documentIdsObjs = data[id].TryGetValue("Documents", out object id_Documents_Obj) && id_Documents_Obj != null ? id_Documents_Obj as object[] : null;
            var streamsToZip = new Dictionary<string, byte[]>();

            // Добавляем вложения в поток для дальнейшего архивирования
            foreach (var documentIdObj in documentIdsObjs)
            {
                var idDoc = documentIdObj.ToString();
                // Укажите системное имя атрибута «Вложение» шаблона «Реестр документов»
                var documentDataVal = Api.TeamNetwork.ObjectService.GetPropertyValues(new []{idDoc} , new [] {"Attachment"});

                // Укажите системное имя атрибута «Вложение» шаблона «Реестр документов»
                var documentId = documentDataVal[idDoc].TryGetValue("Attachment", out object doc_Obj) && doc_Obj != null ? doc_Obj as string : null;
                if(documentId != null)
                {
                    var documentData = Api.TeamNetwork.DocumentService.GetContent(documentId);

                    streamsToZip[documentData.Name] = documentData.Data;
                }
            }

            var resultStream = Api.TeamNetwork.DocumentService.GetZippedStreams(streamsToZip);
            return new UserCommandResult
            {
                Success = true,
                Commited = true,
                File = new UserCommandFileResult
                {
                    Content = resultStream,
                // Укажите имя архива
                    Name = "Data.zip"
                }
            };
        }
    }
    ```

6. Поместите на форму шаблона _«Заявки»_ **атрибут** _«Документы»_ и настройте его **представление** в виде **таблицы**.
7. Поместите в таблицу _«Документы»_ на форме **атрибуты** _«Наименование»_ и _«Вложение»_ шаблона записи _«Реестр документов»_.
8. В область кнопок таблицы _«Документы»_ поместите кнопки «**Создать**».
9. В область кнопок формы шаблона _«Заявки»_ поместите кнопку _«Скачать все вложения»_.

## Тестирование

1. Создайте новую запись шаблона _«Заявки»_ и добавьте несколько строк с документами в таблицу _«Документы»_.
2. Нажмите кнопку _«Скачать все вложения»_.
3. Браузер скачает архив со всеми файлами, которые связаны с записью шаблона _«Заявки»_.

    !!! note "Примечание"

        Если в браузере отобразится сообщение «**Незащищенное скачивание заблокировано**», нажмите кнопку «**Сохранить**», чтобы продолжить скачивание.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- _[Атрибут типа «Запись»][attribute_record]_
- _[Атрибут типа «Документ»][attribute_document]_
- _[Кнопки. Определение, настройка, удаление][buttons]_
- _[Написание скриптов на языке C#][manual_csharp]_
- _[Атрибут типа «Документ». Скачивание архива с файлами из таблицы и записи][download_document_archive_csharp]_

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}
