---
title: Автонумерация записей
tags:
    - C#
    - скрипт
    - C#-скрипт
    - скрипты
    - язык формул
    - формулы
    - язык выражений
    - выражения
kbId: 2607
---

# Автонумерация записей с помощью формулы или C#-скрипта {: #auto_numerating_records}

## Введение

Каждой записи, пользовательской задаче, форме и экземпляру процесса присваивается уникальный ID. В рамках сервера **{{ productName }}** ID не повторяются.

Чтобы автоматически нумеровать новые записи в шаблоне, создайте атрибут типа «**Текст**» и настройте его заполнение порядковыми номерами одним из способов:

* с помощью формулы;
* с помощью C#-скрипта.

Здесь даны примеры настройки автонумерации записей обоими способами.

!!! warning "Внимание!"

    * В представленных примерах автонумерация происходит при запуске процесса и создании связанной с ним записи.

    * Кроме того, автонумерацию с помощью C#-скрипта можно инициировать с помощью сценария по событию «**Создание записи**».

!!! note "Примечание"

    * Алгоритмы, представленные в примерах, не присваивают порядковые номера уже существующим записям в шаблоне.

    * Для нумерации имеющихся записей потребуется обработать их с помощью цикла в сценарии, например, с использованием C#-скрипта.

## Прикладная задача

Необходимо настроить нумерацию заявок, создаваемых в шаблоне *«Заявки»* при запуске процесса _«Оформление заявки»_, связанного с шаблоном записи *«Заявки»*.

Нумерация заявок будет отличаться от ID записей, которые им присваиваются автоматически: порядковые номера будут присваиваться только записям этого шаблона, а ID имеют сквозную нумерацию для всех шаблонов и приложений.

## Автонумерация с помощью формулы

Для шаблонов с небольшим количеством записей можно использовать автонумерацию с помощью формулы.

!!! warning "Внимание!"

    * Так как данный способ не учитывает возможность удаления записей, при удалении записей порядковые номера могут дублироваться.

    * Так как этот способ учитывает количество существующих записей, новой записи будет присвоен такой порядковый номер, как если бы все предыдущие записи были тоже пронумерованы.

1. В шаблоне записи *«Заявки»* создайте и поместите на форму атрибут _«Номер заявки»_ типа «**Текст**».
2. Откройте **сценарий на выходе** из начального события процесса _«Оформление заявки»_ и добавьте в него действие «**Изменить значения атрибутов**» со следующими свойствами:

    | Атрибут            | Операция со значениями | Значение|
    | ------------------ | ---------------------- | --------|
    | _Номер заявки_ | **Заменить**           | **Формула:** <p>```FORMAT("{0}",LIST(COUNT((from a in db->Zayavki select a->id))))```</p> |

    !!! question "Синтаксис формулы"

        * `FORMAT()` — эта функция принимает строку с заменителями вида `{0}`…`{N}` и список значений. Функция подставляет значения из списка в соответствующие заменители и возвращает результирующую строку.

        * `LIST()` — эта функция принимает перечень значений и возвращает список, состоящий из этих значений.
        
        * `COUNT()` — эта функция подсчитывает количество записей в шаблоне записи, возвращённых в запросом `from a in db`.

        * `from a in db->Zayavki select a->id` — запрос всех записей из шаблона _«Заявки»_. 
        
        * `Zayavki` — системное имя шаблона записи _«Заявки»_.

3. Опубликуйте диаграмму процесса.

### Тестирование

1. Создайте экземпляр процесса _«Оформление заявки»_.
2. При запуске процесса будет создана новая запись в шаблоне _«Заявки»_.
3. Новой заявке должен быть присвоен _Номер заявки_ на 1 больше количества существующих записей в шаблоне _«Заявки»_.

## Автонумерация с помощью C#-скрипта

Если в шаблоне будет много записей, то рекомендуется использовать автонумерацию с помощью C#-скрипта для повышения производительности.

Кроме того, при автонумерации с помощью C#-скрипта удаление записей не повлияет на присваиваемые порядковые номера.

1. На странице администрирования приложения выберите пункт «**Переменные**».
2. Создайте переменную со следующими свойствами:

    * **Название** — _Порядковый номер_;
    * **Тип** — **Число**;
    * **Значение** — _1_.

3. В шаблоне записи _«Заявки»_ создайте и поместите на форму **атрибут** _«Номер заявки»_ типа «**Число**».
4. В процессе, который связан с шаблоном записи _«Заявки»_, добавьте **задачу-выполнение сценария** сразу после начального события.
5. В свойствах задачи-выполнения сценария на вкладке «**Дополнительные**» добавьте следующий **C#-скрипт**:

    ```cs
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using Comindware.Data.Entity;
    using Comindware.TeamNetwork.Api.Data.UserCommands;
    using Comindware.TeamNetwork.Api.Data;
    public class Script
    {
        public static void Main(Comindware.Process.Api.Data.ScriptContext context, Comindware.Entities entities)
        {
    // BusinessObjectId — запись, связанная с экземпляром процесса.
                            var objectId = context.BusinessObjectId;  
    // Получаем значение переменной «Порядковый номер» по её ID — svar.1.
    // Присваиваем полученное значение переменной sequenceNumber.
                            var sequenceNumber = (decimal)Api.Solution.SolutionVariableService.GetValue("svar.1");
    // Nomerzayavki — системное имя атрибута «Номер заявки».
    // Создаём словарь data со значением атрибута «Номер заявки», 
    // равным значению переменной «Порядковый номер».
                            var data = new Dictionary<string, object>
               {
                     {"Nomerzayavki", sequenceNumber}
               };
    // Zayavki — системное имя шаблона записи «Заявки».
    // Записываем значение атрибута «Порядковый номер» в текущей Заявке
               Api.TeamNetwork.ObjectService.EditWithAlias("Zayavki", objectId, data);
    // Приращиваем на 1 значение переменной «Порядковый номер»
               Api.Solution.SolutionVariableService.SetValue("svar.1", sequenceNumber+1);
        }
    }
    ```

6. Опубликуйте диаграмму.

### Тестирование

1. Создайте экземпляр процесса.
2. В поле атрибута _«Номер заявки»_ должен отобразиться её порядковый номер.
3. В свойствах переменной _«Порядковый номер»_ значение должно увеличиться на 1.

--8<-- "related_topics_heading.md"

**[Список функций языка формул Comindware][formula_function_list]**

**[Переменные][variables]**

**[Написание скриптов на языке C#][manual_csharp]**

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}
