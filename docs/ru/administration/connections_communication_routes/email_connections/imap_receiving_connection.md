---
title: Получение эл. почты через IMAP
kbId: 2585
---

# Получение эл. почты через IMAP. Настройка подключения {: #imap_receiving_connection}

## Введение

Подключения типа «**Получение эл. почты через IMAP**» используются в [сценариях][scenarios]. В процессах используются подключения типа «[**Получение эл. почты в процессе**][process_receiving_connection]».

После настройки подключения необходимо настроить соответствующий путь передачи данных типа «**Получение эл. почты через IMAP**».

## Настройка подключения для получения эл. почты из сценария

!!! warning "Логика чтения писем на почтовом сервере"

    При подключении к почтовому серверу для получения эл. почты **{{ productName }}** выступает как почтовый клиент.

    При каждой проверке почтового ящика **{{ productName }}**:

    - обрабатывает новые письма;
    - отмечает новые письма как прочтённые.

    Поэтому для автоматической обработки входящих писем рекомендуется использовать отдельный адрес эл. почты.

    Если использовать ящик, на который поступают прочие письма, они тоже будут отмечены как прочитанные.

1. Откройте страницу «**Администрирование**» — «**Подключения**».
2. Откройте двойным нажатием или создайте подключение типа «**Подключения к электронной почте**» — «**Получение эл. почты через IMAP**» или «**Получение сообщений через Exchange**».
3. Настройте подключение к IMAP-серверу:

    - **Системное имя** — введите уникальное имя подключения. Рекомендуются буквы латинского алфавита, цифры и символ «_».
    - **Отключить** — установите этот флажок, если требуется временно деактивировать данное подключение.
    - **Описание** — введите наглядное описание подключения.
    - **Запись в файловые журналы** — выберите, какие события следует записывать в журналы:
        - **Полные сведения об обработке сообщения**;
        - **Только ошибки**;
        - **Отключить** — не регистрировать в журнале события получения писем.
    - **Для IMAP-сервера**
        - **Адрес почтового сервера** — введите адрес IMAP-сервера <u>без указания протокола (IMAP, HTTPS, HTTP)</u>.
        - **Порт** — введите номер порта IMAP-сервера.
        - **Шифрование** — выберите протокол шифрования, который поддерживает IMAP-сервер:
            - **Отсутствует** — не использовать шифрование;
            - **SSL**;
            - **TLS**.
    - **Для сервера Exchange**
        - **URL веб-сервера Exchange** — введите адрес почтового сервера <u>c указанием протокола (HTTPS, HTTP)</u>.
        - **Версия Exchange** — выберите версию сервера Exchange.
    - **Тип аутентификации** — выберите способ проверки подлинности, используемый сервером:
        - **Отсутствует**;
        - **Базовая**;
        - **Аутентификация Windows**.
    - **Имя пользователя** — укажите учётную запись для подключения к IMAP-серверу.
    - **Пароль** — введите пароль к учётной записи для подключения к IMAP-серверу.
    - **Домен** — укажите домен пользователя IMAP-сервера.
    - **Шифрование** — выберите протокол шифрования, который поддерживает IMAP-сервер:
        - **Отсутствует** — не использовать шифрование;
        - **SSL**;
        - **TLS**.
    - **Интервал опроса** — укажите интервал, с которым **{{ productName }}** будет проверять наличие новых писем.

4. Нажмите кнопку «**Проверить соединение**», чтобы проверить соединение с IMAP-сервером.
5. Нажмите кнопку «**Скачать журнал**», чтобы просмотреть журнал событий получения писем.
6. Сохраните подключение.

## Настройка пути передачи данных для получение эл. почты из сценария

1. На странице «**Администрирование**» — «**[Пути передачи данных][communication_routes]**» создайте или откройте путь передачи данных типа «**Получение эл. почты через IMAP**» или «**Получение сообщений через Exchange**».
2. Настройте свойства пути передачи данных.
3. Сохраните путь передачи данных.

### Основные свойства

- **Подключение** — выберите [подключение для получения эл. почты из сценариев через SMTP или Exchange](#настройка-подключения-для-получения-элпочты-из-сценария).
- **Системное имя** — введите уникальное имя пути передачи данных. Рекомендуются буквы латинского алфавита, цифры и символ «_».
- **Отключить** — установите этот флажок, если требуется временно деактивировать данный путь передачи данных.
- **Описание** — введите наглядное описание пути передачи данных, например _«Путь для получения писем»_.
- **Номер шины данных** — выберите номер от 0 до 3, если требуется распределить потоки данных нескольких путей для повышения производительности.

### Атрибуты сообщений

На вкладке «**Атрибуты сообщения**» заполните таблицу соответствия атрибутов сообщения с атрибутами электронного письма.

Значения атрибутов сообщения необходимо присвоить с помощью сценария.

Есть два **типа сообщения**:

- **Получение эл. почты**(для [IMAP](#атрибуты-сообщений-для-получения-элпочты-через-imap) и [Exchange](#атрибуты-сообщений-для-получения-элпочты-через-exchange));
- **Получение события календаря**(для [Exchange](#атрибуты-сообщений-для-получения-событий-календаря-через-exchange)).

Для каждого типа сообщения имеются готовые атрибуты, список которых хранится в таблице «**Запрос**». Также возможно задать собственные атрибуты сообщения для запроса, ответа и ответа с ошибкой.

#### Атрибуты сообщений для получения эл. почты через IMAP

В таблице «**Запрос**» имеются готовые атрибуты сообщения в виде массивов объектов для получения эл. почты через IMAP:

- **To** — получатели писем.
    - **Name** — имя получателя.
    - **Address** — адрес эл. почты.
- **From** — отправитель письма.
    - **Name** — имя получателя.
    - **Address** — адрес эл. почты.
- **Attachments** — прикреплённые файлы.
    - **Name** — название файла.
    - **Extension** — расширение файла.
    - **Content** — содержимое файла.
- **Cc** — копии.
    - **Name** — имя получателя.
    - **Address** — адрес эл. почты.
- **Bcc** — скрытые копии.
    - **Name** — имя получателя.
    - **Address** — адрес эл. почты.
- **Headers** — дополнительные заголовки.
    - **Name** — имя заголовка.
    - **Value** — значение заголовка.
- **Subject** — тема письма.
- **HtmlBody** — текст письма.

#### Атрибуты сообщений для получения эл. почты через Exchange

В таблице «**Запрос**» имеются готовые атрибуты сообщения в виде массивов объектов для получения эл. почты через Exchange:

- **To** — получатели писем.
    - **Name** — имя получателя.
    - **Address** — адрес эл. почты.
- **From** — отправитель письма.
    - **Name** — имя получателя.
    - **Address** — адрес эл. почты.
- **Attachments** — прикреплённые файлы.
    - **Name** — название файла.
    - **Extension** — расширение файла.
    - **Content** — содержимое файла.
- **Cc** — копии.
    - **Name** — имя получателя.
    - **Address** — адрес эл. почты.
- **Bcc** — скрытые копии.
    - **Name** — имя получателя.
    - **Address** — адрес эл. почты.
- **Headers** — дополнительные заголовки.
    - **Name** — имя заголовка.
    - **Value** — значение заголовка.
- **Subject** — тема письма.
- **RawBody** — текст письма.

#### Атрибуты сообщений для получения событий календаря через Exchange

В таблице «**Запрос**» имеются готовые атрибуты сообщения в виде массивов объектов для получения событий календаря через Exchange:

- **To** — получатели писем.
    - **Name** — имя получателя.
    - **Address** — адрес эл. почты.
- **From** — отправитель письма.
    - **Name** — имя получателя.
    - **Address** — адрес эл. почты.
- **Attachments** — прикреплённые файлы.
    - **Name** — название файла.
    - **Extension** — расширение файла.
    - **Content** — содержимое файла.
- **Subject** — тема письма.
- **RawBody** — текст письма.
- **Location** — место собрания.
- **Start** — время начала собрания.
- **End** — время завершения собрания.

Также для получения событий из календаря через Exchange имеются готовые атрибуты сообщения в таблице **«Ответ»**:

- **IsDeclined** — собрание отклонено.
- **IsTentative** — собрание под вопросом.
- **HasMessage** — ответ содержит сообщение.

## Настройка шаблона записи и сценария для отправки эл. почты

### Настройка шаблона записи

1. Создайте шаблон записи _«Реестр документов»_ со следующими атрибутами:

| Атрибут | Тип | Свойства |
|---|---|---|
| _Отправитель_ | **Текст** |  |
| _Вложения_ | **Документ** | **Хранить несколько значений:** флажок установлен |

2. Добавьте созданные атрибуты на форму.

### Настройка сценария

1. Создайте новый сценарий _«Получение документов по почте»_. Рекомендуется выбирать контекст выполнения «**От инициатора**».
2. Настройте начальное событие сценария:

    - **Тип: получение сообщения**;
    - **Контекстный шаблон:** _Реестр документов_;
    - **Подключение:** выберите [подключение для получения эл. почты из сценариев через IMAP или Exchange](#настройка-подключения-для-получения-элпочты-из-сценария);
    - **Путь передачи данных:** выберите [путь передачи данных эл. почты из сценариев через IMAP или Exchange](#настройка-пути-передачи-данных-для-отправки-эл-почты-из-сценария);
    - **Имя переменной:** _message_.

3. Добавьте действие «**Создать запись**» для целевого шаблона записи _«Реестр документов»_.
4. Внутри действия «**Создать запись**» добавьте действие «**Изменить значения атрибутов**».
5. Добавьте операцию «**Заменить**» для атрибута _«Отправитель»_ и укажите формулу:

    ```cs
    $$message->From->Name
    ```

6. Внутри действия «**Создать запись**» добавьте действие «**Повторять по количеству объектов**» со следующими свойствами:
    - **Переменная:** _attachment_
    - **Атрибут или выражение для поиска объектов: формула**

    ```cs
    $$message->Attachments
    ```

7. Внутри действия «**Повторять по количеству объектов**» добавьте действие «**Изменить значения атрибутов**».
8. Добавьте операцию «**Заменить**» для атрибута _«Вложения»_ и укажите выражение N3:

    ``` turtle
    # Импортируем функции для работы с документами и данными текущего сеанса
    @prefix session: <http://comindware.com/ontology/session#>.
    @prefix variable: <http://comindware.com/ontology/session/variable#>.
    @prefix document: <http://comindware.com/ontology/document#>.
    @prefix cmwstring: <http://comindware.com/logics/string#>.
    {
        # Помещаем переменную Attachment из действия «Повторять по количеству объектов»
        # в локальную переменную attachment.
        session:context variable:attachment ?attachment.
        # Помещаем содержимое файла в переменную contentValue.
        ?attachment variable:Content ?contentValue.
        # Помещаем расширение файла в переменную extension.
        ?attachment variable:Extension ?extension.
        # Помещаем имя файла в переменную filename.
        ?attachment variable:Name ?filename.
        # Соединяем имя файла и расширение в переменную filenameValue.
        (?filename ?extension) cmwstring:concatenation ?filenameValue.
        # Собираем новый файл из имени и содержимого, сохраняем его в папку Streams,
        # и возвращаем ID нового документа с прикреплённым файлом.
        (?contentValue ?filenameValue) document:attach ?value.
    }
    ```

## Тестирование

1. Создайте письмо с вложениями и отправьте его на эл. почту, указанную в подключении.
2. Подождите, пока письмо будет прочитано.
3. Перейдите к списку экземпляров шаблона «Реестр документов».
4. Откройте новую запись.
5. В поле «Отправитель» отобразится Ф. И. О. пользователя, с почты которого было отправлено письмо.
6. В поле «Вложения» отобразятся вложения, которые были прикреплены к отправленному письму.

--8<-- "related_topics_heading.md"

**[Получение эл. почты в процессе. Настройка подключения и пути передачи данных][process_receiving_connection]**

**[Отправка эл. почты из сценариев через SMTP и Exchange. Настройка подключения, пути передачи данных и сценария][scenario_send_email]**

**[Отправка эл. почты из процесса. Настройка подключения][process_sending_connection]**

**[Подключения. Типы, создание, настройка, удаление][connections]**

**[Пути передачи данных. Типы, создание, настройка, удаление][communication_routes]**

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}
