---
title: Отправка эл. почты через SMTP
kbId: 2584
---

# Отправка эл. почты через SMTP. Настройка подключения {: #smtp_sending_connection}

## Введение

В **{{ productName }}** можно настроить отправку эл. почты. В отличие от системных уведомлений о пользовательских задачах, письма, отправленные через SMTP, могут содержать произвольные бизнес-данные. Также можно настроить отправку обычных и скрытых копий, прикрепить к письму вложения.

Подключение «**Отправка эл. почты через SMTP**» подходит для отправки эл. почты с помощью [сценариев][scenarios]. В [процессах][process_diagram] используются подключения типа «**[Отправка эл. почты из процесса][process_sending_connection]**».

## Порядок настройки отправки эл. писем через SMTP

1. Настройте подключение типа «**Отправка почты через SMTP**».
2. Настройте путь передачи данных «**Отправка эл. почты через SMTP**».
3. Настройте шаблон и сценарий, в котором будет использоваться данное подключение и путь передачи данных.

## Настройка подключения «Отправка почты через SMTP»

1. Откройте страницу «**Администрирование**» – «**Подключения**».
2. Откройте двойным нажатием или создайте подключение типа «**Подключения к электронной почте**» – «**Отправка почты через SMTP**».
3. Настройте свойства подключения:

    - **Системное имя** — введите уникальное имя подключения. Рекомендуются буквы латинского алфавита, цифры и символ «_».
    - **Отключить** — установите этот флажок, если требуется временно деактивировать данное подключение.
    - **Описание** — введите наглядное описание подключения.
    - **Запись в файловые журналы** — выберите, какие события следует записывать в журналы:

        - **Полные сведения об обработке сообщения**;
        - **Только ошибки**;
        - **Отключить** — не регистрировать в журнале события отправки писем.

    - **Адрес почтового сервера** — введите URL для подключения к SMTP-серверу.

        !!! note "Примечание"

            Не указывайте протокол (`SMTP`, `HTTPS`, `HTTP`) в адресе почтового сервера.

    - **Порт** — введите номер порта SMTP-сервера.
    - **Тип аутентификации** — выберите способ проверки подлинности, используемый SMTP-сервером:

        - **Отсутствует**;
        - **Базовая**;
        - **Аутентификация Windows**.

    - **Имя пользователя** — укажите учетную запись для подключения к SMTP-серверу.
    - **Пароль** — введите пароль для подключения к SMTP-серверу.
    - **Домен** — укажите домен пользователя SMTP-сервера.
    - **Шифрование** — выберите протокол шифрования, который поддерживает SMTP-сервер:

        - **Отсутствует** — не использовать шифрование;
        - **SSL**;
        - **TLS**.

    - **Имя отправителя** — укажите имя, которое будет указано в отправляемых письмах.

        !!! note "Примечание"

            Если **адрес** или **имя отправителя** не совпадает с адресом и именем, указанным в учётной записи, используемой для подключения к почтовому серверу, сервер должен поддерживать замену данных отправителя. В противном случае, почта не будет отправляться.

    - **Адрес эл. почты отправителя** — укажите адрес эл. почты, который будет указан в отправляемых письмах. Почтовый сервер может проверять соответствие адреса отправителя и **имени пользователя**, отправляющего почту.
    - **Проверять соединение без отправки сообщения** — установите этот флажок, чтобы проверить соединение без указания получателей тестового письма.
    - **Адреса получателей для проверки работоспособности подключения** — укажите один или несколько (через запятую) адресов эл. почты для проверки соединения.

4. Нажмите кнопку «**Проверить соединение**».
5. Удостоверьтесь, что получателям пришло тестовое письмо от настроенного отправителя.
6. Нажмите кнопку «**Скачать журнал**», чтобы просмотреть журнал событий отправки писем.
7. Сохраните подключение.

_![Настройка свойств подключения для отправки эл. почты через SMTP](smtp_sending_connection_settings.png)_

## Настройка пути передачи данных «Отправка эл. почты через SMTP»

1. Откройте страницу «**Администрирование**» – «**Пути передачи данных**».
2. Откройте двойным нажатием или создайте подключение типа «**Подключения к электронной почте**» – «**Отправка эл. почты через SMTP**».
3. Настройте свойства пути передачи данных.
4. Сохраните путь передачи данных.

### Основные свойства

На вкладке «**Основные свойства**» настройте параметры использования пути передачи данных.

- **Подключение** — выберите подключение для отправки почты через SMTP.
- **Системное имя** — введите уникальное имя пути передачи данных. Рекомендуются буквы латинского алфавита, цифры и символ «_».
- **Отключить** — установите этот флажок, если требуется временно деактивировать данный путь передачи данных.
- **Описание** — введите наглядное описание пути передачи данных.
- **Номер шины данных** — выберите номер от 0 до 3.

### Атрибуты сообщения

На вкладке «**Атрибуты сообщения**» настройте атрибуты, которые будут использоваться для передачи данных в эл. письмо. В таблице «Запрос» представлены готовые атрибуты в виде объектов:

- **To** — получатель или получатели эл. писем.

    - **Address** — адрес эл. почты
    - **Name** — имя получателя

- **Attachments** — прикреплённый файл

    - **Content** — содержимое файла
    - **Extension** — расширение файла
    - **Name** — название файла

- **Cc** — копия

    - **Address** — адрес эл. почты
    - **Name** — имя получателя

- **Bcc** — скрытая копия

    - **Address** — адрес эл. почты
    - **Name** — имя получателя

- **CustomHeaders** — дополнительный заголовок

    - **ListValues**
    - **Value** — значение заголовка
    - **Name** — имя заголовка

Также можно добавить свои собственные атрибуты, например:

- _FullName_ типа «**Строка**» для Ф.И.О. получателя
- _FileName_ типа «**Строка**» для имени прикрепляемого документа

### Интеграция

На вкладке «**Интеграции**» можно настроить дополнительные свойства эл. письма, заполнив их статистическими значениями или атрибутами сообщения.

!!! tip "Совет"

    - Чтобы поместить значение атрибута сообщения в эл. письмо, введите его системное имя в фигурных скобках `{ }` в соответствующее поле письма.
    - В текстовые поля письма (адреса и имена отправителей и получателей, тема, текст сообщения, место встречи) можно вводить произвольный текст и несколько **атрибутов сообщений**.
    - Например, в поле «**Тема**» можно ввести строку:
        
        ```
        Уведомление «{Title}» от {Date} 
        ```
        
        Здесь: `{Title}` — атрибут сообщения, содержащий название уведомления, а `{Date}` — дата формирования уведомления.

    !!! warning "Внимание!"

        Чтобы использовать свои собственные атрибуты сообщения, их следует обязательно добавить в таблицу «**Запрос**» на вкладке «**Атрибуты сообщения**». В ином случае путь передачи данных будет автоматически отключён.

- Шаблон темы — настройте стандартный заголовок письма, например:

```cs
Документ {FileName} к рассмотрению.
```

- Шаблон текста сообщения — настройте стандартный текст письма, например:

```cs
Здравствуйте, {FullName}!

Рассмотрите документ {FileName}.
```

- Дополнительные заголовки
- Получатели
- Копия
- Прикреплённые файлы
- Скрытая копия

## Настройка шаблона записи и сценария для отправки эл. почты

### Настройка шаблона записи

1. Создайте шаблон записи _«Эл. письма»_.
2. Создайте следующие атрибуты:

    - _Получатель_ типа «**Аккаунт**»;
    - _Вложение_ типа «**Документ**».

1. Создайте кнопку _«Отправить письмо»_ со следующими свойствами:

    - **Контекст операции: запись**
    - **Операция: вызвать событие «Нажата кнопка»**
    - **Результат выполнения: обновить данные**

2. Добавьте атрибуты _«Получатель»_ и _«Вложение»_ на форму.
3. Добавьте кнопку _«Отправить письмо»_ на форму.

### Настройка сценария

!!! note "Событие для отправки почты"

    Сценарий для отправки почты можно запускать по любому событию:

    - нажатие кнопки;
    - создание записи;
    - изменение записи;
    - запуск процесса;
    - получение сообщения;
    - вход токена в элемент диаграммы;
    - выход токена из элемента диаграммы.

1. Создайте сценарий _«Отправка писем»_.
2. В свойствах события «**Нажатие кнопки**» выберите **контекстный шаблон** _«Эл. письма»_ и **кнопку** _«Отправить письмо»_.
3. Создайте действие «**Изменить значения переменных**»:

    - **Операция со значениями переменных: заменить**
    - **Набор переменных:** _mail_
    - **Переменные:**

        - _To_

            - переменная _Address_, вложенная в _To_, со значением **формулы**: `$Poluchatel->mbox`

        - _FullName_ со значением **формулы**: `$Poluchatel->fullName`
        - _FileName_ со значением со значением **N3**:

        ```turtle
        # Импортируем функции для работы с записями и документами
        @prefix object: <http://comindware.com/ontology/object#>.
        @prefix document: <http://comindware.com/ontology/document#>.

        {
            # Находим атрибут Vlozhenie  (Вложение) в шаблоне Elpisma (Эл. письма).
            ("Elpisma" "Vlozhenie") object:findProperty ?VlozhenieAttribute.
            # Присваиваем переменной ?Vlozhenie объект из атрибута «Вложение».
            ?item ?VlozhenieAttribute ?Vlozhenie.
            # В переменную ?currentDocument помещаем последнюю добавленную версию документа.
            ?Vlozhenie document:currentRevision ?currentDocument.
            # Помещаем в переменную value название текущего документа.
            ?currentDocument document:name ?value.
        }
        ```

        - _Attachments_

            - переменная _Name_, вложенная в _Attachments_, со значением **N3**:
            
            ```turtle
            # Импортируем функции для работы с записями и документами
            @prefix object: <http://comindware.com/ontology/object#>.
            @prefix document: <http://comindware.com/ontology/document#>.

            {
                # Находим атрибут Vlozhenie  (Вложение) в шаблоне Elpisma (Эл. письма).
                ("Elpisma" "Vlozhenie") object:findProperty ?VlozhenieAttribute.
                # Присваиваем переменной ?Vlozhenie объект из атрибута «Вложение».
                ?item ?VlozhenieAttribute ?Vlozhenie.
                # В переменную ?currentDocument помещаем последнюю добавленную версию документа.
                ?Vlozhenie document:currentRevision ?currentDocument.
                # Помещаем в переменную value название текущего документа.
                ?currentDocument document:name ?value.
            }
            ```

            - переменная _Extension_, вложенная в _Attachments_, со значением **N3**:

            ```turtle
            # Импортируем функции для работы с записями и документами
            @prefix object: <http://comindware.com/ontology/object#>.
            @prefix document: <http://comindware.com/ontology/document#>.

            {
                # Находим атрибут Vlozhenie  (Вложение) в шаблоне Elpisma (Эл. письма).
                ("Elpisma" "Vlozhenie") object:findProperty ?VlozhenieAttribute.
                # Присваиваем переменной ?Vlozhenie объект из атрибута «Вложение».
                ?item ?VlozhenieAttribute ?Vlozhenie.
                # В переменную ?currentDocument помещаем последнюю добавленную версию документа.
                ?Vlozhenie document:currentRevision ?currentDocument.
                # Помещаем в переменную value расширение текущего документа.
                ?currentDocument document:revisionExtension ?value.
            }
            ```

            - переменная _Extension_, вложенная в _Attachments_, со значением **N3**:

            ```turtle
            # Импортируем функции для работы с записями и документами
            @prefix object: <http://comindware.com/ontology/object#>.
            @prefix document: <http://comindware.com/ontology/document#>.

            {
                # Находим атрибут Vlozhenie  (Вложение) в шаблоне Elpisma (Эл. письма).
                ("Elpisma" "Vlozhenie") object:findProperty ?VlozhenieAttribute.
                # Присваиваем переменной ?Vlozhenie объект из атрибута «Вложение».
                ?item ?VlozhenieAttribute ?Vlozhenie.
                # В переменную ?currentDocument помещаем последнюю добавленную версию документа.
                ?Vlozhenie document:currentRevision ?currentDocument.
                # Помещаем в переменную value содержимое текущего документа.
                ?content document:content ?value.
            }
            ```

    !!! warning "Вложенные переменные"

        Если переменная заменяет атрибут сообщения, который является частью объекта, то следует повторить структуру этого объекта:

        - Создайте переменную с таким же названием, как у объекта, например _To_.
        - Выберите её в списке и нажмите кнопку «**Создать**».
        - Дважды щёлкните <i class="fa-light fa-angle-down anchor"></i> рядом с переменной _To_.
        - Отобразится строка таблицы для вложенной переменной.

4. Добавьте действие «**Отправить сообщение**» со следующими свойствами:

    - **Подключение:** укажите подключение типа «**Отправка почты через SMTP**»
    - **Путь передачи данных:** укажите путь передачи данных типа «**Отправка эл. почты через SMTP**».
    - **Переменная с сообщением:** _mail_

## Тестирование

1. Создайте запись в шаблоне _«Эл. письма»_.
2. Выберите аккаунт, на эл. почту которого требуется отправить письмо.
3. Заполните поле _«Вложение»_.
4. Сохраните запись.
5. Нажмите кнопку _«Отправить письмо»_.
6. На эл. почту, выбранного аккаунта, придёт письмо с прикреплённым вложением.

--8<-- "related_topics_heading.md"

**[Получение эл. почты через Exchange. Настройка подключения][exchange_receiving_connection]**

**[Получение эл. почты через IMAP. Настройка подключения][imap_receiving_connection]**

**[Отправка эл. почты через Exchange. Настройка подключения][exchange_sending_connection]**

**[Отправка эл. почты из процесса. Настройка подключения][process_sending_connection]**

**[Подключения. Типы, создание, настройка, удаление][connections]**

**[Пути передачи данных. Типы, создание, настройка, удаление][communication_routes]**

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}
