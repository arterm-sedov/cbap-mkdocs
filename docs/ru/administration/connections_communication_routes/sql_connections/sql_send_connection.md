---
title: Внешняя СУБД (MySQL, MSSQL, Oracle, Postgres). Отправка SQL-запроса SELECT
kbId: 2498
---

# Внешняя СУБД (MySQL, MSSQL, Oracle, Postgres). Отправка SQL-запроса SELECT. Настройка подключения, пути передачи данных и сценария {: #sql_send_connection}

## Введение

В настоящей статье представлены инструкции по настройке подключения, пути передачи данных и сценария для отправки SQL-запросов во внешнюю систему управления базами данных (СУБД) с целью получения данных из внешней базы данных (БД) в приложение на основе **{{ productName }}** (далее «Приложение»).

Пример в статье приведён для СУБД MySQL. Настройка приложения для СУБД MSSQL, Oracle и PostgreSQL осуществляется аналогичным образом.

См. также статью _«[Внешняя СУБД (MySQL, MSSQL, Oracle, PostgreSQL). Получение данных по таймеру. Настройка подключения, пути передачи данных и сценария](sql_receive_connection.md)»._

## Прикладная задача

Посредством запроса `SELECT` к внешней СУБД необходимо получать из таблицы `cities` названия городов, находящихся в стране, по трехбуквенному коду страны в формате ISO 3166-1.

### Исходные данные

Внешняя БД содержит таблицу `cities` со следующими столбцами:

- `countryCode` типа `CHAR(3)` — трехбуквенный код страны, в которой находится город;
- `cityName` типа `TINYTEXT` — название города.

В приложении имеется шаблон записи «_Страны_» с атрибутами:

- _Код страны_ (системное имя _CountryCode_) типа «**Текст**».
- _Города страны_ (системное имя _Cities_) типа «**Запись**»:
    - **Связанный шаблон**: _Города_ 
    - **Хранить несколько значений**: флажок установлен

В приложении имеется шаблон записи «_Города_» с атрибутом:

- _Название города_ (системное имя _cityName_) типа «**Текст**»:  
    - **Использовать как заголовок записей**: флажок установлен

В шаблоне записи «_Страны_» на основную форму вынесены следующие атрибуты:

- _Код страны_ — текстовое поле_;_
- _Города страны_ — таблица со столбцом _«Название города»._

## Подготовка сервера СУБД

Перед подключением из **{{ productName }}** необходимо подготовить конфигурацию сервера СУБД, как указано ниже.

### Настройка конфигурации сервера PostgreSQL

1. Откройте для редактирования файл `postgresql.conf`.  
    В ОС Linux путь к этому файлу можно узнать с помощью следующей команды:  

    ```
    sudo -u postgres psql -c 'SHOW config_file'
    ```

    В ОС Windows он располагается в папке `C:\ProgramData\PostgreSQL\X.X\data\postgresql.conf`, где `X.X` — номер версии PostgreSQL.
2. В файле `postgresql.conf` добавьте следующие директивы:  
    - Разрешите подключение со всех IP адресов:

    ```
    listen_addresses = '*'
    ```

    - Задайте локаль для вывода сообщений об ошибках:

        ```
        lc_messages = 'en_EN.utf-8'
        ```

3. Откройте для редактирования конфигурационный файл `pg_hba.conf` (в той же директории, что файло `postgresql.conf`).
4. В файле `pg_hba.conf` разрешите подключение с адреса сервера **{{ productName }}** (например, `123.45.67.89`):

    ```
    host    all    all    123.45.67.89    md5
    ```

5. Перезапустите службу `postgresql`:  
    **Linux**

    ```
    sudo systemctl restart postgresql
    ```

    **Windows**

    ```
    net stop postgresql-x64-<номер_версии>
    ```

## Создание подключения к СУБД

1. Откройте страницу «**Администрирование**» — «**Подключения**».
2. Создайте **SQL-подключение** типа «**Отправки запросов в СУБД**».

    _![Меню создания подключения для отправки запросов в СУБД](sql_send_connection_menu.png)_

3. В поле «**Системное имя**» введите уникальное имя подключения.
4. В поле «**Описание**» введите наглядное описание назначения подключения.
5. В поле «**Запись в файловые журналы**» укажите, какие события при обмене данными с сервером СУБД следует регистрировать в журнале.
6. В поле «**Строка подключения**» введите адрес сервера, имя базы данных, имя пользователя и пароль для подключения к СУБД:  
    **MySQL**

    ```
    Server=ServerAddress;Database=DataBaseName;Uid=Username;Pwd=Password;
    ```

    **MSSQL**

    ```
    Server=ServerAddress;Database=DataBaseName;User Id=Username;Pwd=Password;
    ```

    **Oracle**
    
    ```
    Data Source=DataBaseName;User Id=Username;Password=Password;Integrated Security=no;
    ```

    **PostgreSQL**  

    ```
    Host=ServerAddress;Database=DataBaseName;User ID=Username;Password=Password;
    ```

7. В поле «**Система управления базами данных**» выберите тип СУБД:
    - **MySQL**
    - **MSSQL**
    - **Oracle**
    - **PostgreSQL**
8. Нажмите кнопку «**Создать**».

    _![Создание нового подключения для отправки запросов в СУБД](sql_send_connection_create.png)_

9. В списке подключений дважды нажмите строку созданного подключения.  

    _![Переход к свойствам подключения](sql_send_connection_properties_transfer.png)_

10. В окне свойств подключения нажмите кнопку «**Проверить соединение**».
11. Если проверка соединения не выдала ошибок, нажмите кнопку «**Сохранить**».

    _![Проверка соединения с сервером СУБД](sql_send_connection_check.png)_

    _![Сообщение об успешной проверке соединения](sql_send_connection_check_passed.png)_

## Создание пути для обмена данными с СУБД

1. Со страницы «**Администрирование**» приложения перейдите в раздел «**Пути передачи данных**».
2. Создайте **путь передачи данных** типа «**Отправка запросов в СУБД**».

    _![Меню создания пути передачи данных для отправки запросов в СУБД](sql_send_connection_menu_paths.png)_

3. В поле «**Подключение**» выберите ранее созданное подключение для отправки запросов в MySQL.
4. В поле «**Системное имя**» введите уникальное имя пути передачи данных.
5. В поле «**Описание**» введите наглядное описание пути передачи данных.  

    _![Создание нового пути для отправки запросов в СУБД](sql_send_connection_new_path.png)_

6. Откройте вкладку «**Атрибуты сообщений**».
7. В поле «**Тип сообщения**» выберите пункт «**Выполнить запрос SELECT**».
8. В таблице «**Запрос**» оставьте созданные автоматически атрибуты, они будут использоваться в сценарии для формирования SQL-запроса.
{: #step8}
9.  В области «**Ответ**» нажмите кнопку «**Добавить**», чтобы создать:  
    - атрибут `Cities` типа «**Объект**» с установленным флажком «**Массив**» — этот атрибут будет содержать массив названий городов, полученных из внешней БД (системное имя этого атрибута может быть любым);
10. В таблице атрибутов установите флажок у атрибута `Cities` и нажмите кнопку «**Добавить**», чтобы создать:
    - вложенный атрибут `cityName` типа «**Строка**» — этот атрибут будет содержать название города, и его системное имя должно совпадать с именем столбца с названиями городов в таблице полученной из внешней БД.
    - вложенный атрибут `countryCode` типа «**Строка**» — этот атрибут будет содержать код страны, и его системное имя должно совпадать с именем столбца с кодами стран в таблице полученной из внешней БД.  

        _![Настройка атрибутов для отправки SQL-запроса SELECT и получения ответа от MySQL](sql_send_connection_attributes_settings.png)_

11. Откройте вкладку «**Интеграция**».
12. В поле «**Таблица**» укажите имя таблицы в базе данных, из которой требуется получать данные, например `cities`.
13. В поле «**Атрибут для хранения полученных записей**» укажите системное имя атрибута `Cities`, созданного на вкладке «**[Атрибуты сообщений](#step8)**».
14. Поле «**SQL-запрос**» оставьте пустым. Если его заполнить, то будет проигнорирован запрос, сформированный с помощью сценария и атрибутов на вкладке «[**Атрибуты сообщений**](#создание-сценария-для-отправки-sql-запроса-и-получения-данных-из-субд)».
15. Нажмите кнопку «**Создать**».  

    _![Настройка параметров интеграции для отправки запроса в MySQL](sql_send_connection_parametres_settings.png)_

## Создание кнопки для отправки SQL-запроса в СУБД

1. Откройте вкладку «**Кнопки**» шаблона записи «_Страны_».
2. Создайте кнопку «_Получить города из MySQL_» со следующими свойствами:
    - Контекст операции — Запись;
    - Операция — Вызвать событие «Нажата кнопка»;
    - Результат выполнения — Обновить данные.

        _![Настройка кнопки «Получить города из MySQL»](sql_send_connection_receive_cities.png)_

3. Добавьте кнопку «_Получить города из MySQL_» на основную форму шаблона «_Страны_».

    _![Добавление кнопки «Получить города из MySQL» на основную форму шаблона «Страны»](sql_send_connection_country_button.png)_

## Создание сценария для отправки SQL-запроса и получения данных из СУБД

1. Со страницы «**Администрирование**» приложения перейдите в раздел «**Сценарии**».
2. Создайте новый сценарий, нажав кнопку «**Создать**».
3. Настройте свойства сценария:
    - **Название** — введите наглядное название сценария.
    - **Системное имя** — введите уникальное имя сценария.
    - **Контекст выполнения** — выберите пункт «**От имени системы**».
4. Нажмите кнопку «**Сохранить**».  

    _![Создание нового сценария](sql_send_connection_scenario_create.png)_

5. Откройте конструктор сценария, дважды нажав строку созданного сценария в списке сценариев.  

    ![Переход к конструктору сценария](sql_send_connection_scenario_transfer.png)

6. В отобразившемся конструкторе сценария нажмите кнопку изменить на блоке «**Нажатие кнопки**».  

    _![Переход к свойствам блока сценария](sql_send_connection_scenario_properties_transfer.png)_

7. Настройте свойства события:  
    - **Контекстный шаблон** — выберите шаблон записи _«Страны»_;
    - **Кнопка** — выберите ранее созданную кнопку _«Получить города из MySQL»_.
8. Нажмите кнопку «**Сохранить**».  

    _![Настройка события получения сообщения из MySQL в сценарии](sql_send_connection_scenario_receive_cities.png)_

9. Нажмите кнопку «**Добавить действие**» под блоком «**Нажата кнопка**».  

    _![Добавление действия «Изменить значение переменных» в сценарий](sql_send_connection_scenario_change.png)_

10. Добавьте действие «**Изменить значения переменных**» и настройте его свойства:
    - **Операция со значениями переменных** — выберите ранее созданное подключение для отправки запросов в СУБД.
    - **Набор переменных** — укажите наглядное имя, оно будет использоваться в последующих действиях сценария.
    - Нажмите кнопку «**Создать**» над таблицей переменных и добавьте две переменных:
        - **FilterAttributes** — в поле «**Значение**» введите имя столбца `countryCode` из таблицы `cities` во внешней БД.
        - **FilterValues** — в поле «**Значение**» выберите **атрибут** « _Код страны_».
        - Из этих переменных в последующем действии «**Отправить сообщение**» в SQL-запросе будет сформировано предложение `WHERE FilterAttributes = FilterValues`.
    - Нажмите кнопку «**Сохранить**».  

        _![ Настройка свойств действия «Изменить значения переменных»](sql_send_connection_scenario_change_settings.png)_

11. После действия «**Изменить значения переменных**» добавьте действие «**Отправить сообщение**» и настройте его свойства:
{: #step11}
    - **Подключение** — выберите ранее созданное подключение для отправки запросов в СУБД.
    - **Путь передачи данных** — выберите ранее созданный путь передачи данных для отправки запросов в СУБД.
    - **Переменная с сообщением** — введите наглядное имя **набора переменных** `SqlRequestBody`, заданное в предшествующем действии «**Изменить значения переменных**».
    - **Переменная для успешного ответа** — введите наглядное имя переменной для хранения записей, полученных из внешней БД, например, SqlResponse .
    - введите имя переменной для хранения ответа сервера об успешной операции.
    - **Переменная для ответа с ошибкой** — введите имя переменной для хранения ответа сервера об операции, которую не удалось выполнить.
    - Нажмите кнопку «**Сохранить**».

        _![Настройка свойств действия «Отправить сообщение»](sql_send_connection_send_message_settings.png)_

12. За действием «**Отправить сообщение**» добавьте действие «**Повторять по количеству объектов**» и настройте его свойства:

    - В поле «**Переменная**» введите наглядное имя переменной для итераций в цикле, например `currentRecord`;
    - В поле «**Атрибут или выражение для поиска объектов**» введите следующее выражение:
        - **Формула**

            ```
            $$SqlResponse->City
            ```

        - **N3**

            ```
            @prefix session: <http://comindware.com/ontology/session#>. 
            @prefix var: <http://comindware.com/ontology/session/variable#>. 
            { 
                session:context var:SqlResponse ?message. 
                ?message var:City ?value. 
            }
            ```

        - Здесь:
            - `SqlResponse` — имя **переменной для успешного ответа**, указанное в свойствах свойствах события «**[Отправить сообщение](#создание-кнопки-для-отправки-sql-запроса-в-субд)**».
            - `City` — системное имя атрибута-массива, созданного [на вкладке «**Атрибуты сообщений**»](#step8) в свойствах пути передачи данных.
    - Нажмите кнопку «**Сохранить**».

    _![Настройка цикла по объектам в сценарии](sql_send_connection_scenario_cycle_settings.png)_

13. Добавьте в действие «**Цикл по объектам**» вложенное действие «**Создать запись**» и настройте его свойства:
{: #step13}
    - В поле «**Целевой шаблон записи**» выберите шаблон «_Города_», в котором будут создаваться записи с данными, полученными из внешней БД.  

        _![Настройка действия «Создать запись» в сценарии](sql_send_connection_create_record_settings.png)_

14. Добавьте в действие «**Создание записи**» вложенное действие «**Изменить значения атрибутов**» и настройте его:
    - Нажмите кнопку «**Создать**».
    - В столбце «**Атрибут**» выберите атрибут шаблона, указанного [в свойствах действия «**Создать запись**»](#step13), в который будут помещаться названия городов, полученные из внешней БД.
    - В столбце «**Операция со значениями**» выберите пункт «**Заменить**».
    - В Столбце «**Значение**» введите следующее выражение:
        - **Формула**

            ```
            $$currentRecord->cityName
            ```

        - **N3**

            ```
            @prefix session: <http://comindware.com/ontology/session#>. 
            @prefix var: <http://comindware.com/ontology/session/variable#>. 
            { 
                session:context var:currentRecord ?record. 
                ?record var:cityName ?value. 
            }
            ```

        - Здесь:
            - `currentRecord` — имя переменной, заданное [в свойствах цикла по объектам](#step11).
            - `_**cityName**_` — системное имя строкового атрибута (в массиве `City`), созданного [на вкладке «**Атрибуты сообщений**»](#step8) в свойствах пути передачи данных.  

                _![Настройка действия «Изменить значения атрибутов» в сценарии](sql_send_connection_change_attributes_settings.png)_

15. Нажмите кнопку «**Сохранить**».
16. Должен получиться показанный на следующей иллюстрации сценарий.  

    _![Сценарий для сохранения данных из внешней БД в шаблон записи](sql_send_connection_scenario.png)_

## Тестирование сценария

1. Создайте запись в шаблоне _«Страны»_ и заполните поле _«Код страны»._
2. Нажмите кнопку «_Получить города из MySQL_».
3. [Настроенный для кнопки сценарий](#создание-сценария-для-отправки-sql-запроса-и-получения-данных-из-субд) должен создать в шаблоне записи «_Города_» записи с названиями городов, полученных из внешней БД по указанному коду страны.

--8<-- "related_topics_heading.md"

**[Внешняя СУБД (MySQL, MSSQL, Oracle, PostgreSQL). Получение данных по таймеру. Настройка подключения, пути передачи данных и сценария][sql_receive_connection]**

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}
