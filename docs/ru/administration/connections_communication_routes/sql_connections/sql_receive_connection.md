---
kbId: 2135
---

# Внешняя СУБД (MySQL, MSSQL, Oracle, PostgreSQL). Получение данных по таймеру. Настройка подключения, пути передачи данных и сценария {: #sql_receive_connection}

## Введение

В настоящей статье представлены инструкции по настройке подключения, пути передачи данных и сценария для отправки SQL-запросов во внешнюю систему управления базами данных (СУБД) по таймеру и получения в приложении на основе **{{ productName }}** (далее «Приложение»).

Пример в статье приведён для СУБД MySQL. Настройка приложения для СУБД MSSQL, Oracle и PostgreSQL осуществляется аналогичным образом.

См. также статью _«[Внешняя СУБД (MySQL, MSSQL, Oracle, Postgres). Отправка SQL-запроса SELECT. Настройка подключения, пути передачи данных и сценария][sql_send_connection]»._

## Прикладная задача

При наступлении заданного таймера **{{ productName }}** должна отправлять запрос `SELECT` во внешнюю СУБД и помещать полученные из таблицы `cities` записи с названиями городов в шаблон записи «_Города_ » в приложении.

### Исходные данные

Внешняя БД содержит таблицу `cities` с одним столбцом:

- `Name` типа `TINYTEXT` — название города.

В приложении имеется шаблон записи «_Города_» с атрибутом:

- _Город_ типа «**Текст**»:  
    - **Использовать как заголовок записей**: флажок установлен

## Подготовка сервера СУБД

Перед подключением из **{{ productName }}** необходимо подготовить конфигурацию сервера СУБД, как указано ниже.

### Настройка конфигурации сервера PostgreSQL

1. Откройте для редактирования файл `postgresql.conf`.  
    В ОС Linux путь к этому файлу можно узнать с помощью следующей команды:  

    ```
    sudo -u postgres psql -c 'SHOW config_file'
    ```

    В ОС Windows он располагается в папке `C:\ProgramData\PostgreSQL\X.X\data\postgresql.conf`, где `X.X` — номер версии PostgreSQL.
2. В файле `postgresql.conf` добавьте следующие директивы:  
    - Разрешите подключение со всех IP адресов:

    ```
    listen_addresses = '*'
    ```

    - Задайте локаль для вывода сообщений об ошибках:

        ```
        lc_messages = 'en_EN.utf-8'
        ```

3. Откройте для редактирования конфигурационный файл `pg_hba.conf` (в той же директории, что файло `postgresql.conf`).
4. В файле `pg_hba.conf` разрешите подключение с адреса сервера **{{ productName }}** (например, `123.45.67.89`):

    ```
    host    all    all    123.45.67.89    md5
    ```

5. Перезапустите службу `postgresql`:  
    **Linux**

    ```
    sudo systemctl restart postgresql
    ```

    **Windows**

    ```
    net stop postgresql-x64-<номер_версии>
    net start postgresql-x64-<номер_версии>
    ```

## Создание подключения к СУБД

1. Откройте страницу «**Администрирование**» – «**Подключения**».
2. Создайте **SQL-подключение** типа «**Получение данных из СУБД**».

    _![Меню создания подключения для получения данных из СУБД](sql_receive_connection_menu.png)_

3. В поле «**Системное имя**» введите уникальное имя подключения.
4. В поле «**Описание**» введите наглядное описание назначения подключения.
5. В поле «**Строка подключения**» введите адрес сервера, имя базы данных, имя пользователя и пароль для подключения к СУБД:  
    **MySQL**

    ```
    Server=ServerAddress;Database=DataBaseName;Uid=Username;Pwd=Password;
    ```

    **MSSQL**

    ```
    Server=ServerAddress;Database=DataBaseName;User Id=Username;Pwd=Password;
    ```

    **Oracle**

    ```
    Data Source=DataBaseName;User Id=Username;Password=Password;Integrated Security=no;
    ```

    **PostgreSQL**  

    ```
    Host=ServerAddress;Database=DataBaseName;User ID=Username;Password=Password;
    ```

6. В поле «**Интервал опроса**» укажите периодичность автоматической отправки SQL-запросов в СУБД для получения из неё данных. Интервал опроса необходимо указать, чтобы настроить сценарий на срабатывание по событию «**Получение сообщения**».
7. В поле «**Система управления базами данных**» выберите тип СУБД:
    - **MySQL**
    - **MSSQL**
    - **Oracle**
    - **PostgreSQL**
8. Нажмите кнопку «**Проверить соединение**».
9. Если проверка соединения не выдала ошибок, нажмите кнопку «**Создать**».

    _![Создание и  проверка нового подключения для получения данных из СУБД](sql_receive_connection_create.png)_

    _![Сообщение об успешной проверке соединения](sql_receive_connection_check.png)_

## Создание пути получения данных из СУБД

1. Со страницы «**Администрирование**» приложения перейдите в раздел «**Пути передачи данных**».
2. Создайте **путь передачи данных** типа «**Получение данных из СУБД**».

    _![Меню создания пути передачи данных СУБД](sql_receive_connection_menu_creation.png)_

3. В поле «**Подключение**» выберите ранее созданное подключение к СУБД.
4. В поле «**Системное имя**» введите уникальное имя пути передачи данных.
5. В поле «**Описание**» введите наглядное описание пути передачи данных.

    _![Создание нового пути для получения данных из СУБД](sql_receive_connection_new_path.png)_

6. Откройте вкладку «**Атрибуты сообщений**».
7. В поле «**Тип сообщения**» выберите пункт «**Выполнить запрос SELECT**».
8. В области «**Запрос**» нажмите кнопку «**Добавить**», чтобы создать:
{: #step8}
    - атрибут `City` типа «**Объект**» с установленным флажком «**Массив**» — этот атрибут будет содержать массив названий городов, полученных из внешней БД (системное имя этого атрибута может быть любым).
9. В таблице атрибутов установите флажок у атрибута `City` и нажмите кнопку «**Добавить**», чтобы создать:
    - вложенный атрибут `Name` типа «**Строка**» — этот атрибут будет содержать название города, и его системное имя должно совпадать с именем столбца с названиями городов в таблице, полученной из внешней БД.  

        _![Настройка атрибутов сообщений для пути передачи данных](sql_receive_connection_attributes_settings.png)_

10. Откройте вкладку «**Интеграция**».
11. В поле «**Атрибут для хранения полученных записей**» укажите системное имя  атрибута `City`, созданного на вкладке «**[Атрибуты сообщений](#step8)**».
12. В поле «**SQL-запрос**» введите запрос для получения записей с названиями городов из внешней БД, указав имя таблицы с названиями городов, которые будут помещены в атрибут `Name`, созданный на [шаге 8](#step8). Например:

    ```
    SELECT * FROM cities
    ```

13. Нажмите кнопку «**Создать**», чтобы сохранить настроенный путь передачи данных из СУБД.  

    _![Настройка параметров интеграции пути получения данных из СУБД](sql_receive_connection_parametres_settings.png)_

## Создание сценария для получения данных из СУБД

1. Со страницы «**Администрирование**» приложения перейдите в раздел «**Сценарии**».
2. Создайте новый сценарий, нажав кнопку «**Создать**».
3. В поле «**Название**» введите наглядное название сценария.
4. В поле «**Системное имя**» введите уникальное имя сценария.
5. В поле «**Контекст выполнения**» выберите пункт «**От имени системы**».
6. Нажмите кнопку «**Сохранить**».  

    _![Создание нового сценария](sql_receive_connection_new_scenario.png)_

7. Откройте конструктор сценария, дважды нажав строку созданного сценария в списке сценариев.  

    _![Переход к конструктору сценария](sql_receive_connection_scenario_transfer.png)_

8. В отобразившемся конструкторе сценария нажмите кнопку изменить на блоке «**Нажатие кнопки**».  

    _![Переход к свойствам блока сценария](sql_receive_connection_scenario_properties_transfer.png)_

9. Настройте свойства события:
    - Смените «**Тип**» на «**Получение сообщения**».
    - В поле «**Контекстный шаблон**» укажите шаблон записи, в который необходимо записать названия городов, полученные из внешней БД.
    - В поле «**Подключение**» выберите ранее созданное подключение к СУБД.
    - В поле «**Путь передачи данных**» выберите ранее созданный путь передачи данных из СУБД.
    - В поле «**Имя переменной**» введите имя переменной (это имя может быть любым), в которую будут передаваться данные, полученные из внешней БД.  

        _![Настройка события получения сообщения из MySQL в сценарии](sql_receive_connection_receive_message_settings.png)_

10. Нажмите кнопку «**Добавить действие**» под блоком «**Получение сообщения**».  

    ![Добавление действия в сценарий](sql_receive_connection_scenario_add.png)

11. Добавьте действие «**Повторять по количеству объектов**» и настройте его:
{: #step11}
    - В поле «**Переменная**» имя переменной для итераций в цикле.
    - В поле «**Атрибут или выражение для поиска объектов**» введите следующее выражение:
        - ****Формула****

            ```
            $$CityRecords->City
            ```

        - **N3**

            ```
            @prefix session: <http://comindware.com/ontology/session#>. 
            @prefix var: <http://comindware.com/ontology/session/variable#>. 
            { 
                session:context var:CityRecords ?message. 
                ?message var:City ?value. 
            }
            ```

        - Здесь:
            - `CityRecords` — **имя переменной**, указанное в свойствах свойствах события «[**Получение сообщения**](#создание-сценария-для-получения-данных-из-субд)».
            - `City` — системное имя атрибута-массива, созданного [на вкладке «**Атрибуты сообщений**»](#step8) в свойствах пути передачи данных.
    - Нажмите кнопку «**Сохранить**».  

        _![Настройка цикла по объектам в сценарии](sql_receive_connection_scenario_cycle_scenario.png)_

12. Добавьте в действие «**Повторять по количеству объектов**» вложенное действие «**Создание записи**» и настройте его:
{: #step12}
    - В поле «**Целевой шаблон записи**» выберите шаблон, в котором требуется создавать записи с данными, полученными из внешней БД.
    - Нажмите кнопку «**Сохранить**».  

        _![Настройка действия «Создать запись» в сценарии](sql_receive_connection_scenario_create_record_settings.png)_

13. Добавьте в действие «**Создание записи**» вложенное действие «**Изменить значения атрибутов**» и настройте его.
    - Нажмите кнопку «**Создать**».
    - В столбце «**Атрибут**» выберите атрибут указанного на [шаге 12](#step12) шаблона, в который будут помещаться названия городов, полученные из внешней БД.
    - В столбце «**Операция со значениями**» выберите пункт «**Заменить**».
    - В поле «**Значение**» введите следующее выражение:
        - ****Формула****

            ```
            $$record->Name
            ```

        - **N3**

            ```
            @prefix session: <http://comindware.com/ontology/session#>. 
            @prefix variable: <http://comindware.com/ontology/session/variable#>. 
            { 
                session:context variable:record ?records. 
                ?records variable:Name ?value. 
            }
            ```

        - Здесь переменная `record`  — имя переменной, заданное на [шаге 11](#step11) в свойствах цикла по объектам.
            
        - Здесь переменная `Name` — системное имя строкового атрибута (в массиве `City` ), созданного [на вкладке «**Атрибуты сообщений**»](#step8) в свойствах пути передачи данных.
    - Нажмите кнопку «**Сохранить**».  

        _![Настройка действия «Изменить значения атрибутов» в сценарии](sql_receive_connection_change_attributes_settings.png)_

14. Должен получиться показанный на следующей иллюстрации сценарий.  

    _![Сценарий для сохранения данных из MySQL в шаблон записи](sql_receive_connection_scenario.png)_

## Тестирование сценария

1. Дождитесь срабатывания таймера, заданного в поле «**Интервал опроса**» [пути для получения данных из СУБД](#создание-пути-получения-данных-из-субд).
2. При срабатывании таймера должен сработать [настроенный сценарий](#создание-сценария-для-получения-данных-из-субд).
3. Сценарий должен создавать в шаблоне записи «_Города_» записи с названиями городов, полученных из внешней БД.

--8<-- "related_topics_heading.md"

**[Внешняя СУБД (MySQL, MSSQL, Oracle, Postgres). Отправка SQL-запроса SELECT. Настройка подключения, пути передачи данных и сценария][sql_send_connection]**
