---
title: Получение документов через «СФЕРА Курьер»
kbId:
tags:
    - СФЕРА Курьер
    - электронный документооборот
    - получение документов
    - сценарий
hide: tags
---

# Получение документов через «СФЕРА Курьер». Настройка подключения, пути передачи данных и сценария {: #esphere_receive_configure}

## Введение

В **{{ productName }}** можно настраивать подключение к системе электронного документооборота «СФЕРА Курьер». С помощью интеграции с «СФЕРА Курьер» можно:

- осуществлять поиск контрагентов по реквизитам и проверять их корректность;
- настроить обмен документами с контрагентами;
- производить возможные действия с документами и квитанциями;
- подписывать документы квалифицированной электронной подписью;
- контролировать сроки подписания документов.

Здесь приведён пример настройки подключения, пути передачи данных, шаблона и сценария получения документов из системы «СФЕРА Курьер».

## Порядок настройки

1. Настройте пользовательское подключение типа «**Получение сообщений из системы «СФЕРА Курьер**».
2. Настройте путь передачи данных «**Приём сообщений из «СФЕРА Курьер**», использующий созданное подключение.
3. Настройте шаблон с данными контрагентов.
4. Настройте сценарий для получения данных о контрагенте из системы «СФЕРА Курьер».

## Настройка подключения

1. Откройте страницу «**Администрирование**» — «**Подключения**».
2. Откройте двойным нажатием в списке или создайте подключение типа «**Пользовательские подключения**» — «**Получение сообщений из системы «СФЕРА Курьер**».
3. Настройте свойства подключения:

    - **Системное имя** — введите уникальное имя подключения. Рекомендуется использовать буквы латинского алфавита, цифры и символ «_».
    - **Отключить** — установите этот флажок, если требуется временно деактивировать данное подключение.
    - **Описание** — введите наглядное описание подключения, например _«Подключение для получения сообщений из системы «СФЕРА Курьер»_.
    - **Запись в файловые журналы** — выберите, какие события следует записывать в журналы:
         - **Полные сведения об обработке сообщения**;
         - **Только ошибки**;
         - **Отключить** — не регистрировать в журнале события отправки сообщений.
    - **Тестовый сервер** — установите этот флажок, если требуется настроить подключение к тестовому серверу.
    - **Интервал запроса данных, в минутах** — укажите интервал запроса к серверу.
    - **ApiKey** — введите ключ API для подключения к «СФЕРА Курьер».
    - **Имя пользователя** — укажите учетную запись для подключения к «СФЕРА Курьер».
    - **Пароль** — введите пароль для подключения к «СФЕРА Курьер».
    - **Идентификатор участника ЭДО получателя документа** — укажите идентификатор, присвоенный участнику «СФЕРА Курьер».

4. Нажмите кнопку «**Проверить соединение**».
5. Чтобы просмотреть журнал событий отправки сообщений, нажмите кнопку «**Скачать журнал**».
6. Сохраните подключение.

## Настройка пути передачи данных

1. Откройте страницу «**Администрирование**» — «**Пути передачи данных**».
2. Откройте двойным нажатием в списке или создайте подключение типа «**Пользовательские подключения**» — «**Приём сообщений из «СФЕРА Курьер**».
3. Настройте свойства пути передачи данных на следующих вкладках:

    - [**Основные свойства**](#основные-свойства)
    - [**Атрибуты сообщения**](#атрибуты-сообщения)
    - [**Интеграция**](#интеграция)

4. Сохраните путь передачи данных.

### Основные свойства

На вкладке «**Основные свойства**» настройте параметры использования пути передачи данных.

- **Подключение** — выберите [подключение для отправки сообщений в систему «СФЕРА Курьер»](#настройка-подключения).
- **Системное имя** — введите уникальное имя пути передачи данных. Рекомендуются буквы латинского алфавита, цифры и символ «_».
- **Отключить** — установите этот флажок, если требуется временно деактивировать данный путь передачи данных.
- **Описание** — введите наглядное описание пути передачи данных, например _«Путь для получения сообщений из «СФЕРА Курьер»_.
- **Номер шины данных** — выберите номер от 0 до 3, если требуется распределить потоки данных нескольких путей для повышения производительности.

### Атрибуты сообщений

На вкладке «**Атрибуты сообщения**» настройте атрибуты, значения которых будут подставляться в содержимое сообщений в зависимости от его типа.

Имеются следующие **типы сообщений**:

- Поиск документов;
- List companies by Inn.

Значения атрибутов сообщения необходимо присвоить с помощью [сценария](#настройка-сценария).

В таблицах «**Запрос**», «**Ответ**» и «**Ответ с ошибкой**» содержатся готовые атрибуты для разных типов сообщения.

Подробнее см. _[«Справочное руководство API СФЕРА Курьер»](https://www.esphere.ru/assets/download/integration/ws-courier.pdf)_.

### Интеграция

На вкладке «**Интеграция**» можно задать статистические параметры запроса к системе «Сфера Курьер»:

- Для типа сообщения «**Поиск документов**»:
    - **Папка документов** — укажите название папки системы «СФЕРА Курьер» для поиска документов.
    - **Количество строк** — укажите максимальное количество документов, которые могут быть получены в одном запросе.
    - **Идентификатор статуса** — укажите идентификатор статуса документа системы «СФЕРА Курьер» для поиска.
    - **Признак завершённости документооборота** — установите флажок для поиска документа с этим признаком.
    - **Признак того, что документ назначен текущему пользователю** — установите флажок для поиска документа с этим признаком.
    - **Системное имя** — укажите системное имя документа для поиска «СФЕРА Курьер».
    - **Номер договора** — укажите номер договора для поиска документа в системе «СФЕРА Курьер».
    - **Имя файла** — укажите имя файла для поиска документа в системе «СФЕРА Курьер».
    - **Описание** — 
    - **Идентификатор участника маршрута** — укажите уникальный идентификатор участника системы электронного документооборота (ЭДО).
    - **Идентификатор группы участников маршрута** — укажите уникальный идентификатор группы участников системы электронного документооборота (ЭДО).
    - Укажите **даты** для поиска документа в системе «СФЕРА Курьер».
- Для типа сообщения «**List companies by Inn**»:
    - **ИНН клиента** — укажите ИНН клиента для поиска в системе «СФЕРА Курьер».
    - **ОГРН клиента** — укажите ОГРН клиента для поиска в системе «СФЕРА Курьер».
    - **КПП клиента** — укажите КПП клиента для поиска в системе «СФЕРА Курьер».

## Настройка шаблона записи и сценария

### Настройка шаблона записи

1. Создайте шаблон записи «Документы из СФЕРА Курьер» со следующими атрибутами:

    - _Идентификатор документа «СФЕРА Курьер»_ типа «**Текст**»;
    - _Электронный договор_ типа «**Логический**»;
    - _Сумма документа_ типа «**Число**»;
    - _Сумма НДС_ типа «**Число**»;
    - _Номер документа контрагента_ типа «**Текст**»;
    - _Дата документа контрагента_ типа «**Дата и время**»;
    - _Документ_ типа «**Документ**».

2. Добавьте атрибуты на форму.

### Настройка сценария

1. Создайте новый сценарий:

    - **Название:** _Получение документов из СФЕРА Курьер_
    - **Контекст выполнения: от инициатора**

2. Настройте начальное событие сценария:

    - **Тип: получение сообщения**
    - **Контекстный шаблон:** _Документы из СФЕРА Курьер_
    - **Подключение:** выберите [подключение для получения сообщения из системы «СФЕРА Курьер»](#настройка-подключения)
    - **Путь передачи данных:** выберите [путь передачи данных для получения сообщений из системы «СФЕРА Курьер» типа «Поиск документов»](#настройка-пути-передачи-данных)
    - **Имя переменной:** _Message_

3. Добавьте действие «**Изменить значения переменных**» со следующими свойствами:

    - **Операция со значениями переменных: добавить**
    - **Набор переменных:** _Document_

4. В настройках действия добавьте следующие переменные:

    - _Content_ со значением **N3**:

        ``` turtle
        @prefix session: <http://comindware.com/ontology/session#>.
        @prefix var: <http://comindware.com/ontology/session/variable#>.

        {
            session:context var:Message ?v0.
            ?v0 var:Content ?V1.
            ?V1 var:Content ?value.
        }
        ```
    
    - _Name_ со значением **N3**:

        ``` turtle
        @prefix session: <http://comindware.com/ontology/session#>.
        @prefix var: <http://comindware.com/ontology/session/variable#>.

        {
            session:context var:Message ?v0.
            ?v0 var:Content ?V1.
            ?V1 var:Filename ?value.
        }

5. Добавьте действие «**Выполнить по условиям**» со следующими параметрами:

    - **Название условия:** _NotHaveDocument_
    - **Выражение: N3**

        ``` turtle
        @prefix object: <http://comindware.com/ontology/object#>.
        @prefix variable: <http://comindware.com/ontology/session/variable#>.
        @prefix session: <http://comindware.com/ontology/session#>.
        @prefix cmwui: <http://comindware.com/ontology/ui#>.
        @prefix assert: <http://comindware.com/logics/assert#>.
        {
            session:context variable:Message ?request.
            ?request variable:Id ?docId.
            ?docId cmwui:toClientString ?docIdStr.
            ("Dokumenty" "idDokumentaEDO") object:findProperty ?foundProperty.
            
            {?aaa ?foundProperty ?docIdStr.} assert:count ?c.
            if {?c == 0}
            then {true -> ?value.}.
        }
        ```

6. Внутрь действия «**Выполнить по условиям**» поместите действие «**Создать запись**» и выберите в качестве целевого шаблона записи шаблон _«Документы из СФЕРА Курьер»_.
7. Внутрь действия «**Создать запись**» поместите действие «**Прикрепить документ к атрибуту**» со следующими свойствами:

    - **Атрибут:** _Документ_
    - **Операция соо значениями: добавить**
    - **Значение: формула**
    
        ``` cs
        $$Document
        ```

8. Внутрь действия «**Создать запись**» поместите действие «**Изменить значения атрибутов**» со следующими значениями:

| Атрибут | Операция со значениями | Значение |
|---|---|---|
| _Идентификатор документа «СФЕРА Курьер»_ | **Заменить** | <p>**N3:**</p><p></p><p>``` turtle</p><p>@prefix var: <http://comindware.com/ontology/session/variable#>.
@prefix session: <http://comindware.com/ontology/session#>.
@prefix ui: <http://comindware.com/ontology/ui#>.
{
    session:context var:Message ?request.
	?request var:Id ?docId.
	?docId ui:toClientString ?value.
#$$Message->Id
}</p><p>```</p><p></p> |
|_Электронный договор_| **Заменить** | **Формула:** `true` |
| _Сумма документа_ | **Заменить** | **Формула:** `$$Message->TotalSum`|
| _Сумма НДС_ | **Заменить** | **Формула:** `$$Message->VatSum`|
| _Номер документа контрагента_ | **Заменить** | **Формула:** `$$Message->Number` |
| _Дата документа контрагента_ | **Заменить** | **Формула:** `$$Message->Date` |

## Тестирование

1. Отправьте документ пользователю, API которого используется при [подключении к системе «СФЕРА Курьер»](#настройка-подключения).
2. Перейдите к экземплярам шаблона записи _«Документы из СФЕРА Курьер»_.
3. Отобразится новая запись.
4. Перейдите к новой записи и посмотрите, какие данные были получены.

--8<-- "related_topics_heading.md"

**[Подключения. Определения, типы, создание, настройка, удаление][connections]**

**[Пути передачи данных][communication_routes]**

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}