---
title: Получение документов через «СФЕРА Курьер»
kbId:
tags:
    - СФЕРА Курьер
    - электронный документооборот
    - получение документов
    - сценарий
hide: tags
---

# Получение документов через «СФЕРА Курьер». Настройка подключения, пути передачи данных и сценария {: #esphere_receive_configure}

## Введение

В **{{ productName }}** можно настроить подключение к системе электронного документооборота «СФЕРА Курьер». Интеграция с этой системой позволяет:

- осуществлять поиск контрагентов по реквизитам и проверять их корректность;
- настроить обмен документами с контрагентами;
- производить возможные действия с документами и квитанциями;
- подписывать документы квалифицированной электронной подписью;
- контролировать сроки подписания документов.

Здесь приведён пример настройки подключения, пути передачи данных, шаблона и сценария получения документов из системы «СФЕРА Курьер».

## Порядок настройки

!!! warning "Внимание"

    Из-за особенностей API «СФЕРА Курьер» при получении сообщений приходят не все атрибуты электронного документа. Чтобы получить полный перечень документов, требуется дополнительно настроить отправку сообщений, см. _«[Отправка документов через «СФЕРА Курьер». Настройка подключения, пути передачи данных и сценария][esphere_send_configure]»_.

1. Настройте пользовательское [подключение](#настройка-подключения) типа «**Получение сообщений из системы «СФЕРА Курьер**».
2. Настройте [путь передачи данных](#настройка-пути-передачи-данных) «**Приём сообщений из «СФЕРА Курьер**», использующий созданное подключение.
3. Настройте пользовательское подключение типа «**Отправка сообщений в систему «СФЕРА Курьер**».
4. Настройте путь передачи данных «**Отправка сообщений в «СФЕРА Курьер**», использующий созданное подключение, для сообщений типа «**Получить документ**».
5. Настройте [шаблон](#настройка-шаблона-записи) для данных электронных документов.
6. Настройте [сценарий](#настройка-сценария) для получения данных о контрагенте из системы «СФЕРА Курьер».

## Настройка подключения

1. Откройте страницу «**Администрирование**» — «**Подключения**».
2. Откройте двойным нажатием в списке или создайте подключение типа «**Пользовательские подключения**» — «**Получение сообщений из системы «СФЕРА Курьер**».
3. Настройте свойства подключения:

    - **Системное имя** — введите уникальное имя подключения. Рекомендуется использовать буквы латинского алфавита, цифры и символ «_».
    - **Отключить** — установите этот флажок, если требуется временно деактивировать данное подключение.
    - **Описание** — введите наглядное описание подключения, например _«Подключение для получения сообщений из системы «СФЕРА Курьер»_.
    - **Запись в файловые журналы** — выберите, какие события следует записывать в журналы:
         - **Полные сведения об обработке сообщения**;
         - **Только ошибки**;
         - **Отключить** — не регистрировать в журнале события отправки сообщений.
    - **Тестовый сервер** — установите этот флажок, если требуется настроить подключение к тестовому серверу.
    - **Интервал запроса данных, в минутах** — укажите интервал запроса к серверу.
    - **ApiKey** — введите ключ API для подключения к «СФЕРА Курьер».
    - **Имя пользователя** — укажите учетную запись для подключения к «СФЕРА Курьер».
    - **Пароль** — введите пароль для подключения к «СФЕРА Курьер».
    - **Идентификатор участника ЭДО получателя документа** — укажите идентификатор, присвоенный участнику «СФЕРА Курьер».

4. Нажмите кнопку «**Проверить соединение**».
5. Чтобы просмотреть журнал событий отправки сообщений, нажмите кнопку «**Скачать журнал**».
6. Сохраните подключение.

## Настройка пути передачи данных

1. Откройте страницу «**Администрирование**» — «**Пути передачи данных**».
2. Откройте двойным нажатием в списке или создайте подключение типа «**Пользовательские подключения**» — «**Приём сообщений из «СФЕРА Курьер**».
3. Настройте свойства пути передачи данных на следующих вкладках:

    - [**Основные свойства**](#основные-свойства)
    - [**Атрибуты сообщений**](#атрибуты-сообщений)
    - [**Интеграция**](#интеграция)

4. Сохраните путь передачи данных.

### Основные свойства

На вкладке «**Основные свойства**» настройте параметры использования пути передачи данных.

- **Подключение** — выберите [подключение для отправки сообщений в систему «СФЕРА Курьер»](#настройка-подключения).
- **Системное имя** — введите уникальное имя пути передачи данных. Рекомендуются буквы латинского алфавита, цифры и символ «_».
- **Отключить** — установите этот флажок, если требуется временно деактивировать данный путь передачи данных.
- **Описание** — введите наглядное описание пути передачи данных, например _«Путь для получения документов из «СФЕРА Курьер»_.
- **Номер шины данных** — выберите номер от 0 до 3, если требуется распределить потоки данных нескольких путей для повышения производительности.

### Атрибуты сообщений

На вкладке «**Атрибуты сообщения**» настройте атрибуты, значения которых будут подставляться в содержимое сообщений в зависимости от его типа.

1. Выберите **тип сообщения**:

    - Поиск документов;
    - List companies by Inn.

    В примере используется тип сообщения «**Поиск документов**».

2. В таблицах «**Запрос**», «**Ответ**» и «**Ответ с ошибкой**» отобразятся готовые атрибуты, соответствующие выбранному **типу сообщения**.
3. При необходимости настройте собственные атрибуты сообщений.

Подробнее об атрибутах, которые используются при обмене сообщениями с системой «СФЕРА Курьер», см. _[«Справочное руководство API СФЕРА Курьер»](https://www.esphere.ru/assets/download/integration/ws-courier.pdf)_.

### Интеграция

На вкладке «**Интеграция**» можно задать статистические параметры запроса к системе «Сфера Курьер»:

- Для типа сообщения «**Поиск документов**»:
    - **Папка документов** — укажите название папки системы «СФЕРА Курьер» для поиска документов.
    - **Количество строк** — укажите максимальное количество документов, которые могут быть получены в одном запросе.
    - **Идентификатор статуса** — укажите идентификатор статуса документа системы «СФЕРА Курьер» для поиска.
    - **Признак завершённости документооборота** — установите флажок для поиска документа с этим признаком.
    - **Признак того, что документ назначен текущему пользователю** — установите флажок для поиска документа с этим признаком.
    - **Системное имя** — введите уникальное имя пути передачи данных. Рекомендуются буквы латинского алфавита, цифры и символ «_».
    - **Номер договора** — укажите номер договора для поиска документа в системе «СФЕРА Курьер».
    - **Имя файла** — укажите имя файла для поиска документа в системе «СФЕРА Курьер».
    - **Описание** — введите наглядное описание пути передачи данных, например _«Путь для получения документов из «СФЕРА Курьер»_.
    - **Идентификатор участника маршрута** — укажите уникальный идентификатор участника системы электронного документооборота (ЭДО).
    - **Идентификатор группы участников маршрута** — укажите уникальный идентификатор группы участников системы электронного документооборота (ЭДО).
    - Укажите **даты** для поиска документа в системе «СФЕРА Курьер».
- Для типа сообщения «**List companies by Inn**»:
    - **ИНН клиента** — укажите ИНН клиента для поиска в системе «СФЕРА Курьер».
    - **ОГРН клиента** — укажите ОГРН клиента для поиска в системе «СФЕРА Курьер».
    - **КПП клиента** — укажите КПП клиента для поиска в системе «СФЕРА Курьер».

## Настройка шаблона записи и сценария

### Настройка шаблона записи

1. Создайте шаблон записи _«Реестр документов из СФЕРА Курьер»_ со следующими атрибутами:

    - _Идентификатор документа «СФЕРА Курьер»_ типа «**Текст**»;
    - _Электронный договор_ типа «**Логический**»;
    - _Сумма документа_ типа «**Число**»;
    - _Сумма НДС_ типа «**Число**»;
    - _Номер документа контрагента_ типа «**Текст**»;
    - _Дата документа контрагента_ типа «**Дата и время**»;
    - _Документ_ типа «**Документ**».

2. Добавьте атрибуты на форму.

### Настройка сценария

1. Создайте новый сценарий:

    - **Название:** _Получение документов из СФЕРА Курьер_
    - **Контекст выполнения: от инициатора**

2. Настройте начальное событие сценария:

    - **Тип: получение сообщения**
    - **Контекстный шаблон:** _Реестр документов из СФЕРА Курьер_
    - **Подключение:** выберите [подключение для получения сообщения из системы «СФЕРА Курьер»](#настройка-подключения)
    - **Путь передачи данных:** выберите [путь передачи данных для получения сообщений из системы «СФЕРА Курьер» типа «**Поиск документов**»](#настройка-пути-передачи-данных)
    - **Имя переменной:** _Message_

3. Добавьте действие «**Изменить значения переменных**» со следующими свойствами:

    - **Операция со значениями переменных: добавить**
    - **Набор переменных:** _Request_
4. В настройках действия добавьте переменную _DocumentId_ со следующим значением **N3**:

    ``` turtle
    # Импортируем функции для работы с переменными
    @prefix session: <http://comindware.com/ontology/session#>.
    @prefix variable: <http://comindware.com/ontology/session/variable#>.
    {
        # Получаем значение локальной переменной Message и помещаем в ?message
        session:context variable:Message ?message.
        # Получаем из ?message значение переменной Id и возвращаем его
        ?message variable:Id ?value.
    }
    ```

5. Добавьте действие «**Отправить сообщение**» со следующими свойствами:

    - **Подключение:** выберите [подключение для отправки сообщения в систему «СФЕРА Курьер»](#порядок-настройки)
    - **Путь передачи данных:** выберите [путь передачи данных для отправки сообщений в «СФЕРА Курьер» типа «**Получить документ**»](#порядок-настройки)
    - **Переменная с сообщением:** _Request_
    - **Переменная для успешного ответа:** _Response_
    - **Переменная для ответа с ошибкой:** _Error_

6. Добавьте действие «**Изменить значения переменных**» со следующими свойствами:

    - **Операция со значениями переменных: добавить**
    - **Набор переменных:** _Document_

7. В настройках действия добавьте следующие переменные:

    - _Content_ со значением **N3**:

        ``` turtle
        # Импортируем функции для работы с переменными
        @prefix session: <http://comindware.com/ontology/session#>.
        @prefix variable: <http://comindware.com/ontology/session/variable#>.

        {
            # Получаем значение локальной переменной Response и помещаем в ?response
            session:context variable:Response ?response.
            # Получаем из ?response документ и помещаем в ?document
            ?response variable:Content ?document.
            # Из ?document получаем содержимое документа и возвращаем его
            ?document variable:Content ?value.
        }
        ```
    
    - _Name_ со значением **N3**:

        ``` turtle
        # Импортируем функции для работы с переменными
        @prefix session: <http://comindware.com/ontology/session#>.
        @prefix var: <http://comindware.com/ontology/session/variable#>.

        {
            # Получаем значение локальной переменной Response и помещаем в ?response
            session:context var:Response ?response.
            # Получаем из ?response документ и помещаем в ?document
            ?response var:Content ?document.
            # Из ?document получаем имя файла документа и возвращаем его
            ?document var:Filename ?value.
        }
        ```

8. Добавьте действие «**Выполнить по условиям**» со следующими параметрами:

    - **Название условия:** _NotHaveDocument_
    - **Выражение: N3**

        ``` turtle
        # Импортируем функции для работы с переменными и атрибутами
        @prefix object: <http://comindware.com/ontology/object#>.
        @prefix variable: <http://comindware.com/ontology/session/variable#>.
        @prefix session: <http://comindware.com/ontology/session#>.
        @prefix cmwui: <http://comindware.com/ontology/ui#>.
        @prefix assert: <http://comindware.com/logics/assert#>.
        {
            # Получаем значение локальной переменной Response и помещаем в ?response
            session:context variable:Response ?response.
            # Получаем из ?response ID документа и помещаем его в ?docId
            ?response variable:Id ?docId.
            # Приводим ?docId к строковому типу и помещаем в ?docIdStr
            ?docId cmwui:toClientString ?docIdStr.
            # Находим атрибут idDokumentaEDO (Идентификатор документа «СФЕРА Курьер»)
            # в шаблоне Reestrdokumentov (Реестр документов из СФЕРА Курьер)
            ("Reestrdokumentov" "idDokumentaEDO") object:findProperty ?foundIds.
            
            # Сравниваем ?foundIds и ?docIdStr на предмет совпадений
            {?coincidence ?foundIds ?docIdStr.} assert:count ?countCoincidence.
            # Если совпадений нет (т.е. ID документа из полученного сообщения
            # не встречается в шаблоне «Реестр документов из СФЕРА Курьер»)
            if {?countCoincidence == 0}
            # возвращаем значение true
            then {true -> ?value.}.
        }
        ```

9. Внутрь действия «**Выполнить по условиям**» поместите действие «**Создать запись**» и выберите в качестве целевого шаблона записи шаблон _«Реестр документов из СФЕРА Курьер»_.
10. Внутрь действия «**Создать запись**» поместите действие «**Прикрепить документ к атрибуту**» со следующими свойствами:

    - **Атрибут:** _Документ_
    - **Операция со значениями: добавить**
    - **Значение: формула**

        ``` cs
        $$Document
        ```

11. Внутрь действия «**Создать запись**» поместите действие «**Изменить значения атрибутов**» со следующими значениями:

<table markdown="block">
<tbody markdown="block">
<tr markdown="block">
<th markdown="block">
Атрибут
</td>
<th markdown="block">
Операция со значениями
</td>
<th markdown="block">
Значение
</td>
</tr>
<tr markdown="block">
<td markdown="block">
_Идентификатор документа «СФЕРА Курьер»_
</td>
<td markdown="block">
**Заменить**
</td>
<td markdown="block">

**N3:**

``` turtle
# Импортируем функции для работы с переменными
@prefix variable: <http://comindware.com/ontology/session/variable#>.
@prefix session: <http://comindware.com/ontology/session#>.
@prefix ui: <http://comindware.com/ontology/ui#>.
{
    # Получаем значение локальной переменной Response
    # и помещаем в ?response
    session:context variable:Response ?response.
    # Получаем из ?response ID документа и помещаем его в ?docId
    ?response variable:Id ?docId.
    # Приводим ?docId к строковому типу и возвращаем значение ID
    ?docId ui:toClientString ?value.
}
```

</td>
</tr>
<tr markdown="block">
<td markdown="block">
_Электронный договор_
</td>
<td markdown="block">
**Заменить**
</td>
<td markdown="block">
**Формула:** `true`
</td>
</tr>
<tr markdown="block">
<td markdown="block">
_Сумма документа_
</td>
<td markdown="block">
**Заменить**
</td>
<td markdown="block">
**Формула:** `$$Response->TotalSum`
</td>
</tr>
<tr markdown="block">
<td markdown="block">
_Сумма НДС_
</td>
<td markdown="block">
**Заменить**
</td>
<td markdown="block">
**Формула:** `$$Response->VatSum`
</td>
</tr>
<tr markdown="block">
<td markdown="block">
_Номер документа контрагента_
</td>
<td markdown="block">
**Заменить**
</td>
<td markdown="block">
**Формула:** `$$Response->Number`
</td>
</tr>
<tr markdown="block">
<td markdown="block">
_Дата документа контрагента_
</td>
<td markdown="block">
**Заменить**
</td>
<td markdown="block">
**Формула:** `$$Response->Date`
</td>
</tr>
</tbody>
</table>

_![Сценарий получения документов из системы «СФЕРА Курьер»](img/esphere_receive_configure_scenario.png)_

## Тестирование

1. Отправьте документ пользователю, API которого используется при [подключении к системе «СФЕРА Курьер»](#настройка-подключения).
2. Перейдите к экземплярам шаблона записи _«Реестр документов из СФЕРА Курьер»_.
3. Отобразится новая запись.
4. Перейдите к новой записи и посмотрите, какие данные были получены.

--8<-- "related_topics_heading.md"

**[Подключения. Определения, типы, создание, настройка, удаление][connections]**

**[Пути передачи данных][communication_routes]**

**[Отправка документов через «СФЕРА Курьер». Настройка подключения, пути передачи данных и сценария][esphere_send_configure]**

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}
