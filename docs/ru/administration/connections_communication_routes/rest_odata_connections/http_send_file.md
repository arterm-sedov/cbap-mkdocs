---
title: HTTP-запросы типа POST. Отправка составного содержимого и файлов
kbTitle: HTTP-запросы типа POST. Отправка составного содержимого и файлов. Настройка подключения, пути передачи данных и сценария
kbId: 5066
tags:
    - отправка документов по HTTP
    - отправка файлов по HTTP
    - составное содержимое
    - файлы
    - multipart
hide:
    - tags
---

# HTTP-запросы типа POST. Отправка составного содержимого и файлов {: #http_send_file}

## Введение

**{{ productName }}** позволяет отправлять HTTP-запросы типа `POST` для взаимодействия с внешними системами.

Здесь представлены инструкции по настройке подключения, пути передачи данных, шаблона записи и сценария для отправки запросов типа `POST` в формате `JSON` с составным содержимым и прикреплёнными файлами.

## Прикладная задача

Имеется шаблон _«Реестр документов»_, содержащий записи с прикреплёнными файлами.

Требуется настроить кнопку для отправки прикреплённых файлов во внешнюю систему с помощью HTTP-запроса типа `POST`.

## Настройка подключения

1. На странице **Администрирование**» выберите пункт «**Инфраструктура**» — «**Подключения**».
2. Откройте двойным нажатием или создайте подключение типа «**Подключения REST и OData**» — «**Отправка HTTP-запросов**».
3. Настройте подключение к серверу:

    - **Системное имя** — введите уникальное имя подключения.
    --8<-- "system_name_requirements.md:no_autofill"
    - **Отключить** — установите этот флажок, если требуется временно деактивировать данное подключение.
    - **Описание** — введите наглядное описание подключения, например _«Подключение для отправки файлов по HTTP»_.
    - **Запись в файловые журналы** — выберите, какие события следует записывать в журналы:
        - **Полные сведения об обработке сообщения**;
        - **Только ошибки**;
        - **Отключить** — не регистрировать в журнале события получения писем.
    - **URI** — укажите адрес сервера, на который будут отправляться запросы.
    - **Формат данных** — выберите **JSON**.
    - **Кодировка данных** — укажите формат кодировки данных, используемый сервером, по умолчанию: **UTF-8**.
    - **Тип аутентификации** — выберите способ проверки подлинности, используемый сервером:
        - **Отсутствует**;
        - **Базовая**;
        - **Аутентификация Windows**.
    - **Имя пользователя** — укажите учётную запись для подключения к серверу.
    - **Пароль** — введите пароль к учётной записи для подключения к серверу.
    - **Домен** — укажите домен пользователя сервера.

4. Проверьте соединение с сервером, нажав соответствующую кнопку.
5. При необходимости нажмите кнопку «**Скачать журнал**», чтобы просмотреть журнал событий получения запросов.
6. Сохраните подключение.

## Настройка пути передачи данных

1. На странице «**Администрирование**» в разделе «**Архитектура**» выберите пункт «[**Пути передачи данных**][communication_routes]» <i class="fa-light fa-route " aria-hidden="true"></i>.
2. Откройте двойным нажатием в списке или создайте путь передачи данных типа «**Подключения REST и OData**» — «**Отправка HTTP-запросов**».
3. Настройте свойства пути передачи данных на следующих вкладках:

     - [**Основные свойства**](#основные-свойства)
     - [**Атрибуты сообщений**](#атрибуты-сообщений)
     - [**Интеграция**](#интеграция)

4. Сохраните путь передачи данных.

### Основные свойства

На вкладке «**Основные свойства**» настройте параметры использования пути передачи данных:

- **Подключение** — выберите [подключение для отправки HTTP-запросов](#настройка-подключения).
- **Системное имя** — введите уникальное имя пути передачи данных.
--8<-- "system_name_requirements.md:no_autofill"
- **Отключить** — установите этот флажок, если требуется временно деактивировать путь передачи данных.
- **Описание** — введите наглядное описание пути передачи данных, например _«Путь передачи данных для отправки файлов по HTTP»_.
- **Номер шины данных** — выберите номер от 0 до 3, если требуется распределить потоки данных нескольких путей для повышения производительности.

### Атрибуты сообщений

!!! warning "Составление атрибута сообщения типа «Объект»"

    Чтобы составить **атрибут сообщения** типа «**Объект**» для хранения имени и содержимого файла, необходимо создать структуру из родительского и дочерних атрибутов:

      - Создайте атрибут типа «**Объект**», задайте его имя, но оставьте значение пустым.
      - Установите флажок у имени родительского атрибута в таблице и нажмите кнопку «**Создать**».
      - Дважды нажмите значок <i class="fa-light fa-angle-down anchor"></i> рядом с родительским атрибутом.
      - В таблице отобразится строка дочернего атрибута.
      - Задайте системное имя и тип дочернего атрибута.

1. Выберите тип сообщения «**Отправка HTTP-запросов с составным содержимым**» или «**Отправка HTTP-запросов**».
2. В таблицу «**Запрос**» добавьте атрибут типа «**Объект**», например _File_.
3. Добавьте дочерние атрибуты типа «**Строка**», например _Name_ и _Content_.

### Интеграция

- Если на вкладке «**Атрибуты сообщений**» выбран тип сообщения «**Отправка HTTP-запросов с составным содержимым**», настройте параметры на вкладке «**Интеграция**» следующим образом:

    1. Выберите **метод запроса POST**.
    2. В таблицу «**Атрибуты для формирования тела запроса (POST, PUT)**» добавьте атрибут _File_ с форматом данных «**Файловая структура**».

- Если на вкладке «**Атрибуты сообщений**» выбран тип сообщения «**Отправка HTTP-запросов**», настройте параметры на вкладке «**Интеграция**» следующим образом:

    1. Выберите **метод запроса POST**.
    2. В поле «**Атрибуты для сериализации в тело запроса**» укажите _File_.

## Настройка шаблона записи

1. Создайте шаблон записи _«Реестр документов»_ с системным именем _DocumentRegistry_.
2. Создайте атрибут _«Вложения»_:

    - **Тип данных: документ**
    - **Системное имя**: _Attachment_
    - **Хранить несколько значений**: флажок установлен

3. Создайте кнопку _«Отправить вложения»_ со следующими свойствами:

    - **Контекст операции: запись**
    - **Операция: вызвать событие «Нажата кнопка»**
    - **Результат выполнения: обновить данные**

4. Поместите атрибут _«Вложения»_ и кнопку _«Отправить вложения»_ на форму.

## Настройка сценария

!!! warning "Логика работы сценария отправки файлов"

    - Сценарий срабатывает при нажатии кнопки _«Отправить вложения»_ на форме записи с прикреплёнными файлами.
    - Запускается цикл, перебирающий все прикреплённые файлы.
    - На каждой итерации цикла формируется и отправляется отдельный HTTP-запрос, содержащий данные файла в формате JSON:
        - Формируются переменные с именем и содержимым файла: `$$Name` и `$$Content`.
        - Формируется переменная-объект для отправки в теле HTTP-запроса:
        ``` json
        {
            "Message":{
                "File":{
                    "Name":"STRING",
                    "Content":"STRING"
                }
            }
        }
        ```
        - `$$Message->File->Name` присваивается значение переменной `$$Name`.
        - `$$Message->File->Content` присваивается значение переменной `$$Content`.
        - Содержимое переменной `$$Message` в формате JSON отправляется в качестве HTTP-запроса.
        - Содержимое переменной `$$Message` очищается для использования в следующей итерации цикла.

1. Создайте сценарий _«Отправка документов через HTTP»_.
2. В свойствах события «**Нажатие кнопки**» выберите **контекстный шаблон** _«Реестр документов»_ и **кнопку** _«Отправить вложения»_.
3. После события «**Нажатие кнопки**» создайте действие «**Повторять по количеству объектов**» со следующими свойствами:

    - **Объект для поиска: атрибут** _«Вложения»_

4. Внутри действия «**Повторять по количеству объектов**» создайте действие «**Проверить результат выражения**» со следующими свойствами:

    - На вкладке «**Основные**»:
        - **Сообщение об ошибке:** _Ошибка отправки вложения_
        - **Выражение: N3**

            ``` turtle
            # Импортируем функции для работы с данными текущего сеанса и переменными
            @prefix object: <http://comindware.com/ontology/object#>.
            @prefix document: <http://comindware.com/ontology/document#>.
            @prefix operator: <http://comindware.com/ontology/session/operator#>.
            @prefix variable: <http://comindware.com/ontology/session/variable#>.

            {
                # Находим атрибут Attachment (Вложение) 
                # в шаблоне DocumentRegistry (Реестр документов).
                ("DocumentRegistry" "Attachment") object:findProperty ?Attachment.
                # Помещаем объект с файлом из ?Attachment в ?AttachmentItem.
                ?item ?Attachment ?AttachmentItem.
                # Помещаем содержимое файла из ?AttachmentItem в ?Content.
                ?AttachmentItem document:content ?Content.
                # Помещаем имя файла из ?AttachmentItem в ?Name.
                ?AttachmentItem document:title ?Name.
            
                # Создаём в сценарии переменную Content и помещаем в неё ?Content
                variable:Content operator:replace ?Content.
                # Создаём в сценарии переменную Name и помещаем в неё ?Name
                variable:Name operator:replace ?Name.
                
                true -> ?value.
            }
            ```

    - На вкладке «**Дополнительно**»:
        - **Сбрасывать кэш значений:** флажок установлен

5. Внутрь действия «**Повторять по количеству объектов**» добавьте действие «**Изменить значения переменных**» со следующими свойствами:

    - На вкладке «**Основные**»:
        - **Операция со значениями переменных: заменить**
        - **Набор переменных:** _Message_
    - На вкладке «**Дополнительно**»:
        - **Сбрасывать кэш значений:** флажок установлен

6. В действии «**Изменить значение переменных**» на вкладке «**Основные**» добавьте переменные:
  
    !!! warning "Создание переменной типа «Объект»"

        Чтобы составить переменную типа «**Объект**» для хранения имени и содержимого файла, необходимо создать структуру из родительской и дочерних переменных:

        - Создайте переменную, присвойте ей **имя**, но оставьте **значение** переменной пустым. Эта переменная будет родительской.
        - Установите флажок у имени родительской переменной в таблице и нажмите кнопку «**Создать**».
        - Дважды нажмите значок <i class="fa-light fa-angle-down anchor"></i> рядом с родительской переменной.
        - В таблице отобразится строка дочерней переменной.
        - Присвойте дочерней переменной **имя** и **значение**.

    
    - _File_ — с дочерними переменными:
        - _Content_ — **значение: формула**

           ``` cs
           $$Content
           ```

        - _Name_ — **значение: формула**

           ``` cs
           $$Name
           ```
        
        Здесь используются переменные `Content` и `Name`, которые были созданы на шаге 4.

7. Внутрь действия «**Повторять по количеству объектов**» добавьте действие «**Отправить сообщение**» со следующими свойствами:

    - На вкладке «**Основные**»:
        - **Подключение:** выберите _[подключение для отправки файлов по HTTP](#настройка-подключения)_.
        - **Путь передачи данных:** выберите _[путь передачи данных для отправки файлов по HTTP](#настройка-пути-передачи-данных)_.
        - **Переменная с сообщением:** _Message_
    - На вкладке «**Дополнительно**»:
        - **Сбрасывать кэш значений:** флажок установлен

8. Внутрь действия «**Повторять по количеству объектов**» добавьте действие «**Проверить результат выражения**» со следующими свойствами:

    - На вкладке «**Основные**»:
        - **Сообщение об ошибке:** _Ошибка очистки переменных_
        - **Выражение: N3**

            ``` turtle
            # Импортируем функции для работы с переменными
            @prefix variable: <http://comindware.com/ontology/session/variable#>.
            @prefix operator: <http://comindware.com/ontology/session/operator#>.
            {
                # Очищаем переменную Message
                variable:Message operator:clear ?item.

                # Возвращаем значение true
                true -> ?value.
            }
            ```

    - На вкладке «**Дополнительно**»:
        - **Сбрасывать кэш значений:** флажок установлен

_![Сценарий отправки вложения с помощью HTTP-запросов](img/http_send_file_scenario.png)_

## Тестирование

1. Создайте запись в шаблоне _«Реестр документов»_.
2. Загрузите файлы в поле _«Вложения»_.
3. Сохраните запись.
4. Нажмите кнопку _«Отправить вложения»_.
5. На сервер, настроенный в _[подключении для отправки файлов по HTTP](#настройка-подключения)_, должен поступить HTTP-запрос, содержащий файлы, прикреплённые к атрибуту _«Вложения»_.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- _[Отправка HTTP-запросов. Настройка подключения][send_http_connection]_
- _[Отправка HTTP-запросов типа GET. Пример: настройка подключения, пути передачи данных и сценария для обработки запросов в формате JSON][send_http_example]_
- _[Действие «Отправить сообщение» в сценарии][scenario_actions_send_message]_

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}
