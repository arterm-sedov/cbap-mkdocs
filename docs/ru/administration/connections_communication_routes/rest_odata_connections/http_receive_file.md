---
title: Получение составного содержимого через HTTP-запросы
kbId:
tags:
    - получение документов по HTTP
    - получение файлов по HTTP
    - составное содержимое
    - файлы
hide:
    - tags
---

# HTTP-запросы с составным содержимым. Получение запросов с файлами {: #http_receive_file }

## Введение

**{{ productName }}** может получать HTTP-запросы из внешних систем с составным содержимым, включая файлы.

Здесь представлен пример настройки подключения, пути передачи данных, шаблона записи и сценария для получения и обработки HTTP-запросов в формате `JSON` с прикреплёнными файлами.

{% include-markdown ".snippets/http_receive_authentication.md" %}

## Прикладная задача

- Имеется шаблон записи _«Картотека»_ с атрибутом _«Файлы»_ типа «**Документ**» и текстовым атрибутом _«Описание»_.
- К каждой записи в _Картотеке_ может быть прикреплено несколько файлов.
- Имеется внешний сервер, отправляющий HTTP-запросы с файлами вида:
    ``` json
    {
    "description":"STRING",
    "files":[
         {
            "name":"STRING",
            "content":"STRING"
        }
    ]
    }
    ```

- Требуется настроить получение с внешнего сервера HTTP-запросов с файлами.
- При получении HTTP-запроса требуется создать запись в _Картотеке_, прикрепить к ней полученные файлы и заполнить _Описание_.

## Настройка подключения

1. На странице «**Администрирование**» выберите пункт «**Инфраструктура**» — «[**Подключения**][connections]» <i fal fa-exchange-alt></i>.
2. Откройте или создайте подключение типа «**Подключения REST и OData**» — «**Получение HTTP-запросов**».
3. Настройте подключение к серверу:

    - **Системное имя** — введите уникальное имя подключения.
        --8<-- "system_name_requirements.md:no_autofill"
    - **Отключить** — установите этот флажок, если требуется временно деактивировать данное подключение.
    - **Описание** — введите наглядное описание подключения, например _«Подключение для получения файлов по HTTP»_.
    - **Запись в файловые журналы** — выберите, какие события следует записывать в журналы:
        - **Полные сведения об обработке сообщения**;
        - **Только ошибки**;
        - **Отключить** — не регистрировать в журнале события получения запросов.
    - **Базовый путь получения HTTP-запросов** — добавьте **путь URI**, например `uploadFiles`. При необходимости введите дополнительный **путь URI** на [вкладке «**Интеграция**» в свойствах пути передачи данных](#интеграция). Укажите результирующий путь на внешнем сервере в качестве получателя запроса, например:

        ```
        https://example.com/api/public/adapter/uploadFiles
        ```

    - **Формат данных** — **JSON**.
    - **Тип аутентификации** — выберите способ проверки подлинности, используемый сервером:
        - **Отсутствует**;
        - **Базовая**;
        - **Аутентификация Windows**.

4. Проверьте соединение с сервером, нажав соответствующую кнопку.
5. При необходимости нажмите кнопку «**Скачать журнал**», чтобы просмотреть журнал событий получения запросов.
6. Сохраните подключение.

## Настройка пути передачи данных

1. Откройте страницу «**Администрирование**» — «**Архитектура**» или страницу «**Администрирование**» приложения.
2. Выберите пункт «[**Пути передачи данных**][communication_routes]» <i class="fa-light fa-route " aria-hidden="true"></i>.
3. Откройте или создайте путь передачи данных типа «**Подключения REST и OData**» — «**Получение HTTP-запросов**».
4. Настройте свойства пути передачи данных на следующих вкладках:

    - [**Основные свойства**](#основные-свойства)
    - [**Атрибуты сообщений**](#атрибуты-сообщений)
    - [**Интеграция**](#интеграция)

5. Сохраните путь передачи данных.

### Основные свойства

На вкладке «**Основные свойства**» настройте параметры использования пути передачи данных:

- **Подключение** — выберите [подключение для получения HTTP-запросов](#настройка-подключения).
- **Системное имя** — введите уникальное имя пути передачи данных.
    --8<-- "system_name_requirements.md:no_autofill"
- **Отключить** — установите этот флажок, если требуется временно деактивировать путь передачи данных.
- **Описание** — введите наглядное описание пути передачи данных, например _«Получение файлов по HTTP»_.
- **Номер шины данных** — выберите номер от 0 до 3, если требуется распределить потоки данных нескольких путей для повышения производительности.

### Атрибуты сообщений

!!! warning "Составление атрибута сообщения типа «Объект»"

    Чтобы составить **атрибут сообщения** типа «**Объект**» для хранения имени и содержимого файла, необходимо создать структуру из родительского и дочерних атрибутов:

    --8<-- "communication_route_message_attribute_object.md"

1. Выберите **тип сообщения** «**Обработка HTTP-запросов с составным содержимым**». Данный тип сообщения позволяет обрабатывать полученные файлы без дополнительного преобразования в раздельные атрибуты с именем и содержимым файла.
2. В таблицу «**Запрос**» добавьте атрибут _FileObject_ типа «**Объект**» — системное имя может быть произвольным. Установите для этого атрибута флажок «**Массив**».
3. В атрибут атрибут _FileObject_ добавьте дочерние атрибуты _name_ и _content_ типа «**Строка**». Системные имена этих атрибутов фиксированные, их нельзя изменять и они должны совпадать с именами соответствующих полей файловой структуры в HTTP-запросе.
4. Добавьте атрибут _Description_ типа «**Строка**».

### Интеграция

1. При необходимости укажите дополнительный суффикс в поле «**Путь URI**». Этот суффикс будет добавлен к URL-адресу в поле «**Базовый путь получения HTTP-запросов**» (совпадает с путём, настроенным в [подключении](#настройка-подключения)). Укажите результирующий адрес на внешнем сервере в качестве получателя запросов, например:

        ```
        https://example.com/api/public/adapter/uploadFiles
        ```

2. В таблицу «**Укажите атрибуты для преобразования составного содержимого запроса**» сопоставьте атрибуты сообщения (**Имя атрибута**) с полями HTTP-запросов (**Имя части составного содержимого**):

    | Имя атрибута | Имя части составного содержимого |
    |---|---|
    | _Description_ | _description_ |
    | _FileObject_ | _files_|

3. В поле «**Возвращаемый формат данных**» укажите «**Составное содержимое**».
4. Остальные поля можно не заполнять.

## Настройка шаблона записи

1. В шаблоне _«Картотека»_ создайте атрибут _«Файлы»_ типа «**Документ**».
2. Добавьте атрибут _«Файлы»_ на форму.

!!! question "Структура атрибута типа «Документ»"

    --8<-- "attribute_document_logic.md"
    --8<-- "attribute_document_get_file_n3.md"
    
## Настройка сценария

1. Создайте сценарий _«Получение документов через HTTP»_.
2. Откройте событие «**Нажатие кнопки**» и настройте его следующим образом:

    - **Тип: получение сообщения**;
    - **Контекстный шаблон:** _Картотека_;
    - **Подключение:** [подключение для получения документов с помощью HTTP-запросов](#настройка-подключения);
    - **Путь передачи данных:** [путь передачи данных для получения документов с помощью HTTP-запросов](#настройка-пути-передачи-данных);
    - **Имя переменной:** _HttpRequest_ — в эту переменную будет сохраняться полученный HTTP-запрос. Имя переменной может быть произвольным.

3. Добавьте действие «**Создать запись**» для **контекстного шаблона** _«Картотека»_.
4. Добавьте действие «**Изменить значение атрибутов**» внутри действия «**Создать запись**» со следующими свойствами:

    **Атрибут:** _Описание_
    - **Операция со значениями: заменить**
    - **Значение: формула**

        ``` cs
        $$HttpRequest->Description
        ```

        Здесь `Description` — имя атрибута для хранения описания файлов, настроенного на [вкладке «**Атрибуты сообщений**» пути передачи данных](#атрибуты-сообщений).

5. Добавьте действие «**Повторять по количеству объектов**» внутри действия «**Создать запись**» со следующими свойствами:

    - **Переменная:** _File_
    - **Атрибут или выражение для поиска объектов: формула**

        ``` cs
        $$HttpRequest—>FileObject
        ```

        Здесь `FileObject` — имя атрибута для хранения полученных файлов, настроенного на [вкладке «**Атрибуты сообщений**» пути передачи данных](#атрибуты-сообщений).

6. Добавьте действие «**Проверить результат выражения**» внутри действия «**Повторять по количеству объектов**» со следующими свойствами:

    - Вкладка «**Основные**»:
        - **Сообщение об ошибке:** _Ошибка получения вложения_
        - **Выражение: N3**

            ``` turtle
            # Импортируем функции для работы
            # с данными текущего сеанса и переменными
            @prefix document: <http://comindware.com/ontology/document#>.
            @prefix variable: <http://comindware.com/ontology/session/variable#>.
            @prefix operator: <http://comindware.com/ontology/session/operator#>.
            @prefix session: <http://comindware.com/ontology/session#>.
            {
                # Находим переменную File из предыдущего действия сценария
                # и помещаем её в локальную переменную ?File
                session:context variable:File ?File.
                # Из ?File достаём содержимое файла
                # и помещаем его в переменную ?FileContent
                ?File variable:content ?FileContent.
                # Из ?File достаём имя файла
                # и помещаем его в переменную ?Filename
                ?File variable:name ?Filename.
                # Помещаем имя и содержимое файла в переменную ?DocumentObject
                (?FileContent ?Filename) document:attach ?DocumentObject.
                # Создаём в сценарии переменную ?Document 
                # и помещаем в неё ?DocumentObject
                variable:Document operator:replace ?DocumentObject.
                # Возвращаем значение true
                true -> ?value.
            }
            ```

        - Вкладка «**Дополнительно**»:
            - **Сбрасывать кэш значений**: флажок установлен

7. Добавьте действие «**Изменить значение атрибутов**» внутри действия «**Повторять по количеству объектов**» со следующими свойствами:

    - **Атрибут:** _Файлы_
    - **Операция со значениями: добавить**
    - **Значение: формула**

        ``` cs
        $$Document
        ```

        Здесь `Document` — имя переменной, в которую мы помещаем объект с файлом с помощью действия «**Проверить результат выражения**».

_![Сценарий получения вложений с помощью HTTP-запросов](img/http_receive_file_scenario.png)_

## Тестирование

1. С внешнего сервера отправьте HTTP-запрос с несколькими файлами, например:

    ``` sh
    curl -u username:password \
        -F "description=Фото и документ" \
        -F "files=@image.jpg" \
        -F "files=@document.docx" \
        https://example.com/api/public/adapter/uploadFiles \
        -v
    ```

    Здесь:

    - `-u username:password` — базовая аутентификация c учётными данными аккаунта с разрешением на **вызовы API** **{{ productName }}**;
    - `-F "description=Фото и документ"` — описание файлов;
    - `-F "files=@image.jpg" -F "files=@document.docx"` — массив из двух файлов;
    - `https://example.com/api/public/adapter/uploadFiles` — **базовый путь получения HTTP-запросов** и **путь URI**, настроенные в [пути передачи данных](#настройка-пути-передачи-данных);
    - `-v` — ключ для вывода отладочных данных (необязательный).

2. Через некоторое время после отправки HTTP-запроса в шаблоне _«Картотека»_ должна появиться новая запись.
3. Откройте эту запись.
4. В поле _«Файлы»_ должны отображаться файлы, полученные с внешнего сервера, и должно быть заполнено _Описание_.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- _[Получение HTTP-запросов с обработкой JSON-запросов][receive_http_example]_
- _[HTTP-запросы типа POST. Отправка составного содержимого и файлов][http_send_file]_
- _[Аккаунты][accounts]_
- _[Системные роли][system_roles]_
- _[Ключи аутентификации API][authentication_keys]_

</div>

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}
