---
title: Подсистема журналирования
kbId: 2501
---

# Подсистема журналирования

## Содержание

- [Введение](#mcetoc_1glgv0qm81)
- [Определения](#mcetoc_1glgv24kf2)
	- [Описание подсистемы журналирования](#mcetoc_1glgviuqt6)
	- [Файловые журналы](#mcetoc_1glgvul1j8)
		- [Правила формирования и архивирования файлов журналов](#mcetoc_1glh017369)
		- [Типы событий в журналах](#mcetoc_1glh07tgk0)
		- [Журнал аудита](#mcetoc_1glh08n4u1)
		- [Журнал интеграции](#mcetoc_1glh0qvus0)
		- [Журнал интеграции с сырыми данными](#mcetoc_1glh15vcr1)
		- [Журнал исправности](#mcetoc_1glh1g5gt0)
		- [Журнал обновления](#mcetoc_1glh1omu51)
		- [Журнал ошибок](#mcetoc_1glh206ht2)
		- [Журнал процессов](#mcetoc_1glh26mce3)
			- [Рекомендации по чтению журнала процессов](#mcetoc_1hv4ivto60)
		- [Журнал резервного копирования](#mcetoc_1glh2ffjs0)
		- [Системный журнал](#mcetoc_1glh2qidv1)
		- [Журналы адаптеров](#mcetoc_1hhm8jm0d4)
	- [Перенаправление сообщений из файлов журналов в журнал событий Windows](#mcetoc_1glgvkqe77)
- [Связанные статьи](#mcetoc_1hhm8cnf50)

## Введение

В этой статье представлено описание работы подсистемы журналирования ПО **{{ productName }}** для операционных систем Linux.

## Определения

**ПО** — программное обеспечение **{{ productName }}**.

**Экземпляр ПО** — развёрнутый веб-сайт на основе ПО.

**Система** — развёрнутый программно-аппаратный комплекс на основе ПО.

### Описание подсистемы журналирования

Подсистема журналирования ПО использует библиотеку *NLog* (с открытым исходным кодом), которая записывает данные в файлы журналов.

Полная документация по настройке *NLog* для журналирования в файлы представлена по адресу: [*https://github.com/NLog/NLog/wiki/File-target*](https://github.com/NLog/NLog/wiki/File-target)

ПО позволяет настроить уровень журналирования, правила формирования событий в журналах, место хранения журналов, порядок и набор параметров именования файлов журналов, а также ограничения по размеру и предельному количеству файлов журналов, с помощью конфигурационных файлов:

- Linux
	- `/var/www``/instanceName/logs.config` — конфигурация всех журналов экземпляра ПО, включая журналы встроенных адаптеров;
	- `/var/www``/instanceName/data/Plugins/Agent/logs.config` — конфигурация журналов пользовательских адаптеров.
- Windows
	- `C:\ProgramData\Comindware\Instances\<instanceName>\``Config\logs.config` — конфигурация всех журналов экземпляра ПО, включая журналы встроенных адаптеров;
	- `C:\ProgramData\Comindware\Instances\<instanceName>\``Config\data\Plugins\Agent\logs.config` — конфигурация журналов пользовательских адаптеров.

Здесь и далее ***`<`****`instanceName`****`>`*** — имя экземпляра ПО.

Подробное описание структуры конфигурационного файла см. в документации *NLog* по адресу: [*https://github.com/NLog/NLog/wiki/Tutorial*](https://github.com/NLog/NLog/wiki/Tutorial)

По умолчанию файлы журналов хранятся на сервере с экземпляром ПО в следующей директории:

- Linux
	- `/var/log/comindware``/instanceName/Logs`
- Windows
	- `C``:\``ProgramData``\``Comindware``\``Instances``\<instanceName>\Logs`

Сведения о фактическом расположении файлов см. в статье: *[Пути и содержимое папок экземпляра ПО](https://kb.comindware.ru/article.php?id=2502)**;*

### Файловые журналы

ПО поддерживает следующие файловые журналы:

- [Адаптеры](#mcetoc_1hhm8jm0d4)
- [Аудит](#mcetoc_1glh08n4u1)
- [Интеграция](#mcetoc_1glh0qvus0)
- [Интеграция — сырые данные](#mcetoc_1glh15vcr1)
- [Исправность ПО](#mcetoc_1glh1g5gt0)
- [Обновление](#mcetoc_1glh1omu51)
- [Ошибки](#mcetoc_1glh206ht2)
- [Процессы](#mcetoc_1glh26mce3)
- [Системный журнал](#mcetoc_1glh2qidv1)
- [Резервное копирование](#mcetoc_1glh2ffjs0)
- Трансфер — в составе журнала [ошибок](#mcetoc_1glh206ht2)

Каждый из перечисленных журналов представляет собой структурированный текстовый файл с пробелами в качестве разделителей.

В качестве инструментов чтения и анализа файлов журналов можно использовать любой инструмент, представленный на рынке. Например, есть мощный инструмент Kibana [*https://www.elastic.co/products/kibana*](https://www.elastic.co/products/kibana), который обладает широким спектром функций по сбору журналов с различных ресурсов и их глубокому анализу с различными визуальными представлениями, в том числе в виде графиков.

#### Правила формирования и архивирования файлов журналов

Каждый журнал (кроме журнала обновления) формируется как один файл на каждый день.

Журнал обновления формируется при выполнении обновления версии ПО и заменяет предыдущий файл журнала обновления.

В конце дня файлы журналов архивируются в папку `\Archive` в архивы вида `CBAP_ГГГГ-ММ-ДД`.

По умолчанию ПО сохраняет в архиве до 5 файлов журнала каждого типа (кроме журнала интеграции с сырыми данными, см. «[Журнал интеграции с сырыми данными](#mcetoc_1glh15vcr1)»), т. е. за день в архиве будет храниться не более 5 файлов каждого журнала, а остальные будут удаляться в очерёдности их создания.

#### Типы событий в журналах

В журналах предусмотрены следующие типы событий:

- `Fatal` — критическая ошибка в работе ПО;
- `Error` — ошибка в работе ПО;
- `Warn` — некорректное поведение, но ПО продолжает свою работу;
- `Info` — обычное событие, например отправка письма, обновление данных аккаунта;
- `Debug` — выполнение запросов, аутентификация пользователей;
- `Trace` — запуск методов, завершение методов.

#### Журнал аудита

Журнал аудита содержит перечисленные ниже события.

- Неуспешные попытки входа в Систему.
- Успешный вход в Систему.
- Выход из Системы.
- Веб-запросы клиента, отправляемые пользователями на сервер (запрос данных или сохранение данных).
- Изменения системных ролей и ролей в приложениях.
- Попытки несанкционированного доступа для просмотра, создания, редактирования и удаления данных в следующих разделах:
	- API
	- Записи, экземпляры процессов, аккаунты
	- Прикреплённые к записям файлы
	- Страницы:
		- Администрирование системы
			- Темы
			- Дизайн страницы входа и регистрации
			- Приложения
			- Разделы навигации
			- Шаблоны
			- Функции
			- Пути передачи данных
			- Аккаунты
			- Группы
			- Системные роли
			- Аудит разрешений аккаунтов
			- Замещение
			- Регистрация и вход
			- Мониторинг
			- Журналы событий
			- Лицензирование
			- Резервное копирование
			- Управление системными службами
			- Подключения
			- Производительность
			- Конфигурация журналирования
			- Глобальная конфигурация
		- Администрирование приложения   
		
			- Шаблоны
			- Роли
			- Разделы навигации
			- Функции
			- Переменные
			- Сценарии
			- Интернет-магазин
			- Интеграции
			- Пути передачи данных
			- Active Directory
			- Аудит разрешений аккаунтов
			- Активность компонентов
			- Управление версиями

Стандартное имя файла журнала аудита: `audit_ГГГГ-ММ-ЧЧ.log`

Журнал сообщений аудита содержит следующие сведения:

- дата события;
- время события;
- тип сообщения;
- ID сеанса;
- имя аккаунта, инициировавшего событие;
- IP-адрес клиента;
- адрес сервера;
- статус обработки запроса;
- длительность обработки запроса;
- запрос или текст сообщения;
- сведения об изменении роли.

![Пример журнала аудита](https://kb.comindware.ru/assets/img_6523a9a86f961.png)

Пример журнала аудита

#### Журнал интеграции

Журнал интеграции содержит информационные сообщения по событиям, возникающим в ходе работы интеграционных сервисов ПО (таких, как подключения и адаптеры).

Стандартное имя файла журнала ошибок: `integration_ГГГГ-ММ-ЧЧ.log`

Журнал интеграции содержит следующие сведения:

- дата события;
- время события;
- тип сообщения;
- ID сеанса;
- имя аккаунта, инициировавшего событие;
- имя сервера;
- порт сервера
- IP-адрес клиента;
- идентификатор интеграции;
- идентификатор подключения;
- текст сообщения.

![Пример журнала интеграции](https://kb.comindware.ru/assets/img_6523aa6dab1b1.png)

Пример журнала интеграции

#### Журнал интеграции с сырыми данными

Журнал интеграции с сырыми данными содержит те же сведения, что журнал интеграции, но с полным содержимым сообщений от внешних систем.

Стандартное имя файла журнала с сырыми данными: `integration_raw_``ГГГГ``-``ММ``-``ЧЧ``.log`

По умолчанию для файла журнала интеграции с сырыми данными установлено ограничение на размер: 100 МБ. В случае превышения заданного размера, имя файла меняется на: `имяжурнала_ГГГГ-ММ.ГГГГММДД.<порядковый номер файла>.log`, а в каталоге журналов создаётся новый файл журнала со стандартным именем.

По умолчанию в архивах хранится максимум 50 файлов журнала интеграции с сырыми данными, т. е. за день в архиве будет храниться не более 50 файлов каждого журнала, а остальные будут удаляться в очерёдности их создания.

Журнал интеграции с сырыми данными содержит следующие сведения:

- дата события;
- время события;
- тип сообщения;
- ID сеанса;
- имя аккаунта, инициировавшего событие;
- адрес сервера;
- порт сервера;
- IP-адрес клиента;
- текст сообщения.

![Пример журнала интеграции с сырыми данными](https://kb.comindware.ru/assets/img_6523ab27a8957.png)

Пример журнала интеграции с сырыми данными

#### Журнал исправности

Журнал исправности содержит сведения о состоянии экземпляра ПО: дисковом пространстве, использовании подключений, работе сервиса Elasticsearch, работе подсистем, выполнении экземпляров процессов.

Стандартное имя файла журнала исправности: `heartbeat_ГГГГ-ММ-ЧЧ.log`

Журнал исправности ПО содержит следующие сведения:

- дата события;
- время события;
- тип сообщения;
- ID сеанса;
- имя аккаунта, инициировавшего событие;
- адрес сервера;
- порт сервера;
- IP-адрес клиента;
- текст сообщения.

![Пример журнала исправности](https://kb.comindware.ru/assets/img_6523ac0110409.png)

Пример журнала исправности

#### Журнал обновления

Журнал обновления содержит сведения о результатах обновления версий ПО.

Стандартное имя файла журнала обновления: `update_ГГГГ-ММ-ЧЧ.log`

Журнал обновления содержит следующие сведения:

- дата события;
- время события;
- тип сообщения;
- ID сеанса;
- имя аккаунта, инициировавшего событие;
- адрес сервера;
- порт сервера;
- IP-адрес клиента;
- текст сообщения.

![Пример журнала обновления](https://kb.comindware.ru/assets/img_6523bcede9f9d.png)

Пример журнала обновления

#### Журнал ошибок

Журнал ошибок содержит данные обо всех ошибках, возникающих в ходе работы экземпляра ПО, а также об [импорте и экспорте версий приложений](https://kb.comindware.ru/category.php?id=447 "Управление версиями приложений").

Стандартное имя файла журнала ошибок: `error_ГГГГ-ММ-ЧЧ.log`

Журнал ошибок содержит следующие сведения:

- дата события;
- время события;
- тип сообщения;
- ID сеанса;
- имя аккаунта, инициировавшего событие;
- имя сервера;
- порт сервера;
- IP-адрес клиента;
- идентификатор события;
- имя подсистемы, в которой произошло событие;
- длительность обработки запроса;
- версия ПО;
- идентификатор интеграции;
- идентификатор подключения;
- сообщение об ошибке.

![Пример журнала ошибок](https://kb.comindware.ru/assets/img_6523bd907bbfc.png)

Пример журнала ошибок

#### Журнал процессов

Журнал процессов содержит сведения о движении токенов по элементам экземпляров процессов.

Стандартное имя файла журнала процессов: `process``_ГГГГ-ММ-ЧЧ.``log`

Журнал процессов содержит следующие сведения:

- дата события;
- время события;
- тип сообщения;
- идентификатор экземпляра процесса;
- идентификатор токена;
- идентификатор элемента экземпляра процесса;
- текст сообщения.

![Пример журнала процессов](https://kb.comindware.ru/assets/img_6523bdc53345b.png)

Пример журнала процессов

##### Рекомендации по чтению журнала процессов

- В журнале процессов отражается факт создания экземпляра процесса с указанием его идентификатора.
- Чтобы журнал процессов содержал более наглядные сведения, при настройке диаграммы процесса давайте элементам понятные системные имена.
- Для элемента диаграммы процесса указываются сведения о трёх событиях:
	- создание токена или вход токена в элемент — строка с идентификатором элемента вида `Enter(psa.XXX) by Flow``:psf.XXX` (при создании токена не указывается идентификатор потока);
	- выполнение элемента — строка с идентификатором элемента вида `Execute` или `ContinueExecute`;
	- выход токена из элемента — строка с идентификатором потока вида `Exit by Flow:psf.XXX`.
- В строке события могут быть указаны следующие сведения:
	- идентификатор экземпляра процесса вида `PID:XXX`;
	- идентификатор токена вида `TID:ptkn.XX`;
	- системное имя и идентификатор элемента вида `(elementSystemName)psa.XXX`;
	- системное имя и идентификатор потока вида `psf.XXX`;
	- идентификатор потока с идентификатором потока вида `Flow:psf.XXX`;
	- перечень последующих элементов, начинающийся с ключевого слова `NextActions`.

#### Журнал резервного копирования

Журнал резервного копирования содержит информационные сообщения по результатам резервного копирования экземпляра ПО.

Стандартное имя файла журнала резервного копирования: `backup_ГГГГ-ММ-ЧЧ.log`

Журнал резервного копирования содержит следующие сведения:

- дата события;
- время события;
- тип сообщения;
- ID сеанса;
- имя аккаунта, инициировавшего событие;
- адрес сервера;
- порт сервера;
- IP-адрес клиента;
- текст сообщения.

![Пример журнала резервного копирования](https://kb.comindware.ru/assets/img_6523be264b66d.png)

Пример журнала резервного копирования

#### Системный журнал

Системный журнал содержит данные о событиях системного уровня в экземпляре ПО.

Стандартное имя файла системного журнала: `system_<год>-<месяц>-<день>.log`

Системный журнал содержит следующие сведения:

- дата события;
- время события;
- тип сообщения;
- ID сеанса;
- имя аккаунта, инициировавшего событие;
- адрес сервера;
- порт сервера;
- IP-адрес клиента;
- текст сообщения.

![Пример системного журнала](https://kb.comindware.ru/assets/img_6523be6b354e4.png)

Пример системного журнала

#### Журналы адаптеров

Журналы адаптеров содержат данные о событиях подключений и путей передачи данных, относящихся к [адаптерам](https://kb.comindware.ru/article.php?id=2181) в экземпляре ПО.

Имена файлов журналов адаптеров формируются следующим образом: 

- сервис встроенных адаптеров: `adapter_internal_``<год>-<месяц>-<день>.log`
- сервис пользовательских адаптеров: `adapter_external_``<год>-<месяц>-<день>.log`
- подключение встроенного адаптера: `adapter_internal_<имя_подключения>_``<год>-<месяц>-<день>.log`
- подключение пользовательского адаптера: `adapter_external_<имя_подключения>_``<год>-<месяц>-<день>.log`

Журнал адаптера содержит следующие сведения:

- дата события;
- время события;
- тип сообщения;
- описание события;
- контекст события;
- описание исключения (необязательно);
- текст сообщения (необязательно).

![Пример журнала аудита](https://kb.comindware.ru/assets/img_657c0f2da2e94.png)

Пример журнала аудита

### Перенаправление сообщений из файлов журналов в журнал событий Windows

Библиотека NLog позволяет записывать журналы помимо файлов в другие хранилища, например в службу «Журнал событий Windows» (EventLog), который можно просмотреть с помощью приложения **Просмотр** **событий**.

Полная документация по настройке журналирования в журнал событий Windows представлена по адресу:

[*https://github.com/NLog/NLog/wiki/EventLog-target*](https://github.com/NLog/NLog/wiki/EventLog-target)

В данном разделе представлены инструкции по перенаправлению сообщений из файла журнала ошибок экземпляра ПО в журнал событий Windows.

1. Создайте в журнале событий Windows новый источник событий (`EventSource`), если его ещё нет.
2. Создайте скрипт по приведённому ниже образцу на языке VisualBasic и сохраните его в файл с расширением .VBS (например, `CreateEventSource.vbs)`:

```
Set Args = WScript.Arguments   
If Args.Count < 1 then WScript.Echo "USAGE: CreateEventSource.vbs <EventSourceName>"   
    WScript.Quit   
End If   
EventSourceName = Args(0)   
Set WshShell = WScript.CreateObject("WScript.Shell")   
'Create event source   
KeyName = "HKLM\SYSTEM\CurrentControlSet\Services\Eventlog\Application\" & EventSourceName & "\EventMessageFile"   
'Change path to .NET Framework version used   
WshShell.RegWrite KeyName,"%windir%\Microsoft.NET\Framework64\v2.0.50727\EventLogMessages.dll", "REG_EXPAND_SZ"
```
3. Запустите скрипт, который создаст источник событий (`EventSource`) в журнале событий Windows.

В качестве параметра передайте название источника событий, которое будет отображаться в разделе «Журналы Windows / Приложение» (Windows Logs / Application) приложения приложении «Просмотр событий».

Пример команды запуска скрипта: `CreateEventSource``.vbs``"CBAP` `"`
4. Создайте в файле `logs.config` в подразделе`nlog.targets` (с конфигурацией файловых журналов) подраздел `target` с параметрами записи данных в журнал событий Windows:

```
<target xsi:type="EventLogCBAPErrors" name="eventlog" layout="${message}"   
log="Application" source="CBAP"/>
```
5. Создайте в файле `logs.config` правило (подраздел `logger`в разделе`nlog.rules`), которое будет определять сообщения, подлежащие записи в журнал событий Windows:

```
<logger name="*" minlevel="Warn" maxlevel="Fatal"   
writeTo="errorsFile,EventLogCBAPErrors"/>
```
6. Перезагрузите экземпляр ПО, чтобы изменения вступили в силу. См. раздел [Настройка конфигурации Утилиты администрирования Comindware](https://kb.comindware.ru/article.php?id=2029).

## Связанные статьи

**[Примеры событий в файловых журналах](https://kb.comindware.ru/article.php?id=2516)**

**[Пути и содержимое папок экземпляра ПО](https://kb.comindware.ru/article.php?id=2502)**

**[Адаптеры](https://kb.comindware.ru/article.php?id=2181)**

[**Просмотр показателей мониторинга с помощью страницы «Администрирование»**](https://kb.comindware.ru/article.php?id=2187)

[**Просмотр журналов событий с помощью страницы «Администрирование»**](https://kb.comindware.ru/article.php?id=2180)

**[Просмотр показателей производительности с помощью страницы «Администрирование»](https://kb.comindware.ru/article.php?id=2184)**

**[Конфигурация журналирования. Настройка, скачивание журналов](https://kb.comindware.ru/article.php?id=2186)**

 [*‌* К началу](#) 

