---
title: Резервное копирование
kbId: 4642
tags:
    - резервная копия
    - S3
    - история
    - восстановление
    - журнал резервного копирования
    - конфигурация резервного копирования
hide: tags
---

# Резервное копирование. Настройка и запуск, просмотр журнала сеансов {: #backup}

## Введение

Для обеспечения высокой доступности и отказоустойчивости системы **{{ productName }}**, включая снижение показателей RTO (время восстановления после сбоя) и RPO (допустимый объём утраченных данных после сбоя) важно надлежащим образом организовать резервное копирование.

Здесь представлены рекомендации по настройке и запуску резервного копирования, а также по просмотру журнала сеансов.

## Инструменты резервного копирования и восстановления **{{ productName }}**

В **{{ productName }}** предусмотрена функция резервного копирования полного образа экземпляра ПО в формате файла с расширением `.CDBBZ`.

При резервном копировании сохраняются все данные всех приложений и все системные настройки экземпляра ПО **{{ productName }}**.

Резервные копии могут храниться как в файловой системе сервера **{{ productName }}**, так и в [хранилище S3][s3_connection].

Резервное копирование можно настраивать и запускать с помощью веб-интерфейса **{{ productName }}**.

Кроме того, в зависимости от требуемого уровня надежности, доступности и отказоустойчивости системы, резервное копирование также можно выполнять средствами виртуализации, файловой системы, Apache Ignite, Elasticsearch и Apache Kafka.

Восстановление данных осуществляется на стороне сервера **{{ productName }}**. См. _«[Восстановление базы данных из файла резервной копии в формате .CDBBZ][backup_restore_cdbbz]»_.

В веб-интерфейсе **{{ productName }}** предусмотрен [журнал сеансов резервного копирования](#просмотр-списка-сеансов-резервного-копирования).

{% if userGuide or kbExport %}
Инструкции по резервному копированию и восстановлению данных встроенными и внешними средствами см. в разделе _«[Резервное копирование и восстановление][backup_and_restore]»_ базы знаний {{ companyName }}.
{% endif %}

## Рекомендации по резервному копированию

Следуя данным рекомендациям, вы сможете обеспечить высокую доступность и отказоустойчивость **{{ productName }}**, непрерывность бизнес-процессов, минимизировать показатели RPO и RTO и снизить риски потери данных.

### Состав, частота создания и срок хранения резервных копий

Для обеспечения оперативного и наиболее полного восстановления данных рекомендуется применять следующие способы резервного копирования:

- **Репликация — непрерывно**:
    - Репликация данных средствами Apache Ignite, Elasticsearch, Apache Kafka и файловой системы NFS, развёрнутых в отказоустойчивой конфигурации (с зеркалированием).
    - Это обеспечивает высокую доступность и сводит к минимуму риск простоев системы.
- **Полное резервное копирование экземпляра ПО — не реже двух раз в неделю**:
    - Создание полной резервной копии в формате `.CDBBZ` встроенными средствами ПО.
    - Резервная копия должна содержать базу данных, скрипты, прикреплённые файлы и историю операций.
    - Рекомендуется хранить такие резервные копии во внешнем репозитории или на отдельном диске для дополнительной защиты.
    - Срок хранения резервных копий: не менее двух недель.
    - Это обеспечивает полное восстановление экземпляра ПО.
- **Создание снимков виртуальных машин — раз в неделю**:
    - Резервное копирование образа всего развёрнутого ПО средствами виртуализации.
    - Рекомендуется сохранять снимок перед любыми изменениями в системе, такими как обновления или изменения конфигурации.
    - Срок хранения резервных копий: не менее трёх месяцев.
    - Это позволяет быстро восстановить систему в случае критического сбоя.
- **Резервное копирование базы данных — не реже раза в день**:
    - Создание резервной копии базы данных в формате `.CDBBZ` встроенными средствами ПО.
    - Срок хранения резервных копий: не менее недели.
    - Рекомендуется настроить два правила резервного копирования:
        - с интервалом не реже раза в день и сроком хранения не менее 10 рабочих дней (2 недели);
        - с интервалом не реже двух раз в день и сроком хранения не менее 5 рабочих дней (1 неделя).
    - Это позволяет минимизировать потери данных в случае сбоя.
- **Актуализация репозитория Elasticsearch — не реже раза в день**:
    - Пополнение репозитория каждого индекса Elasticsearch следует выполнять вместе с резервным копированием базы данных.
    - Это обеспечивает актуальность данных в репозитории и позволяет быстро восстановить индексы в случае сбоя.

### Хранение резервных копий

Для повышения надёжности и минимизации потери данных резервные копии следует помещать одновременно в два хранилища:

- **На машине — на выделенном диске**:
    - Используйте отдельный диск для хранения резервных копий.
    - Это позволяет избежать потери данных при сбое основного диска.
- **Во внешнем репозитории**:
    - Храните копии во внешнем репозитории для дополнительной защиты данных.
    - Это позволяет восстановить систему в случае катастрофического сбоя.

### Дополнительные рекомендации

Для улучшения показателей RTO и RPO можно применить перечисленные ниже инструменты и методы.

- **Мониторинг и оповещение**:
    - Внедрите инструменты мониторинга (например, Zabbix) для отслеживания состояния всех компонентов системы и своевременного оповещения администраторов о возможных проблемах.
- **Регулярное тестирование восстановления**:
    - Периодически проверяйте возможность восстановления системы из резервных копий, чтобы убедиться в их работоспособности.
- **Использование вспомогательных технологий**:
    - При необходимости используйте контейнеризацию и оркестрацию контейнеров (например, Docker и Kubernetes).

### Практики, которых следует избегать

- **Отсутствие регулярного автоматического резервного копирования**:
    - Это может привести к к нерегулярному созданию резервных копий и значительным потерям данных в случае сбоя.
- **Хранение резервных копий не в отдельном хранилище**:
    - В случае отказа этого носителя все резервные копии будут потеряны.

## Просмотр списка и настройка конфигураций резервного копирования

1. В разделе [«**Администрирование**» — «**Инфраструктура**»][administration] выберите пункт «**Резервное копирование**» <i class="fa-light  fa-coins">‌</i>.
2. Отобразится список конфигураций резервного копирования.
3. Нажмите кнопку «**Создать**» или дважды нажмите строку конфигурации в списке.
4. Настройте и сохраните конфигурацию резервного копирования:

    - **Отключить резервное копирование** — установите этот флажок, чтобы прекратить резервное копирование с использованием данной конфигурации.
    - **Название** — введите наглядное наименование конфигурации резервного копирования.
    - **Имя файла** — введите имя файла резервных копий. В процессе резервного копирования к этому имени будут добавляться метка времени в формате `ГГГГММДДЧЧММ` и расширение `CDBBZ`, например для имени файла Backup: `Backup.202202161625.cdbbz`.
    - **Репозиторий для резервных копий** — выберите хранилище для резервных копий:

        - **Не определено** — не использовать репозиторий для хранения резервных копий.
        - **Файловая система** — сохранять резервные копии в файловой системе сервера **{{ productName }}**.
            - **Путь к папке** — путь к директории на сервере, в которой будут сохраняться резервные копии, например `/var/backups/comindware/<instanceName>` (здесь `<instanceName>` — имя экземпляра ПО). Для этой директории предоставьте разрешения на полный доступ, чтобы система могла сохранять в неё резервные копии, например:

                **Astra Linux, Ubuntu, Rocky**

                ``` shell
                chmod 777 /var/backups/comindware/<instanceName>
                chown -R www-data:www-data /var/backups/comindware/<instanceName>
                chown -R www-data:www-data /var/backups/comindware/<instanceName>
                ```

                **Альт Сервер, РЕД ОС**

                ``` shell
                chmod 777 /var/backups/comindware/<instanceName>
                chown -R _nginx:_nginx /var/backups/comindware/<instanceName>
                chown -R _nginx:_nginx /var/backups/comindware/<instanceName>
                ```

                {% include-markdown ".snippets/pdfPageBreakHard.md" %}

        - **Хранилище S3** — сохранять резервные копии во [внешнем сервисе S3][s3_connection].
            - **Имя корзины** — введите имя контейнера в хранилище S3, к котором будут сохраняться резервные копии.

            !!! warning "Внимание!"

                Для резервного копирования в основной и дополнительный репозитории будет использоваться только подключение к S3, заданное в файле конфигурации экземпляра ПО (`/usr/share/comindware/configs/instance/<instanceName>.yml`) с помощью директивы `s3Connection.default`

    - **Дополнительный репозиторий для резервных копий** — выберите хранилище, в которое будут сохраняться дубликаты резервных копий.
    - **С файлами** — установите этот флажок, чтобы включить в состав резервной копии загруженные файлы.
    - **Со скриптами** — установите этот флажок, чтобы включить в состав резервной копии скрипты.
    - **С историей** — установите этот флажок, чтобы включить в состав резервной копии данные Elasticsearch. См. _«[Настройка резервного копирования данных Elasticsearch](#настройка-резервного-копирования-данных-elasticsearch)»_.
    - **Режим запуска**
        - **Вручную** — для запуска резервного копирования потребуется нажимать кнопку «**Запустить копирование**» в [списке конфигураций резервного копирования](#запуск-резервного-копирования).
        - **По расписанию** — резервное копирование будет выполняться по расписанию со следующими параметрами:
            - **Максимум копий** — максимальное количество резервных копий, которые будут храниться в папке на сервере. Укажите значение 0, чтобы хранить все резервные копии.
            - **Периодичность** — частота, с которой будет выполняться копирование.
            - **Интервал**
            {: .pageBreakBefore}
                - **С** — время суток, начиная с которого может выполняться копирование в указанные дни недели.
                - **До** — время суток, вплоть до которого может выполняться копирование в указанные дни недели.
            - **Дни запуска** — дни недели, по которым будет выполняться копирование с указанной периодичностью.
            {% include-markdown ".snippets/pdfEndOfBlockHack.md" %}

_![Настройка свойств резервного копирования](backup_create_config.png)_

## Настройка резервного копирования данных Elasticsearch {: .pageBreakBefore }

Для корректного резервного копирования данных истории необходимо настроить конфигурацию службы Elasticsearch и экземпляра ПО **{{ productName }}**:

- В файле конфигурации Elasticsearch (`/etc/elasticsearch/elasticsearch.yml`) должен быть указан путь к репозиторию резервных копий, например:

    **Для репозитория на локальном диске**

    ``` shell
    # Директория репозитория должна быть доступна экземпляру ПО
    # {{ productName }}
    # При необходимости установите доступ с помощью команды chmod 777
    path.repo: /var/www/backups/elasticsearch
    ```

    **Для репозитория в хранилище S3**

    ``` shell
    s3.client.default.endpoint: localhost:9000
    s3.client.default.protocol: http
    s3.client.default.path_style_access: true
    ```

- В файле конфигурации экземпляра ПО (`/usr/share/comindware/configs/instance/<instanceName>.yml`) необходимо указать тип репозитория резервных копий Elasticsearch (`LocalDisk` или `S3`) и путь к репозиторию, например:

    **Для репозитория на локальном диске**

    ``` shell
    backup.elasticRepository.type: LocalDisk
    # В данном примере Elasticsearch и {{ productName }}
    # работают на одной машине.
    # В противном случае следует примонтировать папку репозитория Elasticsearch
    # на машине с {{ productName }} и указать её в директиве ниже
    backup.elasticRepository.localDisk.path: /var/www/backups/elasticsearch
    ```

    **Для репозитория в хранилище S3**
    {: .pageBreakBefore }

    ``` shell
    # Конфигурация подключения к хранилищу S3, используемого по умолчанию
    s3Connection.default.endpointURL: http://localhost:9000
    s3Connection.default.accessKey: xxxxx
    s3Connection.default.secretKey: xxxxx
    s3Connection.default.pathStyleAccess: true
    s3Connection.default.description: Подключение к S3 по умолчанию

    # Конфигурация репозитория резервных копий Elasticsearch в хранилище S3
    backup.elasticRepository.type: S3
    # Имя корзины в хранилище S3 для хранения резервных копий данных Elasticsearch
    backup.elasticRepository.s3.bucket: <instanceName>-backups
    # Имя подключения к хранилищу S3, используемому по умолчанию
    # на стороне {{ productName }}
    backup.elasticRepository.s3.platformConnection: default
    # Имя подключения к хранилищу S3, используемому по умолчанию на стороне Elasticsearch
    backup.elasticRepository.s3.elasticConnection: default
    ```

## Запуск резервного копирования {: .pageBreakBefore }

1. С помощью флажка выбора выберите одну конфигурацию резервного копирования в списке конфигураций.
2. Нажмите кнопку «**Запустить копирование**». Эта кнопка отображается, только если выбрана одна конфигурация.
3. В фоновом режиме начнется процесс резервного копирования.
4. Прогресс и результат резервного копирования можно просмотреть [в журнале резервного копирования](#просмотр-списка-сеансов-резервного-копирования).

_![Запуск резервного копирования](backup_start.png)_

## Просмотр списка сеансов резервного копирования {: .pageBreakBefore }

1. В разделе [«**Администрирование**» — «**Инфраструктура**»][administration] выберите пункт «**Резервное копирование**» <i class=" fal  fa-coins ">‌</i>.
2. Отобразится список конфигураций резервного копирования.
3. Выберите вкладку «**Журнал**».
4. Отобразится список сеансов резервного копирования со следующими сведениями:

    - **ID** — уникальный идентификатор резервной копии.
    - **Конфигурация** — название конфигурации резервного копирования.
    - **Добавлено в очередь** — дата и время постановки резервной копии в очередь резервного копирования.
    - **Время запуска** — дата и время фактического начала резервного копирования.
    - **Время окончания** — дата и время окончания резервного копирования.
    - **Статус** — текущее состояние резервного копирования.
    - **Размер архива** — размер сохраненной резервной копии.

5. Если отображаются не все ожидаемые сеансы, нажмите кнопку «**Обновить**», чтобы загрузить в список данные о текущих сеансах резервного копирования.

_![Список сеансов резервного копирования](backup_log.png)_

## Удаление конфигурации резервного копирования {: .pageBreakBefore }

1. Выберите подлежащие удалению конфигурации резервного копирования в [списке конфигураций](#просмотр-списка-и-настройка-конфигураций-резервного-копирования).
2. Нажмите кнопку «**Удалить**».
3. Подтвердите удаление резервных копий.
4. Конфигурация резервного копирования будет удалена из списка.
5. Будут безвозвратно удалены сохранённые файлы резервных копий и соответствующие записи [в журнале резервного копирования](#просмотр-списка-сеансов-резервного-копирования).

## Удаление сеанса резервного копирования и резервной копии

1. Выберите один или несколько сеансов в [списке сеансов резервного копирования](#просмотр-списка-сеансов-резервного-копирования).
2. Нажмите кнопку «**Удалить**».
3. Подтвердите удаление сеансов резервного копирования.
4. Выбранные сеансы резервного копирования будут удалены из журнала резервного копирования.
5. Соответствующие файлы резервных копий будут удалены из хранилища.

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- _[Хранилище S3. Настройка экземпляра ПО и подключения][s3_connection]_
- _[Восстановление базы данных из файла резервной копии в формате .CDBBZ][backup_restore_cdbbz]_
{% if adminGuide or kbExport %}
- _[Резервное копирование и восстановление][backup_and_restore]_*
{% endif %}

</div>

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}
