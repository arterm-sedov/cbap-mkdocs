---
title: Урок 7. Автоматические вычисления
kbId: 4872
---

# Урок 7. Автоматические вычисления {: #lesson_7 }

## Введение

В ходе этого урока вы научитесь настраивать вычисляемые атрибуты и использовать язык формул, чтобы сделать данные в заявках более наглядными и повысить эффективность бизнес-процессов.

**Предусловие:** пройден [Урок 6. Усовершенствованный процесс][lesson_6].

**Расчётная продолжительность:** 20 мин.

{% include-markdown ".snippets/tutorial_version_notice.md" %}

## Автоматическое вычисление значений атрибутов

У заявок обычно есть номер и дата. Также в ходе рассмотрения заявки интересно знать, кто является _Заказчиком_ — в том числе исходя из этого будет приниматься решение, выделять машину или нет. Дата заявки — это дата запуска процесса, системный атрибут, значение которому присваивается автоматически. Имя _Заказчика_ также является системным атрибутом, нам надо только вынести эти атрибуты на форму. Для номера же заявки мы определим шаблон, по которому он будет формироваться автоматически.

## Отображение Ф. И. О. заказчика и даты создания заявки

Участникам процесса было бы полезно знать, кто является _Заказчиком_ и когда была подана заявка. Эта информация сохраняется автоматически при создании заявки в системных атрибутах «**Создатель**» и «**Дата создания**».

1. Перейдите на вкладку «**Формы**» шаблона записи _«Заявки на автомобили»._
2. Откройте конструктор формы _«Заявки на автомобили - Основная форма»._
3. Разверните атрибут «**Создатель**» на панели элементов и перетащите на макет формы атрибут «**Ф. И. О.**».
4. Перетащите на макет формы атрибут «**Дата создания**».
5. Сохраните форму.

_![Добавление атрибутов на форму заявки на автомобиль](https://kb.comindware.ru/assets/img_624451d18750c.png)_

## Вычисление суммы затрат

Настроим автоматическое вычисление итоговой суммы затрат. Для этого мы изменим свойства атрибута «Итоговая сумма затрат», установив флажок «**Вычислять по выражению**», затем добавим формулу для автоматического вычисления значения атрибута. Для составления формулы мы воспользуемся редактором выражений и предиктивным вводом…

!!! warning "Внимание!"

    В формулах необходимо указывать те системные имена, которые вы фактически использовали в своём приложении.

    Например, если вы присвоили шаблону _«Затраты»_ системное имя `Затраты123`, то именно это имя следует использовать в формуле.

    То есть, если системные имена, приведённые в уроках, не совпадают с фактическими системными именами в вашем приложении, используйте фактические системные имена, а не копируйте их из текста уроков.

1. Перейдите к диаграмме бизнес-процесса _«Заказ автотранспорта»_ и нажмите кнопку «**Редактировать**».
2. Выберите задачу _«Выполнить рейс»._
3. В меню элемента нажмите кнопку «**Форма**» <i class="fa-light fa-newspaper">‌</i>.
4. В конструкторе формы разверните элемент _«Заявки на автомобили»_ на панели элементов.
5. Нажмите кнопку «**Редактировать**» <i class="fa-light fa-pencil">‌</i> у атрибута _«Итоговая сумма затрат»._
6. В окне свойств атрибута установите флажок «**Вычислять по автоматически**».
7. В поле «**Вычисляемое выражение**» нажмите кнопку «**Открыть в редакторе**»  <i class="fa-light fa-pencil">‌</i>.
8. В редакторе выражений введите функцию: `SUM()`.
9. Установив курсор внутри скобок функции `SUM()`, нажмите клавиши ++ctrl+space++ (Windows и Linux) или ++cmd+space++ (macOS).
10.  В отобразившемся раскрывающемся списке дважды нажмите пункт `Затраты` со значком <i class="fa-light fa-list-alt">‌</i>.

    _![Вставка заготовки запроса from-where-select для шаблона «Затраты» в качестве аргумента функции SUM()](https://kb.comindware.ru/assets/img_6475bdea9fe53.png)_

11. В формулу будет вставлена заготовка запроса записей из шаблона _«Затраты»_: `from a in db->Затраты where Ваше условие select a->id`.

    _![Заготовки запроса from-where-select для шаблона «Затраты»](https://kb.comindware.ru/assets/img_6475be3fe5eb3.png)_

12. Замените строку `Ваше условие` на `a->` и нажмите клавиши ++ctrl+space++ (Windows и Linux) или ++cmd+space++ (macOS).
13. В отобразившемся раскрывающемся списке дважды нажмите пункт `Заявка`. В формулу будет вставлено системное имя атрибута `Заявка` шаблона _«Затраты»._

    _![Вставка в выражение системного имени атрибута «Заявка» шаблона «Затраты»](https://kb.comindware.ru/assets/img_6475c309be5f9.png)_

14. После системного имени `Заявка` введите строку `== $`.
15. В отобразившемся раскрывающемся списке дважды нажмите пункт `id`. в формулу будет вставлено системное имя `id` атрибута _«ID»_ текущего шаблона _«Заявки на автомобили»._

    _![Вставка в выражение системного имени атрибута «ID» шаблона «Заявки на автомобили»](https://kb.comindware.ru/assets/img_6475c34222af8.png)_

16. Удалите строку `id` после оператора `a->` и нажмите клавиши  ++ctr+space++.
17. В отобразившемся раскрывающемся списке дважды нажмите пункт `Сумма`. в формулу будет вставлено системное имя атрибута `Сумма` шаблона _«Затраты»_.

    _![Вставка в выражение системного имени атрибута «Сумма» шаблона «Затраты»](https://kb.comindware.ru/assets/img_6475c37aca216.png)_

18. Получится формула `SUM(from a in db->Затраты where a->Заявка == $id select a->Сумма)`.

    Здесь `Затраты` — шаблон записи «Затраты»; `Заявка` — атрибут типа «**Запись**» шаблона «Затраты», `$id` — идентификатор заявки, `Сумма` — атрибут шаблона «Затраты».

19. Нажмите кнопку «**Применить**» и кнопку ‌.

    _![Формула для вычисляемого числового атрибута](https://kb.comindware.ru/assets/img_6475c4ba0c537.png)_

20. В окне свойств атрибута _«Итоговая сумма затрат»_ нажмите кнопку «**Сохранить**».

    _![Сохранение атрибута «Итоговая сумма затрат»](https://kb.comindware.ru/assets/img_6475c693a645c.png)_

21. Вернитесь к диаграмме бизнес-процесса и нажмите кнопку «**Опубликовать**».

!!! question "Определения"

    - Для вычисления итоговой суммы затрат мы использовали функцию — `SUM()`:
        - `SUM(from a in db->Затраты where b->Заявка == $id select a->Сумма)`
        - Функция `SUM()` принимает в качестве аргумента список значений и возвращает сумму их значений (число).
    - В функцию `SUM()` мы передаём список значений атрибута _«Сумма»_ шаблона записи _«Затраты»_, сформированный с помощью следующего запроса:
        - `from a in` — объявление локальной переменной `a`;
        - `db->Затраты` — объявление шаблона записи «Затраты» в качестве источника данных;
        - `where a->Заявка == $id` — выбор записи, у которой значение атрибута «Заявка» типа «**Запись**» равно идентификатору текущей заявки, то есть выбор только тех затрат, которые относятся к данной заявке;
        - `select a->Сумма` — выбор значений атрибута «Сумма».
    - Данную формулу можно составить двумя другими способами:
        - `SUM(from a in $Затраты select a->Сумма)` — здесь в качестве источника данных запроса указан атрибут «Затраты» типа «**Запись**», который содержит идентификаторы записей шаблона _«Затраты»_, связанные с текущей заявкой;
        - `SUM($Затраты->Сумма)` — здесь мы напрямую передаем в функцию `SUM()` значения атрибута _«Сумма»_, записей шаблона _«Затраты»_, связанных с текущей заявкой.

!!! note "Примечание"

    Подробные сведения о составлении формул см. в разделе _«[Язык формул][formula_guide]»._

## Тестирование вычисления суммы затрат

1. Перейдите к списку экземпляров шаблона процесса _«Заказ автотранспорта»_ и нажмите кнопку «**Создать**».
2. Пройдите процесс до задачи _«Выполнить рейс»_.
3. Откройте задачу _«Заказ автотранспорта — Выполнить рейс»_ и заполните таблицу затрат — укажите различные суммы и типы затрат.

Поле «Итоговая сумма затрат» должно вычисляться автоматически:

_![Автоматическое вычисление итоговой суммы затрат](https://kb.comindware.ru/assets/img_62445bc9bea52.png)_

## Формирование номера заявки

Настроим автоматическую нумерацию заявок…

1. Перейдите на вкладку «**Атрибуты**» шаблона записи _«Заявки на автомобили»._
2. Добавьте новый текстовый атрибут _«Номер заявки»_. Установите флажок «**Использовать как заголовок записей**». Сохраните атрибут.
3. Перейдите к диаграмме процесса _«Заказ автотранспорта»_ и нажмите кнопку «**Редактировать**».
4. Выберите начальное событие и с помощью меню элемента откройте «**Сценарий на выходе**».

    _![Переход к сценарию на выходе начального события с диаграммы бизнес-процесса](https://kb.comindware.ru/assets/img_6311e7a1f306c.png)_

5. Отобразится конструктор сценария.
6. Внутри действия «**Сменить контекст**» нажмите кнопку «Добавить действие» _‌_  и в раскрывающемся меню выберите пункт «**Изменить значения атрибутов**».

    _![Создание действия «Изменить значения» в сценарии](https://kb.comindware.ru/assets/img_6311e89d84bc5.png)_

7. Внутри действия «**Сменить контекст**» будет создано действие «**Изменить значения атрибутов**».
8. В правой части заголовка элемента «**Изменить значения атрибутов**» нажмите кнопку «**Изменить**».

    _![Переход к настройке действия «Изменить значения атрибутов»](https://kb.comindware.ru/assets/img_63ff0a6613aae.png)_

9. Отобразится окно «**Действие: Изменить значения атрибутов**».
10. Нажмите кнопку «**Создать**».
11. В столбце «**Атрибут**» выберите атрибут «**Номер заявки».**
12. В столбце «**Операция со значениями**» выберите пункт «**Заменить**».
13. В столбце «**Значение**» выберите пункт «**Формула**».

    _![Добавление операции с атрибутом для действия «Изменить значения»](https://kb.comindware.ru/assets/img_6311e9c30eab5.png)_

14. Нажмите поле в столбце «**Значение**». Отобразится компактный редактор формулы.
15. Ведите формулу: `FORMAT("ЗA-{0}",LIST(COUNT(from b in db->Заявкинаавтомобили select b->id)))`. Нажмите кнопку с зеленым флажком.

    Здесь:

    - `FORMAT()` — функция, которая принимает в качестве аргументов строку и список, подставляет в первый аргумент значения из второго аргумента и возвращает строку.
    - `COUNT()` — функция, которая принимает аргумент-список и возвращает количество элементов в нём.
    - `Заявкинаавтомобили` — это системное имя шаблона записи _«Заявки на автомобили»._

    _![Формула для вычисления номера заявки](https://kb.comindware.ru/assets/img_6311eaa77ae77.png)_

16. Нажмите кнопку «**Сохранить**», чтобы сохранить действие  «**Изменить значения атрибута**».
17. Вернитесь к диаграмме процесса и опубликуйте её.

    _![Добавление выражения для изменения значения атрибута «Номер заявки» при выходе из начального события](https://kb.comindware.ru/assets/img_6311ea7e9db00.png)_

## Настройка отображения номера заявки

Настроим отображение номера заявки на форме заявки…

1. Перейдите на вкладку «**Формы**» шаблона записи _«Заявки на автомобили»._
2. Откройте конструктор формы _«Заявки на автомобили — Основная форма»_ и добавьте на нее поле «Номер заявки».
3. Укажите для этого поля режим **доступа** «**Только чтение**» и сохраните форму.

    _![Добавление атрибута «Номер заявки» только для чтения на форму заявки на автомобиль](https://kb.comindware.ru/assets/img_6311edd5e3b9f.png)_

## Тестирование формирования номера заявки

1. Перейдите к списку экземпляров шаблона процесса _«Заказ автотранспорта»._
2. Создайте новую заявку на автомобиль.
3. Перейдите в раздел «**Мои задачи**» и откройте форму задачи _«Заказ автотранспорта — Рассмотреть заявку»_. Поле _«Номер заявки»_ должно быть заполнено автоматически:

_![Автоматически сформированный с помощью выражения номер заявки](https://kb.comindware.ru/assets/img_6311fce3e2454.png)_

## Статус заявки

Настроим автоматическое изменение статуса заявки. Статусы заявок будут храниться в справочнике, поэтому сначала мы создадим справочник статусов заявок…

1. На панели навигации выберите пункты «**Настройки**» — «**Диаграммы**».
2. Откройте диаграмму _«Модель данных — Заказ автотранспорта»._
3. Перетащите на диаграмму элемент «**Новый шаблон записи**» и создайте шаблон записи _«Статусы заявок»._
4. Выберите созданный шаблон _«Статусы заявок»_ и добавьте атрибут _«Название»_ с установленным флажком _«**Использовать как заголовок записей**»_.
5. С помощью меню элемента перейдите на вкладку «**Таблицы**» шаблона _«Статусы заявок»._

    _![Диаграмма модели данных — создание нового шаблона записи, добавление в него атрибута и переход к настройке таблиц](https://kb.comindware.ru/assets/img_6244771f73e47.png)_

6. Откройте конструктор таблицы «**Все записи**» и настройте отображение в ней только столбца _«Название»._
7. Сохраните таблицу.

    _![Настройка отображения справочника «Статусы заявок»](https://kb.comindware.ru/assets/img_6311ee3a25a37.png)_

8. Откройте конструктор формы шаблона _«Статусы заявок»_ и настройте её так, чтобы она содержала поле _«Название»._

    _![Настройка формы «Статус заявки»](https://kb.comindware.ru/assets/img_6311ee9f0a26c.png)_

9. Перейдите к списку экземпляров шаблона _«Статусы заявок»_ и создайте записи со следующими названиями: _«Создана», «На рассмотрении», «Завершена», «Отклонена», «Выполняется»._

    _![Заполненный справочник «Статусы заявок»](https://kb.comindware.ru/assets/img_6244792133664.png)_

10. Вернитесь к диаграмме модели данных и выберите шаблон _«Заявки на автомобили»._

11. С помощью меню элемента создайте атрибут _«Статус»_ типа «**Запись**», укажите **связанный шаблон** _«Статусы заявок»_. Сохраните атрибут.

    _![Представление связей на диаграмме модели данных](https://kb.comindware.ru/assets/img_62447a31402e8.png)_

**Теперь настроим автоматическое изменение статуса заявки…**

1. Перейдите к диаграмме бизнес-процесса _«Заказ автотранспорта»_ и нажмите кнопку «**Редактировать**».
2. Выберите начальное событие и с помощью меню элемента откройте «**Сценарий на выходе**».
3. Внутри действия «**Сменить контекст***»* нажмите кнопку «**Изменить**» в заголовке действия «**Изменить значения атрибутов**»,  [созданного ранее](#Step6ChangeAttributeValues).

    _![Переход к настройке действия «Изменить значения атрибутов»](https://kb.comindware.ru/assets/img_63ff0873b8edd.png)_

4. Создайте операцию «**Заменить**» с атрибутом _«Статус»_.
5. В столбце «**Значение**» выберите пункт «**Формула**».
6. Нажмите поле в столбце «**Выражение**». Отобразится компактный редактор формулы.
7. Введите формулу: `OBJECT("Управлениеавтопарком","Статусызаявок","Название","Создана")`. Нажмите кнопку с зеленым флажком.

    Здесь:

    - `OBJECT()`— функция, возвращающая ID записи по указанному пути к ней.
    - `Управлениеавтопарком`— системное имя приложения _«Управление автопарком»._
    - `Статусызаявок`— системное имя шаблона записи _«Статусы заявок»._
    - `Название`— это системное имя атрибута _«Название»_ в шаблоне записи _«Статусы заявок»._
    - `Создана`— искомое значение атрибута _«Название»_ в шаблоне записи _«Статусы заявок»._

    _![Настройка операции изменения атрибута «Статус» при выходе из начального события](https://kb.comindware.ru/assets/img_6311f70a13643.png)_

8. Нажмите кнопку «**Сохранить**», чтобы сохранить действие  «**Изменить значения атрибутов**».
9. Вернитесь к диаграмме процесса, но не публикуйте её.
10. Теперь после создания заявки она получит статус _«Создана»._

**Аналогичным образом настройте автоматическое изменение статуса для других элементов процесса…**

Если диаграмма бизнес-процесса открыта не в режиме редактирования нажмите кнопку «**Редактировать**».

1. Выберите задачу _«Рассмотреть заявку»_ и с помощью меню элемента откройте «**Сценарий на выходе**».
2. Добавьте действие «**Изменить значения атрибутов**» внутри действия «**Сменить контекст**».
3. В действии «**Изменить значения атрибутов**» создайте операцию «**Заменить**» для атрибута «Статус» и формулой: **`OBJECT("Управлениеавтопарком","Статусызаявок","Название","На рассмотрении")`.**
4. Выберите задачу «Отменить поездку» и с помощью меню элемента откройте «**Сценарий на входе**».
5. Добавьте действие «**Изменить значения атрибутов**» внутри действия «**Сменить контекст**»   с операцией «  ***Заменить***» для атрибута «Статус» и формулой: **`OBJECT("Управлениеавтопарком","Статусызаявок","Название","Отклонена")`.**
6. Выберите **развилку «и»** перед событиями _«Совершить поездку»_ и _«Выполнить рейс»_ и настройте для нее «**Сценарий на выходе**»: статус заявки должен принимать значение _«Выполняется»._
7. Настройте «**Сценарий на входе**» для конечного события после выполнения рейса так, чтобы статус заявки принимал значение _«Завершена»._
8. Опубликуйте диаграмму бизнес-процесса, чтобы изменения вступили в силу.

## Настройка отображения статуса и номера заявки

Мы добавили новый атрибут _«Статус»,_ теперь необходимо настроить его отображение в списке записей и на экранной форме…

1. Перейдите на вкладку «**Формы**» шаблона записи _«Заявки на автомобили»._
2. Откройте конструктор формы _«Заявки на автомобили — Основная форма»._
3. Упорядочьте поля на форме с помощью столбцов.
4. Перетащите на форму поле _«Статус»_ и укажите **режим доступа** « **Только чтение**».
5. Сохраните форму.

    _![Добавление атрибута «Статус» на форму заявки на автомобиль](https://kb.comindware.ru/assets/img_6244b24153def.png)_

Настроим отображение реестра (шаблона записи) _«Заявки на автомобили»_…

1. Перейдите на вкладку «**Таблицы**» шаблона «Заявки на автомобили» и добавьте в таблицу «**Все записи**» столбцы _«Номер заявки»_ и _«Статус»_.
2. Сохраните таблицу.

_![Добавление в таблицу столбцов с атрибутами шаблона записи](https://kb.comindware.ru/assets/img_6311f7d4466fd.png)_

## Тестирование изменения статуса заявки

1. Перейдите к списку экземпляров шаблона процесса _«Заказ автотранспорта»_ и создайте новую заявку на автомобиль.
2. Перейдите в раздел «**Мои задачи**» и откройте форму задачи _«Заказ автотранспорта — Рассмотреть заявку»_. Поле _«Статус»_ должно быть заполнено автоматически.

_![Автоматическое заполненное с помощью справочника поле статуса заявки](https://kb.comindware.ru/assets/img_6311fa07dd4e7.png)_

## Настройка заголовка задачи

По умолчанию заголовки задач недостаточно информативны — они содержат только названия процесса и задачи, но никакой конкретной информации по заявке:

_![Представление списка задач по умолчанию](https://kb.comindware.ru/assets/img_6244b8f8f059a.png)_

Настроим заголовки задач, чтобы в списке задач отображались не названия процессов, а содержательная информация — маршрут и Ф. И. О. создателя.

1. Перейдите к диаграмме бизнес-процесса и нажмите кнопку «**Редактировать**».
2. Выберите задачу _«Рассмотреть заявку»._
3. В меню элемента нажмите кнопку «**Свойства**» <i class="fa-light fa-gear">‌</i>.

    _![Переход к свойствам задачи с диаграммы бизнес-процесса](https://kb.comindware.ru/assets/img_6244b9fae6bf1.png)_

4. В окне «**Свойства пользовательской задачи**» на вкладке «**Дополнительные**» выберите пункт «**Формула**» в поле «**Заголовок задачи**».
5. Введите формулу: `FORMAT("Рассмотреть заявку ({0} — {1})",LIST($Маршрут,$_creatorRef->fullName))`.

    Здесь:

    - `$Маршрут` — системное имя атрибута _«Маршрут»._
    - `$_creatorRef->fullName` — имя пользователя, создавшего заявку.
    - `$FORMAT` — функция, подставляющая в строку в первом параметре значения из последующих параметров.
    - `$LIST`— функция, возвращающая массив значений атрибутов, указанных во входных параметрах.

6. Нажмите кнопку «**Сохранить**».

    _![Ввод выражения для вычисляемого заголовка задачи](https://kb.comindware.ru/assets/img_6475d2aaba009.png)_

7. Аналогичным образом введите формулы для заголовков остальных задач процесса:

    - `FORMAT("Принять заявку ({0} — {1})",LIST($Маршрут,$_creatorRef->fullName))`
    - `FORMAT("Отменить поездку, заявка отклонена ({0} — {1})",LIST($Маршрут,$_creatorRef->fullName))`
    - `FORMAT("Выполнить рейс ({0} — {1})",LIST($Маршрут,$_creatorRef->fullName))`
    - `FORMAT("Совершить поездку, машина выделена ({0} — {1})",LIST($Маршрут,$_creatorRef->fullName))`

8. Опубликуйте диаграмму бизнес-процесса.

## Тестирование

Посмотрим, как теперь задачи отображаются в списке…

1. Перейдите к экземплярам шаблона процесса _«Заказ автотранспорта»_ и запустите процесс, создав новую заявку на автомобиль и заполнив стартовую форму.
2. Перейдите в раздел «**Мои задачи**» и откройте задачу _«Рассмотреть заявку»._ Теперь заголовок задачи в списке и в форме содержит название маршрута и Ф. И. О. создателя заявки:

_![Сформированный с помощью выражения наглядный заголовок задачи](https://kb.comindware.ru/assets/img_631205abbb1d4.png)_

_![Сформированный с помощью выражения наглядный заголовок задачи](https://kb.comindware.ru/assets/img_6312052ae43a9.png)_

## Результаты

Вы научились делать автоматические вычисления в ходе процесса.

В  [следующем уроке][lesson_8]  вы настроите пользователей, роли и права доступа для вашего бизнес-приложения.

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}
