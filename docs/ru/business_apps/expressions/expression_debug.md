---
title: Отладка формул, выражений N3, сценариев и скриптов
kbId:
tags:
    - формулы
    - формула
    - выражение
    - выражения
    - проверка формулы
    - проверка выражения
    - скрипт
    - проверка скрипта
hide:
    - tags
---

# Отладка формул, выражений N3, сценариев и скриптов

## Введение

Атрибуты, сценарии, вызов процессов, задачи, фильтры, кнопки и правила на форме можно настроить c помощью формул, выражений N3 и C#-скриптов. Однако при их составлении могут возникнуть проблемы различного рода, например:

- ошибки в именах функций, атрибутов, шаблонов и переменных;
- синтаксические ошибки;
- ошибки в логике построения формулы, выражения или скрипта;
- неправильный тип данных вычисляемого атрибута, аргументов или возвращаемых значений.

Здесь представлены методы проверки и отладки, позволяющие обнаружить и исправить ошибки в формулах, выражениях и скриптах.

## Проверка с помощью редактора выражений

Чтобы выявить ошибки в именах функций, атрибутов, шаблонов и переменных, а также в синтаксисе формулы, выражения N3 или скрипта, используйте функцию проверки в **[редакторе выражений][expression_editor]**.

!!! warning "Внимание!"

    Компактный редактор выражений не проверяет ошибки и сохраняет формулы, выражения N3 и скрипты даже при наличии ошибок.

!!! note "Примечание"

    Полный редактор выражений перед сохранением выполняет проверку формул, выражений N3 и скриптов и позволяет сохранить их только без ошибок.

### Порядок проверки

1. Откройте формулу, выражение N3 или скрипт в полном редакторе выражений и нажмите кнопку «**Проверить**».
2. На вкладке «**Ошибки**» отобразятся выявленные синтаксические ошибки и ошибки в именах функций, атрибутов, шаблонов или переменных.
3. Устраните ошибки и снова выполните проверку.
4. Сохраните формулу, выражение N3 или скрипт, если ошибки отсутствуют.

## Отладка формул и N3 с помощью вспомогательного атрибута

Если редактор выражений не выявляет ошибки в формуле или выражении N3, а результат вычисления не соответствует ожидаемому, протестируйте формулу или выражение N3 посредством вспомогательного атрибута.

Это особенно актуально для правил на форме и сценариев, результат выполнения которых визуально не отображается.

### Пример

1. Создайте отладочный **вычисляемый атрибут** с типом данных, который соответствует результату вычисления проверяемой формулы или выражения N3.

    !!! tip "Совет"

        Если вы не знаете, какой тип атрибута подходит, создавайте текстовый атрибут.

2. Введите формулу или выражение N3 в поле «**Вычисляемое значение**».
3. Поместите атрибут на форму.
4. Создайте запись или экземпляр процесса и посмотрите, какие данные отобразятся в поле атрибута.
5. Чтобы получить ожидаемое значение атрибута, скорректируйте формулу или выражение N3.
6. Чтобы удостовериться в работоспособности формулы или выражения N3, некоторые части можно заменять на литералы.
7. Чтобы быстрее найти ошибки, по возможности разбейте формулу или выражение N3 на самостоятельные части и протестируйте их по очереди.
8. Если самостоятельные части формулы или выражения N3 вычисляются правильно, но при объединении отрабатывают некорректно (например, из-за ошибок приведения типов данных, использовании предиката `assert` или неожиданном поведении комбинированного выражения), можно воспользоваться следующим подходом:

    - создайте промежуточные атрибуты требуемых типов, вычисляемые по корректным частям формулы или выражения N3;
    - используйте значения промежуточных атрибутов в итоговой формуле или выражении N3;
    
    Это позволит не только декомпозировать сложные вычисления, но и комбинировать формулы и выражения N3 оптимальным образом.

## Приведение типов данных

Для преобразования текстовых значений в логические и числовые в формулах можно использовать функции `BOOL()` и `DECIMAL()`.

Это может потребоваться, например, если при импорте данных из Excel числовые и логические значения были помещены в текстовые атрибуты, которые необходимо использовать в вычислениях.

!!! question "BOOL()"

    - `BOOL(string)` преобразует строку в логическое значение.
    - В качестве аргумента `BOOL()` принимает текстовый атрибут или строку со значением `true` или `false` (без учёта регистра). При неподходящих значениях атрибута (0, 1, истина, ложь и т. п.) функция возвращает пустоту.

!!! question "DECIMAL()"

    - `DECIMAL(string)` преобразует строку в число.
    - В качестве аргумента `DECIMAL()` принимает текстовый атрибут или строку с числовым значением (например, 10, 10,5, 10 000 для русского языка или 10, 10.5, 10,000 — для английского, т. е. значение интерпретируется в соответствии с языком текущего пользователя). При неподходящих значениях атрибута (1 р., $50 и т. п.) функция возвращает пустоту.

### Пример

1. Создайте атрибут _AmountText_ типа «**Текст**».
2. Создайте атрибут _AmountNumber_:

    - **Тип данных: число**
    - **Вычислять автоматически:** флажок установлен
    - **Вычисляемое значение: формула**

    ```
    `DECIMAL($AmountText)`.
    ```

3. Поместите атрибуты на форму.
4. Введите в поле _AmountText_ значение `10500`, в поле _AmountNumber_ должно отобразиться значение `10 500`.
5. Введите в поле _AmountText_ значение `10,500`, в поле _AmountNumber_ должно отобразиться значение `10,5`.
6. Введите в поле _AmountText_ значение `10.500`, в поле _AmountNumber_ должно отобразиться `-`.

## Отладка формул с помощью функции VALUE()

Обычно функцию `VALUE()` используют для присвоения значений по умолчанию, чтобы предотвратить выборку пустых значений.

`VALUE()` также можно использовать для отладки других формул, возвращая отладочное значение (например, сообщение об ошибке), если проверяемая формула не выдаёт требуемый результат.

!!! question "VALUE()"

    - `VALUE(argument, [defaultValue])` принимает два аргумента: проверяемое выражение и значение по умолчанию.
    - `VALUE()` возвращает значение первого аргумента, если оно не пустое и не равно `NULL`, в противном случае возвращает значение второго аргумента.

### Пример

1. Создайте атрибут _Amount_ типа «**Число**».
2. Создайте атрибут _AmountValidation_:

    - **Тип данных: текст**
    - **Вычислять автоматически:** флажок установлен
    - **Вычисляемое значение: формула**

    ``` cs
    VALUE($Amount, "Не заполнено поле Amount")
    ```

3. Поместите атрибуты на форму.
4. Если в поле _Amount_ не ввести значение, то в поле _AmountValidation_ отобразится текст _«Не заполнено поле Amount»_.

## Отладка выборок

!!!question "Выборка"

    Выборка — список значений, отвечающих некоторым условиям. Часто выборки формируются с помощью запросов типа `from a in db`.

Если в формуле или выражении N3 используется выборка, которая должна возвращать один элемент, используйте функции `FIRST()` или `once{}.`, чтобы предотвратить ошибки, когда выборка вернет несколько элементов. 

Если после ограничения выборки выражение возвращает ожидаемый результат, попробуйте конкретизировать выборку с помощью условий, например, `where`.

!!! question "FIRST()"

    - `FIRST(list)` принимает в качестве аргумента список значений.
    - `FIRST()` возвращает первый элемент из списка. При отсутствии элементов в списке возвращает пустоту.

!!! question "once{}."

    `once{}.` — конструкция, которая завершает цикл после первой успешной итерации.

## Отладка C#-скриптов

Для поиска ошибок в C#-скриптах можно воспользоваться конструкцией `try-catch`, которая позволяет перехватить исключения.

!!! question "try-catch"

    `try-catch` — конструкция, которая используется для обработки исключений (ошибок), возникающих при исполнении кода.

    - Поместите в блок `try` код, в котором требуется обрабатывать исключения.
    - Поместите в блок `catch` код, который должен выполняться, если при выполнении блока `try` произошла ошибка.

### Отладка C#-скрипта для кнопки

1. Откройте кнопку с операцией «**C#-скрипт**».
2. Чтобы выводить определённое сообщение об ошибке, если возникло исключение при нажатии кнопки, воспользуйтесь следующим образцом кода:

    ```cs
    using System; 
    using System.Collections.Generic;
    using System.Linq;
    using Comindware.Data.Entity;
    using Comindware.TeamNetwork.Api.Data.UserCommands;
    using Comindware.TeamNetwork.Api.Data;

    class Script
    {
        public static UserCommandResult Main(UserCommandContext userCommandContext, Comindware.Entities entities)
        { 
            // Добавьте код, в котором не требуется обрабатывать исключения.
            string ResultDescription = "";
            try
            {
                // Добавьте код, который должен отработать в штатном режиме.
                ResultDescription = "Успех";
            }
            catch
            {
                // Добавьте код, который должен отработать в случае ошибки.
                ResultDescription = "Ошибка";

                var resultError = new UserCommandResult
                {
                    // Указываем, что скрипт завершился с ошибкой, 
                    // о чём нужно вывести сообщение.
                    Success = false,
                    // Ставим флаг необходимости сохранения 
                    // результирующей записи в базу данных.
                    Commited = true,
                    // Указываем, что нужно вывести сообщение пользователю.
                    ResultType = UserCommandResultType.Notificate,
                    // Формируем уведомление.
                    Messages = new[]
                    {
                        new UserCommandMessage
                        {
                            // Указываем уровень важности сообщения 
                            // (Critical, Fatal, Low, Major, None, Normal)
                            Severity = SeverityLevel.Normal,
                            // Этот текст будет выведен в уведомлении и 
                            // журнале действий и ошибок 
                            // в случае срабатывания исключения.
                            Text = string.Format("Результат: {0}", ResultDescription)
                        }
                    }
                };
                return resultError;
            }
            var result = new UserCommandResult
                {
                    Success = true,
                    Commited = true,
                    ResultType = UserCommandResultType.Notificate,
                    Messages = new[]
                    {
                        new UserCommandMessage
                        {
                            Severity = SeverityLevel.Normal,
                            // Этот текст будет выведен в уведомлении и 
                            // журнале действий и ошибок 
                            // в случае штатного завершения работы скрипта.
                            Text = string.Format("Результат: {0}", ResultDescription)
                        }
                    }        
                };
                return result;    
        }
    }
    ```

3. После нажатия кнопки уведомление об ошибке (или успешном выполнении скрипта) отобразится во всплывающем уведомлении в браузере и в **журнале действий и ошибок** <i class=" fal  fa-flag "></i> на информационной панели.

### Отладка C#-скрипта для задачи-выполнения сценария

1. Откройте на диаграмме процесса задачу-выполнение сценария.
2. Чтобы выводить определённое сообщение об ошибке, если возникло исключение при выполнении задачи, воспользуйтесь следующим образцом кода:

    ```cs
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using Comindware.Data.Entity;
    using Comindware.TeamNetwork.Api.Data.UserCommands;
    using Comindware.TeamNetwork.Api.Data;

    class Script
    {
        public static string Main(Comindware.Process.Api.Data.ScriptContext context, Comindware.Entities entities)
        {
            // Добавьте код, в котором не требуется обрабатывать исключения.
            string ResultDescription = "";
            try
            {
                // Добавьте код, который должен работать в штатном режиме.
                ResultDescription = "Успех";
            }
            catch
            {
                // Добавьте код, который должен отработать в случае ошибки.
                ResultDescription = "Ошибка";
            }
            // Эта строка отобразится в поле «Выходные данные» 
            // в событии «Скрипт выполнен» в цепочке событий 
            // для задачи-выполнения сценария.
            return string.Format("Результат: {0}", ResultDescription);
        }
    }
    ```

3. Опубликуйте диаграмму процесса.
4. Создайте экземпляр процесса и перейдите к его диаграмме.
5. Откройте **журнал изменений**.
6. Нажмите значок ![](img/expression_debug_script_button.png){: width="20px"} рядом с названием задачи-выполнения сценария.
7. Отобразится цепочка событий.
8. Нажмите событие «**Скрипт выполнен**».
9. Справа отобразится информация о выполнении скрипта, в том числе:

    - **Контекстные объекты** — ID экземпляра процесса, в котором был запущен скрипт;
    - **Код** — скрипт задачи-выполнения сценария;
    - **Входные данные** — данные, которые использовались в скрипте;
    - **Выходные данные** — результат выполнения скрипта.

## Отладка сценариев

Чтобы выявить проблемы и определить элементы в сценарии, которые отрабатываются с ошибкой, можно воспользоваться действием «**Проверить результат выражения**».

!!! question "Действие «Проверить результат выражения»"

    Это действие проверяет выполнение заданного условия в контекстном шаблоне. Если условие не выполняется, в цепочке событий выводится сообщение об ошибке с заданным текстом.

1. После элемента сценария, работу которого требуется проверить, добавьте действие «**Проверить результат выражения**» и отредактируйте его.
2. В поле «**Выражение**» введите формулу:

    ``` cs
    false
    ```

3. В поле «**Сообщение об ошибке**» введите отладочное сообщение, например:

    ``` cs
    Сценарий отработал корректно до элемента «<название действия>» включительно.
    ```

4. Запустите сценарий.
5. Если все элементы до действия «**Проверить результат выражения**» выполнены успешно, отобразится отладочное сообщение:

    - Для сценария по любым событиям, кроме входа и выхода токена, отладочное сообщение отобразится во всплывающем уведомлении в браузере и в **журнале действий и ошибок** <i class=" fal  fa-flag "></i> на информационной панели.
    - Для сценария на входе или выходе токена отладочное сообщение отобразится в цепочке событий:
        - Перейдите к диаграмме экземпляра процесса.
        - Откройте **журнал изменений**.
        - Нажмите значок <i class="fa-light fa-circle-exclamation"></i> рядом с названием сценария.
        - Отобразится цепочка событий.
        - Справа от цепочки событий в пункте «**Уведомления**» отобразится сообщение об ошибке.

6. Если какой-либо элемент до действия «**Проверить результат выражения**» не был выполнен, отладочное сообщение не отобразится.

    - Исправляйте ошибки в сценарии до тех пор, пока не отобразится отладочное сообщение.

7. Переместите действие «**Проверить результат выражения**» ниже по сценарию и укажите в отладочном сообщении название проверяемого элемента.
8. Снова запустите сценарий и проверьте его выполнение.
9. Проверьте весь сценарий, последовательно перемещая отладочное действие «**Проверить результат выражения**».

--8<-- "related_topics_heading.md"

**[Редактор выражений][expression_editor]**

**[Введение в язык формул Comindware][formula_introduction]**

**[Список функций языка формул Comindware][formula_function_list]**

**[Настройка действий сценария][scenario_actions]**

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}
