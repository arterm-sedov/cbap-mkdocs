---
title: Проверка скриптов, формул и выражений на ошибки
kbId:
tags:
    - формулы
    - формула
    - выражение
    - выражения
    - проверка формулы
    - проверка выражения
    - скрипт
    - проверка скрипта
hide:
    - tags
---

# Отладка скриптов, формул и выражений на ошибки

## Введение

В **{{ productName }}** можно настроить атрибуты, сценарии, вызов процессов, задачи, фильтры, кнопки, правила на форме c помощью C#-скриптов, формул и выражений N3. Однако при их составлении могут возникнуть ошибки различного рода.

Чтобы обнаружить и исключить ошибки в скриптах, выражениях и формулах, следует провести дополнительную проверку их валидности.

## Поиск ошибок с помощью редактора выражений

Ошибки могут содержаться в названиях функций, формул или переменных, в количестве аргументов. Чтобы выявить ошибки такого рода, используйте проверку скрипта, выражения или формулы в **[редакторе выражений][expression_editor]**.

!!! warning "Внимание"

    Компактный редактор выражений не показывает ошибки и сохраняет скрипты, формулы и выражения с ними.

1. Откройте скрипт, выражение или формулу с помощью полного редактора выражений и нажмите кнопку «**Проверить**».
2. Если в скрипте, формуле или выражении содержатся ошибки, в том числе в названии переменных, редактор сообщит об этом.
3. Исправьте ошибки и проверьте скрипт, выражение или формулу ещё раз.

!!! note "Примечание"

    Полный редактор выражений позволяет сохранять скрипты, выражения и формулы только без ошибок синтаксиса.

## Поиск ошибок в формулах и N3 при помощи вспомогательных атрибутов

Если редактор не выявляет ошибки в формулах и выражениях, а результат их выполнения не соответствует ожидаемому, следует их протестировать через создание вспомогательного атрибута. Это особенно актуально для правил на форме и сценариев, результат выполнения которых визуально не отображается во время процесса.

1. Создайте в шаблоне записи новый вспомогательный вычисляемый **атрибут** того типа, который соответствует результату формулы или выражения.

!!! tip "Рекомендация"

    Если вы не знаете, какой тип атрибута подходит, создавайте текстовый атрибут.

2. Введите нужную формулу в поле «**Вычисляемое значение**».
3. Вынесите этот атрибут на форму.
4. Создайте экземпляр записи или процесса и посмотрите, какие данные отобразятся в поле атрибута.
5. Чтобы получить ожидаемое значение атрибута, скорректируйте формулу или выражение.
6. Чтобы ускорить поиск ошибки, по возможности разбейте формулу или выражение на составные самостоятельные части и протестируйте их по очереди.

## Отладка с помощью функций преобразования

В формулах **{{ productName }}** существует две функции преобразования — `BOOL()` и `DECIMAL()`.

!!! question "Определение"

    - `BOOL()` — функция, которая конвертирует строку в логический тип.
    - Для правильного выполнения функции в качестве аргумента должен выступать текстовый атрибут или строка, в которых написано "true" или "false" без учёта регистра. В ином случае функция не сможет преобразовать строку.

!!! question "Определение"

    - `DECIMAL()` — функция, которая конвертирует строку в число.
    - В качестве аргумента функция принимает текстовый атрибут или строку, заполненные только цифрами. В ином случае функция не сработает.

## Отладка формул с помощью функции VALUE()

!!! question "Определение"

    `VALUE()` — функция, которая возвращает значение объекта, значение по умолчанию или заданное пользователем значение по умолчанию.

Эта функция помогает отследить ошибки в формулах. С помощью неё можно задать либо значение по умолчанию для аргумента, либо вывести сообщение об ошибке.

1. Создайте текстовый вычисляемый атрибут.
2. Добавьте вычисляемое выражение в виде формулы:

```cs
VALUE(<вычисляемое выражение>, "Ошибка")
```

Здесь:

`"Ошибка"` — сообщение, которое будет выводиться при неправильном выполнении первого аргумента `<вычисляемое выражение>`. Также вместо сообщения об ошибке может быть задано значение для аргумента по умолчанию.

## Поиск ошибок в C#-скриптах

Для поиска ошибок в C#-скриптах модно воспользоваться блоком **try-catch** для перехвата ошибок.

### Поиск ошибок в кнопках

1. Чтобы вывести ошибку при нажатии кнопки, воспользуйтесь следующим кодом:

```cs
using System; 
using System.Collections.Generic;
using System.Linq;
using Comindware.Data.Entity;
using Comindware.TeamNetwork.Api.Data.UserCommands;
using Comindware.TeamNetwork.Api.Data;

class Script
{
    public static UserCommandResult Main(UserCommandContext userCommandContext, Comindware.Entities entities)
    { 
        // Добавьте входные данные.
        try
        {
            // Добавьте код, который должен отработать в штатном режиме.
        }
        catch
        {
            // Добавьте код, который должен отработать в случае ошибки.
            var resultError = new UserCommandResult
            {
                // Указываем, что скрипт завершился с ошибкой, о чём нужно вывести сообщение.
                Success = false,
                // Ставим флаг необходимости сохранения результирующей записи в базу данных.
                Commited = true,
                // Указываем, что нужно вывести сообщение пользователю.
                ResultType = UserCommandResultType.Notificate,
                // Формируем уведомление.
                Messages = new[]
                {
                    new UserCommandMessage
                    {
                        // Указываем уровень важности сообщения (Critical, Fatal, Low, Major, None, Normal)
                        Severity = SeverityLevel.Normal,
                        //Этот текст будет выведен в уведомлении и журнале действий и ошибок.
                        Text = "Ошибка"
                    }
                }
            };
            return resultError;
        }
        var result = new UserCommandResult
            {
                Success = true,
                Commited = true,
                ResultType = UserCommandResultType.Notificate,
                Messages = new[]
                {
                    new UserCommandMessage
                    {
                        Severity = SeverityLevel.Normal,
                        //Этот текст будет выведен в уведомлении и журнале действий и ошибок.
                        Text = "Успех"
                    }
                }        
            };
            return result;    
    }
}
```
2. После нажатия кнопки уведомление об ошибке высветится в нижнем правом углу браузера и в **журнале действий и ошибок**.

### Поиск ошибок в задаче-выполнении сценария

1. Добавьте на вкладке «**Дополнительные**» задачи-выполнения сценария C#-скрипта по образцу:

```cs
using System;
using System.Collections.Generic;
using System.Linq;
using Comindware.Data.Entity;
using Comindware.TeamNetwork.Api.Data.UserCommands;
using Comindware.TeamNetwork.Api.Data;

class Script
{
    public static string Main(Comindware.Process.Api.Data.ScriptContext context, Comindware.Entities entities)
    {
        // Добавьте входные данные.
        int Result = 0;
        try
        {
            // Добавьте код, который должен работать в штатном режиме.
            Result = 1;
        }
        catch
        {
            // Добавьте код, который должен отработать в случае ошибки.
           Result = -1;
        }
        // Эта строка отобразится в поле «Выходные данные» в событии «Скрипт выполнен» в цепочке событий для задачи-выполнения сценария.
        return string.Format("Результат: {0}", Result);
    }
}
```

2. Опубликуйте диаграмму процесса.
3. Пере

--8<-- "related_topics_heading.md"

**[Редактор выражений][expression_editor]**

**[Введение в язык выражений Comindware][expression_introduction]**

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}
