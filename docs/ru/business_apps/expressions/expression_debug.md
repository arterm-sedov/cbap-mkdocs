---
title: Отладка формул, выражений N3, сценариев и скриптов
kbId:
tags:
    - формулы
    - формула
    - выражение
    - выражения
    - проверка формулы
    - проверка выражения
    - скрипт
    - проверка скрипта
hide:
    - tags
---

# Отладка формул, выражений N3, сценариев и скриптов

## Введение

Атрибуты, сценарии, вызов процессов, задачи, фильтры, кнопки и правила на форме можно настроить c помощью формул, выражений N3 и C#-скриптов. Однако при их составлении могут возникнуть проблемы различного рода, например:

- ошибки в именах функций, атрибутов, шаблонов и переменных;
- синтаксические ошибки;
- ошибки в логике построения формулы, выражения или скрипта;
- неправильный тип данных вычисляемого атрибута, аргументов или возвращаемых значений.

Здесь представлены методы проверки и отладки, позволяющие обнаружить и исправить ошибки в формулах, выражениях и скриптах.

## Отладка с помощью редактора выражений

Чтобы выявить ошибки в именах функций, атрибутов, шаблонов и переменных, а также в синтаксисе формулы, выражения N3 или скрипта, используйте функцию проверки в **[редакторе выражений][expression_editor]**.

!!! warning "Внимание!"

    Компактный редактор выражений не проверяет ошибки и сохраняет формулы, выражения N3 и скрипты даже при наличии ошибок.

1. Откройте формулу, выражение N3 или скрипт в полном редакторе выражений и нажмите кнопку «**Проверить**».
2. Выявленные синтаксические ошибки и ошибки в именах функций, атрибутов, шаблонов или отобразятся на вкладке «**Ошибки**».
3. Исправьте ошибки, проверьте и сохраните формулу, выражение N3 или скрипт.

!!! note "Примечание"

    Полный редактор выражений позволяет сохранять скрипты, выражения N3 и формулы только без ошибок синтаксиса и ошибок в названии переменных.

## Отладка формул и N3 с помощью вспомогательного атрибута

Если редактор не выявляет ошибки в формулах и выражениях N3, а результат их выполнения не соответствует ожидаемому, следует протестировать их через создание вспомогательного атрибута. Это особенно актуально для правил на форме и сценариев, результат выполнения которых визуально не отображается во время процесса.

1. Создайте в шаблоне записи новый вспомогательный вычисляемый **атрибут** того типа, который соответствует результату формулы или выражения.

!!! tip "Рекомендация"

    Если вы не знаете, какой тип атрибута подходит, создавайте текстовый атрибут.

2. Введите формулу или N3 в поле «**Вычисляемое значение**».
3. Вынесите этот атрибут на форму.
4. Создайте экземпляр записи или процесса и посмотрите, какие данные отобразятся в поле атрибута.
5. Чтобы получить ожидаемое значение атрибута, скорректируйте формулу или N3.
6. Чтобы ускорить поиск ошибки, по возможности разбейте формулу или N3 на составные самостоятельные части и протестируйте их по очереди.

### Отладка формул и выражений N3 с помощью функций

#### Отладка с помощью функций преобразования

В формулах **{{ productName }}** существует две функции преобразования — `BOOL()` и `DECIMAL()`.

!!! question "BOOL()"

    - `BOOL()` — функция, которая конвертирует строку в логический тип.
    - В качестве аргумента функция принимает текстовый атрибут или строку, значение которых соответствует `true` или `false` без учёта регистра. В ином случае функция не сработает.

!!! question "DECIMAL()"

    - `DECIMAL()` — функция, которая конвертирует строку в число.
    - В качестве аргумента функция принимает текстовый атрибут или строку, заполненные только цифрами. В ином случае функция не сработает.

1. Создайте вычисляемый атрибут.
2. Добавьте функцию преобразования в формулу, а в скобки поместите аргумент, который нужно преобразовать.
3. Вынесите атрибут на форму.
4. При корректном работе функции, в поле атрибута будет выведено преобразованное значение. Если функция не смогла преобразовать аргумент, то в поле атрибута отобразится `-`.

#### Отладка с помощью функции VALUE()

!!! question "VALUE()"

    - `VALUE()` — функция, которая возвращает значение объекта, значение по умолчанию или заданное пользователем значение по умолчанию.
    - Эта функция помогает отследить ошибки в формулах. С её помощью можно не только задавать значение по умолчанию для аргумента, но и выводить сообщение об ошибке.

1. Создайте текстовый вычисляемый атрибут.
2. Добавьте формулу вида:

```cs
VALUE(<вычисляемое выражение>, "Ошибка")
```

**Здесь:**

`"Ошибка"` — сообщение, которое будет выводиться при отработке аргумента `<вычисляемое выражение>` с ошибкой.

3. Вынесите атрибут на форму.
4. Если `<вычисляемое выражение>` отработало с ошибкой, то в значении атрибута отобразится сообщение об этом.

## Отладка C#-скриптов

Для поиска ошибок в C#-скриптах можно воспользоваться конструкцией **try-catch** для перехвата ошибок.

!!! question "try-catch"

    **try-catch** — конструкция, которая используется в программировании для поиска и отладки ошибок.

    - Поместите в блок **try** ту часть кода, которую требуется проверить на ошибки.
    - Поместите в блок **catch** код, который должен выполниться, если при отработке блока **try** возникла ошибка.

### Отладка C#-скрипта в кнопке

1. Чтобы вывести ошибку при нажатии кнопки, воспользуйтесь следующим образцом кода:

```cs
using System; 
using System.Collections.Generic;
using System.Linq;
using Comindware.Data.Entity;
using Comindware.TeamNetwork.Api.Data.UserCommands;
using Comindware.TeamNetwork.Api.Data;

class Script
{
    public static UserCommandResult Main(UserCommandContext userCommandContext, Comindware.Entities entities)
    { 
        // Добавьте входные данные.
        try
        {
            // Добавьте код, который должен отработать в штатном режиме.
        }
        catch
        {
            // Добавьте код, который должен отработать в случае ошибки.
            var resultError = new UserCommandResult
            {
                // Указываем, что скрипт завершился с ошибкой, о чём нужно вывести сообщение.
                Success = false,
                // Ставим флаг необходимости сохранения результирующей записи в базу данных.
                Commited = true,
                // Указываем, что нужно вывести сообщение пользователю.
                ResultType = UserCommandResultType.Notificate,
                // Формируем уведомление.
                Messages = new[]
                {
                    new UserCommandMessage
                    {
                        // Указываем уровень важности сообщения (Critical, Fatal, Low, Major, None, Normal)
                        Severity = SeverityLevel.Normal,
                        //Этот текст будет выведен в уведомлении и журнале действий и ошибок.
                        Text = "Ошибка"
                    }
                }
            };
            return resultError;
        }
        var result = new UserCommandResult
            {
                Success = true,
                Commited = true,
                ResultType = UserCommandResultType.Notificate,
                Messages = new[]
                {
                    new UserCommandMessage
                    {
                        Severity = SeverityLevel.Normal,
                        //Этот текст будет выведен в уведомлении и журнале действий и ошибок.
                        Text = "Успех"
                    }
                }        
            };
            return result;    
    }
}
```
2. После нажатия кнопки уведомление об ошибке (или успешном выполнении скрипта) отобразится в правом нижнем углу браузера и **журнале действий и ошибок**.

### Отладка C#-скрипта в задаче-выполнении сценария

1. Добавьте на вкладке «**Дополнительные**» задачи-выполнения сценария C#-скрипт по образцу:

```cs
using System;
using System.Collections.Generic;
using System.Linq;
using Comindware.Data.Entity;
using Comindware.TeamNetwork.Api.Data.UserCommands;
using Comindware.TeamNetwork.Api.Data;

class Script
{
    public static string Main(Comindware.Process.Api.Data.ScriptContext context, Comindware.Entities entities)
    {
        // Добавьте входные данные.
        int Result = 0;
        try
        {
            // Добавьте код, который должен работать в штатном режиме.
            Result = 1;
        }
        catch
        {
            // Добавьте код, который должен отработать в случае ошибки.
           Result = -1;
        }
        // Эта строка отобразится в поле «Выходные данные» в событии «Скрипт выполнен» в цепочке событий для задачи-выполнения сценария.
        return string.Format("Результат: {0}", Result);
    }
}
```

2. Опубликуйте диаграмму процесса.
3. Создайте экземпляр процесса и перейдите на его диаграмму.
4. Откройте журнал изменений.
5. Щёлкните значок ![](expression_debug_script_button.png){: width="20px"}.
6. Нажмите событие «**Скрипт выполнен**».
7. Справа отобразится информация о выполнении скрипта, в том числе:

    - **Контекстные объекты** — ID экземпляра процесса, внутри которого был запущен скрипт;
    - **Код** — скрипт, который использовался в задаче-выполнении сценария;
    - **Входные данные** — данные, которые использовались в скрипте;
    - **Выходные данные** — результат выполнения скрипта;

8. В поле «**Выходные данные**» отобразится результат выполнения скрипта.

## Отладка сценария

Чтобы отследить наличие проблем в сценарии и определить в нём элементы, которые отрабатываются с ошибкой, можно воспользоваться действием «**Проверить результат выражения**».

!!! question "Действие «Проверить результат выражения»"

    Проверяет выполнение заданного условия в контекстном шаблоне (указан на вкладке «**Дополнительно**»). Если условие не будет выполнено, отобразится сообщение об ошибке с заданным текстом.

1. После элемента сценария добавьте действие «**Проверить результат выражения**» и отредактируйте его.
2. В поле «**Выражение**» добавьте следующую формулу:

```cs
false
```

3. Заполните поле «**Сообщение об ошибке**», например:

```cs
Сценарий отработал корректно до действия <название действия>
```

4. Создайте экземпляр процесса и перейдите к его диаграмме.
5. Откройте журнал изменений и нажмите <i class="fa-light fa-circle-exclamation"></i>.
6. Справа от цепочки событий в пункте «**Уведомления**» отобразится сообщение об ошибке.
7. Исправляйте ошибки в проверяемом элементе сценария, пока в «**Уведомлениях**» не отобразится сообщение из п. 3.
8. Переместите действие «**Проверить результат выражения**» ниже по сценарию и измените сообщение об ошибке.
9. Последовательно проверьте весь сценарий.

--8<-- "related_topics_heading.md"

**[Редактор выражений][expression_editor]**

**[Введение в язык выражений Comindware][formula_introduction]**

**[Список функций языка формул Comindware][formula_function_list]**

**[Настройка действий сценария][scenario_actions]**

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}
