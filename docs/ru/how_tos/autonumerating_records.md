## Пример: настройка автонумерации записей

## Введение

Каждой записи, пользовательской задаче, форме и экземпляру процесса присваивается уникальный ID. В рамках сервера **Comindware Business Application Platform** ID не повторяются.

Чтобы автоматически нумеровать новые записи внутри шаблона, создайте атрибут типа «**Текст**» и настройте его заполнение порядковыми номерами:

* с помощью формулы;
* с помощью C#-скрипта.

Если в шаблоне будет большое количество записей, то рекомендуется использовать C#-скрипт для повышения производительности.

В статье даны примеры по автонумерации записей обоими способами.

!!! Примечание
    Алгоритмы, представленные в примерах, не присваивают порядковые номера уже существующим записям в шаблоне.

    Для нумерации имеющихся записей потребуется обработать их с помощью цикла в сценарии, например, с использованием C#-скрипта.

## Прикладная задача

Необходимо настроить нумерацию заявок, создаваемых в шаблоне *«Заявка»*.

Эта нумерация будет отличаться от ID записей, которые им присваиваются автоматически: порядковые номера будут присваиваться только записям этого шаблона, а ID имеют сквозную нумерацию для всех шаблонов и приложений.

## Автонумерация с помощью формулы

Для шаблонов с небольшим количеством записей можно использовать автонумерацию с помощью формул.

!!! Примечание
    Данный способ не учитывает возможность удаления записей. При удалении записей порядковые номера могут дублироваться.
    Этот способ учитывает количество уже существующих записей, и новому экземпляру будет присвоен такой порядковый номер, как если бы все предыдущие записи были тоже пронумерованы.

1. В шаблоне записи *«Заявка»* создайте атрибут *«Порядковый номер»* типа «**Текст**».
2. Добавьте атрибут *«Порядковый номер»* на **форму** шаблона записи.
3. В начальном событии процесса, который связан с шаблоном записи *«Заявка»*, создайте и настройте сценарий «**Изменить значения атрибутов**»:

    | Атрибут            | Операция со значениями | Значение                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    | ------------------ | ---------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
    | *Порядковый номер* | **Заменить**           | **Формула:** <br>`FORMAT("{0}",LIST(COUNT((from a in db->Zayavka select a->id))))`<br>`FORMAT()` — эта функция принимает строку заменителями вида `{0}`…`{N}` и список значений. Функция подставляет значения из списка в соответствующие заменители и возвращает результирующую строку.<br>`LIST()` — эта функция принимает перечень значений и возвращает список, состоящий из этих значений.<br>`COUNT()` — эта функция подсчитывает количество записей в шаблоне записи, указанном в запросе.<br>`Zayavka` — системное имя шаблона записи *«Заявка»*. <br>     См. также статью «[Список функций языка формул Comindware](https://kb.comindware.ru/article.php?id=2492)». |

4. Опубликуйте диаграмму.

### Тестирование

1. Создайте экземпляр процесса.
2. Новая заявка будет пронумерована с учётом количества существующих записей.

## Автонумерация с помощью C#-скрипта

Для ускорения автонумерации большого количества записей рекомендуется использовать C#-скрипт. При этом удаление записей не повлияет на присваиваемые порядковые номера.

1. На странице администрирования приложения выберите пункт «**Переменные**».
2. Создайте переменную со следующими параметрами:
   * **Название** — *Номер*;
   * **Тип** — **Число**;
   * **Значение** — *1*.
   См. **[Создание переменной](https://kb.comindware.ru/article.php?id=2207#mcetoc_1gjrm27ok5)**.
3. В шаблоне записи *«Заявка»* создайте и добавьте на форму **атрибут** *«Номер заявки»* типа «**Число**».
4. В процессе, который связан с шаблоном записи *«Заявка»*, добавьте **задачу-выполнение сценария** сразу после начального события.
5. В свойствах задачи-выполнения сценария на вкладке «**Дополнительные**» добавьте следующий **C#-скрипт**:

    ```cs
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using Comindware.Data.Entity;
    using Comindware.TeamNetwork.Api.Data.UserCommands;
    using Comindware.TeamNetwork.Api.Data;
    public class Script
    {
        public static void Main(Comindware.Process.Api.Data.ScriptContext context, Comindware.Entities entities)
        {
                            var objectId = context.BusinessObjectId;  
    // svar.1 — ID переменной «Номер».
                            var temp = (decimal)Api.Solution.SolutionVariableService.GetValue("svar.1");
                            var data = new Dictionary<string, object>
               {
    // Nomerzayavki — системное имя атрибута «Номер заявки».
                 {"Nomerzayavki", temp}
               };
    // Zayavka — системное имя шаблона записи «Заявка».
               Api.TeamNetwork.ObjectService.EditWithAlias("Zayavka", objectId, data);
    // svar.1 — ID переменной «Номер».
               Api.Solution.SolutionVariableService.SetValue("svar.1", temp+1);
        }
    }
    ```

6. Опубликуйте диаграмму.

### Тестирование

1. Создайте экземпляр процесса.
2. В поле атрибута *«Номер заявки»* должен отобразиться порядковый номер.
3. В свойствах переменной *«Номер»* значение поменяется.

## Связанные статьи

[Список функций языка формул Comindware](https://kb.comindware.ru/article.php?id=2492)
[Переменные](https://kb.comindware.ru/article.php?id=2207)

## Теги

C#
скрипт
C#-скрипт
скрипты
язык формул
формулы
язык выражений
выражения
