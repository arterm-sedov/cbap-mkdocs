<h1>Модуль GeoIP для NGINX. Установка и настройка. Краткое руководство</h1><div class="mce-toc">
<h2 class="toc-heading">Содержание</h2>
<ul>
<li><a href="#mcetoc_1g79dsjv31">Введение</a></li>
<li><a href="#mcetoc_1g79dtm3n2">1. Установка</a></li>
<li><a href="#mcetoc_1g79e340h3">2. Ограничение доступа для пользователей из определенных стран</a></li>
<li><a href="#mcetoc_1g79e9lc34">3. Пример скрипта автоматического обновления</a></li>
</ul>
</div>
<h2 id="mcetoc_1g79dsjv31">Введение</h2>
<p>Для ограничения доступа к сайту пользователей из определенных стран с помощью веб-сервера NGINX, можно использовать модуль GeoIP.</p>
<p>В этой статье представлена краткая инструкция по установке и настройке конфигурации модуля GeoIP в ОС Linux для работы с <strong>Comindware Business Application Platform</strong>.</p>
<p>Подробные сведения по установке и настройке модуля GeoIP представлены на следующих сайтах:</p>
<ul>
<li><a href="https://dev.maxmind.com/geoip/updating-databases?lang=en">https://dev.maxmind.com/geoip/updating-databases?lang=en</a></li>
<li><a href="https://itsecforu.ru/2018/08/29/%D0%BA%D0%B0%D0%BA-%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D1%82%D1%8C-mod_geoip-%D0%B4%D0%BB%D1%8F-apache-%D0%B2-rhel-%D0%B8-centos/">https://itsecforu.ru/2018/08/29/как-установить-mod_geoip-для-apache-в-rhel-и-centos/</a></li>
</ul>
<h2 id="mcetoc_1g79dtm3n2">1. Установка</h2>
<p><strong>1.1.</strong> Для установки необходимых пакетов в операционной системе выполните указанные ниже команды.</p>
<ul>
<li><strong>Debian/Ubuntu</strong>: <code>sudo apt-get install nginx-module-geoip </code></li>
<li><strong>CentOS</strong>: <code>yum install nginx-module-geoip </code></li>
</ul>
<p><strong>1.2.</strong> Обновите базы GeoIP до актуальной версии с помощью команд:</p>
<pre><code>mv /usr/share/GeoIP/GeoIP.dat /usr/share/GeoIP/GeoIP.dat_bak</code> <br/><code>cd /usr/share/GeoIP/</code> <br/><code>wget http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz</code> <br/><code>gunzip GeoIP.dat.gz</code></pre>
<p><strong>1.3.</strong> С помощью команды <code>nginx -V</code> убедитесь, что веб-сервер собран с параметром <code>--with-http_geoip_module</code>. В противном случае необходимо самостоятельно собрать модуль NGINX. Исходные коды GeoIP находятся в открытом доступе.</p>
<p> </p>
<h2 id="mcetoc_1g79e340h3">2. Ограничение доступа для пользователей из определенных стран</h2>
<p><strong>2.1.</strong> Чтобы запретить доступ к сайту пользователям из Украины и США, в папке с файлами конфигурации веб-сервера NGINX создайте файл <code>block.map.include</code> со следующими директивами:</p>
<pre><code>geoip_country /usr/share/GeoIP/GeoIP.dat; </code> <br/><code>    map $geoip_country_code $allowed_country { </code> <br/><code>            default yes;</code> <br/><code>            UA no;</code> <br/><code>            US no;</code> <br/><code>    }</code></pre>
<p><strong>2.2.</strong> Чтобы разрешить использование сайта только пользователям из России, Китая и Тайваня, используйте в файле конфигурации следующие директивы:</p>
<pre><code>geoip_country /usr/share/GeoIP/GeoIP.dat; </code> <br/><code>    map $geoip_country_code $allowed_country {</code> <br/><code>        default no;</code> <br/><code>        RU yes;</code> <br/><code>        CN yes;</code> <br/><code>        TW yes;</code> <br/><code>    }</code></pre>
<p><strong>2.3.</strong> В файле конфигурации <code>/etc/nginx/nginx.conf</code> в разделе <code>http</code> добавьте следующую директиву: <code>include include/block.map.include;</code></p>
<p><strong>2.4.</strong> В настройках хоста (раздел <code>server</code>) добавьте следующую директиву:</p>
<pre><code>if ($allowed_country = no) {</code> <br/><code>    return 404;</code> <br/><code>}</code></pre>
<p><strong>2.5.</strong> Примените изменения: <code># nginx -s reload</code></p>
<p> </p>
<h2 id="mcetoc_1g79e9lc34">3. Пример скрипта автоматического обновления</h2>
<p>Приведенный ниже скрипт загружает последнюю версию базы данных GeoIP каждый месяц. Добавьте его в файл <code>/etc/cron.monthly</code>.</p>
<pre><code>#!/bin/sh</code> <br/><code>GEOIP_MIRROR="http://geolite.maxmind.com/download/geoip/database"</code> <br/><code>GEOIPDIR=/usr/share/GeoIP</code> <br/><code>TMPDIR=</code> <br/><code>DATABASES="GeoLiteCity GeoLiteCountry/GeoIP asnum/GeoIPASNum GeoIPv6"</code> <br/><code>if [ -d "${GEOIPDIR}" ]; then</code> <br/><code>cd $GEOIPDIR</code> <br/><code>if [ -n "${DATABASES}" ]; then</code> <br/><code>TMPDIR=$(mktemp -d geoipupdate.XXXXXXXXXX)</code> <br/><code>echo "Updating GeoIP databases..."</code> <br/><code>for db in $DATABASES; do</code> <br/><code>fname=$(basename $db)</code> <br/><code>wget --no-verbose -t 3 -T 60 "${GEOIP_MIRROR}/${db}.dat.gz" -O "${TMPDIR}/${fname}.dat.gz"</code> <br/><code>gunzip -fdc "${TMPDIR}/${fname}.dat.gz" &gt; "${TMPDIR}/${fname}.dat"</code> <br/><code>mv "${TMPDIR}/${fname}.dat" "${GEOIPDIR}/${fname}.dat"</code> <br/><code>chmod 0644 "${GEOIPDIR}/${fname}.dat"</code> <br/><code>done</code> <br/><code>[ -d "${TMPDIR}" ] &amp;&amp; rm -rf $TMPDIR</code> <br/><code>fi</code> <br/><code>fi</code></pre>
<div class="table-responsive">
<p><a class="md-top md-icon mkdocs_imported_link" href="#"> <em class="fa-light fa-arrow-up">‌</em> К началу </a></p>
</div><h1>Модуль GeoIP для NGINX. Установка и настройка. Краткое руководство</h1><div class="mce-toc">
<h2 class="toc-heading">Содержание</h2>
<ul>
<li><a href="#mcetoc_1g79dsjv31">Введение</a></li>
<li><a href="#mcetoc_1g79dtm3n2">1. Установка</a></li>
<li><a href="#mcetoc_1g79e340h3">2. Ограничение доступа для пользователей из определенных стран</a></li>
<li><a href="#mcetoc_1g79e9lc34">3. Пример скрипта автоматического обновления</a></li>
</ul>
</div>
<h2 id="mcetoc_1g79dsjv31">Введение</h2>
<p>Для ограничения доступа к сайту пользователей из определенных стран с помощью веб-сервера NGINX, можно использовать модуль GeoIP.</p>
<p>В этой статье представлена краткая инструкция по установке и настройке конфигурации модуля GeoIP в ОС Linux для работы с <strong>Comindware Business Application Platform</strong>.</p>
<p>Подробные сведения по установке и настройке модуля GeoIP представлены на следующих сайтах:</p>
<ul>
<li><a href="https://dev.maxmind.com/geoip/updating-databases?lang=en">https://dev.maxmind.com/geoip/updating-databases?lang=en</a></li>
<li><a href="https://itsecforu.ru/2018/08/29/%D0%BA%D0%B0%D0%BA-%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%B8%D1%82%D1%8C-mod_geoip-%D0%B4%D0%BB%D1%8F-apache-%D0%B2-rhel-%D0%B8-centos/">https://itsecforu.ru/2018/08/29/как-установить-mod_geoip-для-apache-в-rhel-и-centos/</a></li>
</ul>
<h2 id="mcetoc_1g79dtm3n2">1. Установка</h2>
<p><strong>1.1.</strong> Для установки необходимых пакетов в операционной системе выполните указанные ниже команды.</p>
<ul>
<li><strong>Debian/Ubuntu</strong>: <code>sudo apt-get install nginx-module-geoip </code></li>
<li><strong>CentOS</strong>: <code>yum install nginx-module-geoip </code></li>
</ul>
<p><strong>1.2.</strong> Обновите базы GeoIP до актуальной версии с помощью команд:</p>
<pre><code>mv /usr/share/GeoIP/GeoIP.dat /usr/share/GeoIP/GeoIP.dat_bak</code> <br/><code>cd /usr/share/GeoIP/</code> <br/><code>wget http://geolite.maxmind.com/download/geoip/database/GeoLiteCountry/GeoIP.dat.gz</code> <br/><code>gunzip GeoIP.dat.gz</code></pre>
<p><strong>1.3.</strong> С помощью команды <code>nginx -V</code> убедитесь, что веб-сервер собран с параметром <code>--with-http_geoip_module</code>. В противном случае необходимо самостоятельно собрать модуль NGINX. Исходные коды GeoIP находятся в открытом доступе.</p>
<p> </p>
<h2 id="mcetoc_1g79e340h3">2. Ограничение доступа для пользователей из определенных стран</h2>
<p><strong>2.1.</strong> Чтобы запретить доступ к сайту пользователям из Украины и США, в папке с файлами конфигурации веб-сервера NGINX создайте файл <code>block.map.include</code> со следующими директивами:</p>
<pre><code>geoip_country /usr/share/GeoIP/GeoIP.dat; </code> <br/><code>    map $geoip_country_code $allowed_country { </code> <br/><code>            default yes;</code> <br/><code>            UA no;</code> <br/><code>            US no;</code> <br/><code>    }</code></pre>
<p><strong>2.2.</strong> Чтобы разрешить использование сайта только пользователям из России, Китая и Тайваня, используйте в файле конфигурации следующие директивы:</p>
<pre><code>geoip_country /usr/share/GeoIP/GeoIP.dat; </code> <br/><code>    map $geoip_country_code $allowed_country {</code> <br/><code>        default no;</code> <br/><code>        RU yes;</code> <br/><code>        CN yes;</code> <br/><code>        TW yes;</code> <br/><code>    }</code></pre>
<p><strong>2.3.</strong> В файле конфигурации <code>/etc/nginx/nginx.conf</code> в разделе <code>http</code> добавьте следующую директиву: <code>include include/block.map.include;</code></p>
<p><strong>2.4.</strong> В настройках хоста (раздел <code>server</code>) добавьте следующую директиву:</p>
<pre><code>if ($allowed_country = no) {</code> <br/><code>    return 404;</code> <br/><code>}</code></pre>
<p><strong>2.5.</strong> Примените изменения: <code># nginx -s reload</code></p>
<p> </p>
<h2 id="mcetoc_1g79e9lc34">3. Пример скрипта автоматического обновления</h2>
<p>Приведенный ниже скрипт загружает последнюю версию базы данных GeoIP каждый месяц. Добавьте его в файл <code>/etc/cron.monthly</code>.</p>
<pre><code>#!/bin/sh</code> <br/><code>GEOIP_MIRROR="http://geolite.maxmind.com/download/geoip/database"</code> <br/><code>GEOIPDIR=/usr/share/GeoIP</code> <br/><code>TMPDIR=</code> <br/><code>DATABASES="GeoLiteCity GeoLiteCountry/GeoIP asnum/GeoIPASNum GeoIPv6"</code> <br/><code>if [ -d "${GEOIPDIR}" ]; then</code> <br/><code>cd $GEOIPDIR</code> <br/><code>if [ -n "${DATABASES}" ]; then</code> <br/><code>TMPDIR=$(mktemp -d geoipupdate.XXXXXXXXXX)</code> <br/><code>echo "Updating GeoIP databases..."</code> <br/><code>for db in $DATABASES; do</code> <br/><code>fname=$(basename $db)</code> <br/><code>wget --no-verbose -t 3 -T 60 "${GEOIP_MIRROR}/${db}.dat.gz" -O "${TMPDIR}/${fname}.dat.gz"</code> <br/><code>gunzip -fdc "${TMPDIR}/${fname}.dat.gz" &gt; "${TMPDIR}/${fname}.dat"</code> <br/><code>mv "${TMPDIR}/${fname}.dat" "${GEOIPDIR}/${fname}.dat"</code> <br/><code>chmod 0644 "${GEOIPDIR}/${fname}.dat"</code> <br/><code>done</code> <br/><code>[ -d "${TMPDIR}" ] &amp;&amp; rm -rf $TMPDIR</code> <br/><code>fi</code> <br/><code>fi</code></pre>
<div class="table-responsive">
<p><a class="md-top md-icon mkdocs_imported_link" href="#"> <em class="fa-light fa-arrow-up">‌</em> К началу </a></p>
</div>