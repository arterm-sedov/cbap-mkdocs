<h1>NGINX. Установка и настройка. Краткое руководство</h1><div class="mce-toc">
<h2 class="toc-heading">Содержание</h2>
<ul>
<li><a href="#mcetoc_1g79bimel1">Введение</a></li>
<li><a href="#mcetoc_1g79bl0u72">1. Установка NGINX</a></li>
<li><a href="#mcetoc_1g79bmish3">2. Настройка сервера NGINX</a>
<ul>
<li><a href="#mcetoc_1g79c6m6e1">2.1. Пример конфигурации прокси-сервера</a></li>
<li><a href="#mcetoc_1g79c8d8d2">2.2. Настройка UFW</a></li>
<li><a href="#mcetoc_1g79cack93">2.3. Отключение команды server_tokens</a></li>
<li><a href="#mcetoc_1g79ccie54">2.4. Контроль ресурсов и ограничения</a></li>
<li><a href="#mcetoc_1g79ckddg9">2.5. Настройка NGINX для включения заголовков безопасности</a></li>
<li><a href="#mcetoc_1g79cqrpta">2.6. Настройка SSL и наборов шифров Cipher Suite</a></li>
<li><a href="#mcetoc_1g79d0shob">2.7. Регулярное обновление сервера</a></li>
<li><a href="#mcetoc_1g79d2g9mc">2.8. Проверка состояния сервера</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="mcetoc_1g79bimel1">Введение</h2>
<p>В настоящем документе представлена краткая инструкция по установке и настройке конфигурации HTTP-сервера NGINX в ОС Ubuntu 20.04 для использования NGINX в сочетании с Comindware Business Application Platform.</p>
<p>Подробные сведения по установке и настройке NGINX представлены на следующих сайтах:</p>
<ul>
<li><a href="http://nginx.org/ru/docs/beginners_guide.html">http://NGINX.org/ru/docs/beginners_guide.html</a></li>
<li><a href="https://ruvds.com/ru/helpcenter/kak-nastroit-nginx-na-ubuntu-20-04/">https://ruvds.com/ru/helpcenter/kak-nastroit-NGINX-na-ubuntu-20-04/</a> </li>
<li><a href="https://webdevblog.ru/bezopasnost-nginx-kak-uluchshit-konfiguraciju-vashego-servera/">https://webdevblog.ru/bezopasnost-NGINX-kak-uluchshit-konfiguraciju-vashego-servera/</a> </li>
</ul>
<h2 id="mcetoc_1g79bl0u72">1. Установка NGINX</h2>
<p>Войдите в систему под учётной записью, имеющей разрешение на запуск команды <code>sudo</code>, и выполните следующие команды:</p>
<ul>
<li><code>$ sudo apt update</code></li>
<li><code>$ sudo apt install NGINX</code></li>
</ul>
<p>Первая команда обновляет базу данных пакетов, доступных для установки. Вторая — устанавливает компоненты NGINX.</p>
<p>После установки NGINX настройте его конфигурацию.</p>
<h2 id="mcetoc_1g79bmish3">2. Настройка сервера NGINX</h2>
<p>Конфигурация NGINX хранится в файле <code>NGINX.conf</code>. По умолчанию файл <code>NGINX.conf</code> находится в следующей папке:</p>
<ul>
<li><code>/etc/NGINX</code> или <code>/usr/local/etc/NGINX</code> — в системах Linux;</li>
<li><code>[папка установки NGINX]/conf</code> — в системах Windows.</li>
</ul>
<h3 id="mcetoc_1g79c6m6e1">2.1. Пример конфигурации прокси-сервера</h3>
<div>
<table class="source_code_container">
<tbody>
<tr>
<td class="source_code">
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">server {</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    server_name  domain.com;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    reset_timedout_connection  on;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    listen 80;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;"> </span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    location /robots.txt { root /var/www/html; }</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    return 301 https://$host$request_uri;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">}</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;"> </span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">server {</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    server_name  domain.com;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    reset_timedout_connection  on;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;"> </span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">     listen 443 ssl;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;"> </span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    location / {</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    proxy_pass http://backend-server:8081/;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    proxy_next_upstream error timeout invalid_header http_500 http_503;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;"> </span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    # do not set HOST header</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    proxy_set_header  Host                $host;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    proxy_set_header  X-Forwarded-For     $proxy_add_x_forwarded_for;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    proxy_set_header  X-Forwarded-Proto   $scheme;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    proxy_set_header  X-Real-IP           $remote_addr;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;"> </span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    proxy_connect_timeout     90;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    proxy_send_timeout        1000;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    proxy_read_timeout        1000;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;"> </span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    # enable WebSockets</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    proxy_http_version 1.1;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    proxy_set_header Upgrade $http_upgrade;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    proxy_set_header Connection "upgrade";</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;"> </span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    client_max_body_size 100m;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;"> </span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    error_log /var/log/NGINX/domain-error.log error;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">    access_log /var/log/NGINX/domain-access.log;</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">  }</span></p>
<p style="margin-bottom: 0in;"><span style="font-size: 10.0pt; line-height: 107%;">}</span></p>
</td>
</tr>
</tbody>
</table>
</div>
<h3 id="mcetoc_1g79c8d8d2">2.2. Настройка UFW</h3>
<p>Для защиты подключений рекомендуется настроить межсетевой экран с помощью утилиты Uncomplicated Firewall (UFW).</p>
<p>Просмотреть профили приложений можно с помощью команды: <code>$ sudo ufw app list</code></p>
<p>Для просмотра и изменения параметров используйте соответствующие команды. Например, команда для подключения к NGINX посредством HTTP: <code>$ sudo ufw allow 'NGINX HTTP'</code></p>
<p>Команда для проверки статуса: <code>$ sudo ufw status</code></p>
<h3 id="mcetoc_1g79cack93">2.3. Отключение команды server_tokens</h3>
<p>По умолчанию команда <code>server_tokens </code>возвращает номер версии NGINX.</p>
<p>Чтобы скрыть версию NGINX, отключите команду <code>server_tokens</code>, добавив в файле конфигурации NGINX следующую директиву: <code>server_tokens off</code></p>
<h3 id="mcetoc_1g79ccie54">2.4. Контроль ресурсов и ограничения</h3>
<p>Для предотвращения DoS-атак на NGINX можно установить ограничения на размер буфера для всех клиентов. Для это в разделе <code>server</code> файла конфигурации NGINX используйте следующие директивы:</p>
<ul>
<li><code>client_body_buffer_size</code> — размер буфера тела запроса клиента. Типовое значение — 8 или 16 КБ, но рекомендуется установить его равным 1 КБ с помощью следующей директивы: <code>client_body_buffer_size 1k</code>.</li>
<li><code>client_header_buffer_size</code> — размер буфера заголовка запроса клиента. Размер буфера 1 КБ подходит для большинства запросов, например: <code>client_header_buffer_size 1k</code></li>
<li><code>client_max_body_size</code> — максимально допустимый размер тела клиентского запроса, например:<code> client_max_body_size</code>. Размера 1 КБ должно быть достаточно, но его следует увеличить, если загрузка файлов осуществляется методом POST.</li>
<li><code>large_client_header_buffers</code> —максимальное количество и размер буферов, которые будут использоваться для чтения больших заголовков клиентских запросов. Например, чтобы установить максимальное количество буферов равным 2, каждый с максимальным размером 1 КБ, и разрешить прием URI-данных размером 2 КБ, используйте следующую директиву: <code>large_client_header_buffers 2 1k </code></li>
</ul>
<h3 id="mcetoc_1g79ckddg9">2.5. Настройка NGINX для включения заголовков безопасности</h3>
<p>Чтобы дополнительно защитить веб-сервер NGINX, можно добавить определенные заголовки HTTP. Ниже приведены рекомендованные варианты таких заголовков.</p>
<p><strong>X-Frame-Options</strong></p>
<p>Заголовок HTTP-ответа <code>X-Frame-Options</code> используется чтобы указать, разрешено ли браузеру отображать страницу в фреймах <code>&lt;frame&gt;</code>,<code> &lt;iframe&gt;</code>,<code> &lt;embed&gt;</code> и <code>&lt;object&gt;</code>. Чтобы разрешить отображение страниц во фреймах только с того же домена, на котором размещен веб-сайт, добавьте следующую директиву в раздел server файла конфигурации NGINX: <code>add_header X-Frame-Options "SAMEORIGIN";</code></p>
<p><strong>Strict-Transport-Security</strong></p>
<p><a href="https://www.acunetix.com/blog/articles/what-is-hsts-why-use-it/" rel="noopener" target="_blank">HTTP Strict Transport Security (HSTS)</a> — это механизм, позволяющий веб-сайту сообщать браузеру, что доступ к нему разрешен только через безопасное соединение (HTTPS). Если веб-сайт объявил политику HSTS, браузер должен отклонять все HTTP-соединения и запретить пользователям принимать незащищенные SSL-сертификаты. Чтобы сервер NGINX возвращал заголовок HSTS, добавьте следующую директиву в раздел <code>server</code>: <code>add_ header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";</code></p>
<p><strong>Политика CSP</strong></p>
<p>Политика безопасности контента (CSP) защищает веб-сервер от определенных типов атак, включая атаки с использованием <a href="https://www.acunetix.com/websitesecurity/cross-site-scripting/" rel="noopener" target="_blank">Cross-site Scripting</a> (XSS) и атаки с использованием data injection. Чтобы реализовать CSP, добавьте заголовок Content-Security-Policy, как показано в следующем примере (фактический заголовок должен быть настроен в соответствии с вашими уникальными требованиями) в раздел <code>server</code>: <code>add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always; </code></p>
<p><strong>Заголовок X-XSS-Protection</strong></p>
<p>Заголовок HTTP <a name="_Hlk100239083"></a>X-XSS-Protection поддерживают браузеры IE и Safari. Он не требуется для современных браузеров, если используется строгая политика безопасности содержимого. Однако, чтобы предотвратить атаки типа XSS при использовании старых браузеров (которые не поддерживают CSP), добавьте заголовок X-XSS Protection в раздел <code>server</code>: <code>add_header X-XSS-Protection "1; mode=block”;</code></p>
<h3 id="mcetoc_1g79cqrpta">2.6. Настройка SSL и наборов шифров Cipher Suite</h3>
<p>Конфигурация NGINX по умолчанию позволяет использовать небезопасные старые версии протокола TLS, которые н рекомендуется применять. Следует изменить конфигурацию для поддержки только новых, безопасных версий TLS. Для этого добавьте следующую директиву в раздел <code>server</code> файла конфигурации NGINX:<code> ssl_protocols TLSv1.2 TLSv1.3;</code></p>
<p>Укажите конкретные наборы шифров (криптографических алгоритмов), чтобы предотвратить использование уязвимых наборов не поддерживаются. Либо для автоматического выбора шифра на стороне сервера добавьте следующую директиву в раздел <code>server</code>: <code>ssl_prefer_server_ciphers on;</code></p>
<h3 id="mcetoc_1g79d0shob">2.7. Регулярное обновление сервера</h3>
<p>Следует регулярно устанавливать последние обновления NGINX с официального сайта: <a href="http://nginx.org/en/security_advisories.html">http://NGINX.org/en/security_advisories.html</a></p>
<h3 id="mcetoc_1g79d2g9mc">2.8. Проверка состояния сервера</h3>
<p>Команда проверки статуса веб-сервера NGINX: <code>$ systemctl status NGINX</code></p>
<div class="screenshot_with_caption" style="font-size: 15px !important;">
<p><img alt="Статус веб-сервера NGINX" class="img-responsive" height="282" src="https://kb.comindware.ru/assets/Picture_10.png" width="1263"/></p>
<p class="caption" style="font-size: 15px !important;">Статус веб-сервера NGINX</p>
</div>
<div class="table-responsive">
<p><a class="md-top md-icon mkdocs_imported_link" href="#"> <em class="fa-light fa-arrow-up">‌</em> К началу </a></p>
</div>