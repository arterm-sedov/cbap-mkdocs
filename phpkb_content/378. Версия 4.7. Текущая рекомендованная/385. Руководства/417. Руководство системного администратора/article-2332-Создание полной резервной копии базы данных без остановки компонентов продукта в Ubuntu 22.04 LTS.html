<h1>Создание полной резервной копии базы данных без остановки компонентов продукта в Ubuntu 22.04 LTS</h1><div class="md-container">
<div class="md-main__inner md-grid">
<div class="mce-toc">
<h2 class="toc-heading">Содержание</h2>
<ul>
<li><a href="#mcetoc_1grg4sonu1">Введение</a></li>
<li><a href="#mcetoc_1grg4sonu2">Определения</a></li>
<li><a href="#mcetoc_1grg4sonu3">1. Сбор данных об экземпляре ПО</a></li>
<li><a href="#mcetoc_1grg4sonu4">2. Установка и настройка исполняемых скриптов Apache Ignite</a></li>
<li><a href="#mcetoc_1grg4sonu5">3. Создание резервной копии</a></li>
</ul>
</div>
<div class="md-content">
<h2 id="mcetoc_1grg4sonu1">Введение</h2>
<p>В этой статье представлены инструкции по созданию резервной копии базы данных экземпляра ПО <strong>Comindware Business Application Platform</strong> версии 4.3.0.203, развёрнутого в среде Ubuntu 22.04 LTS.</p>
<p>Для создания полной резервной копии базы данных в ОС Linux необходимо с помощью терминала выполнить следующие действия:</p>
<ul>
<li>создать снимки состояния памяти Apache Ignite и Elasticsearch;</li>
<li>скопировать содержимое папок со скриптами и вложенными файлами.</li>
</ul>
<p>Сведения о восстановлении данных см. в статье «<strong><a href="https://kb.comindware.ru/article.php?id=2335">Полное восстановление базы данных, вложенных файлов и журналов из резервной копии в Ubuntu 22.04 LTS</a></strong>».</p>
<h2 id="mcetoc_1grg4sonu2">Определения</h2>
<ul>
<li><strong><em>ПО</em></strong> — программное обеспечение <strong>Comindware Business Application Platform</strong>.</li>
<li><strong><em>Экземпляр ПО</em></strong> — установленный веб-сайт на основе ПО.</li>
<li><strong><em>База данных экземпляра ПО</em></strong> — набор папок и файлов, содержащий все данные и конфигурацию экземпляра ПО.</li>
<li><strong><em>Система</em></strong> — развёрнутый программно-аппаратный комплекс на основе ПО.</li>
</ul>
<h2 id="mcetoc_1grg4sonu3">1. Сбор данных об экземпляре ПО</h2>
<p>Для создания резервной копии соберите перечисленные ниже данные об экземпляре ПО.</p>
<p>1.1. <code>InstanceName</code> — имя экземпляра ПО, можно получить в ответе на запрос <code>localhost:9200/_cat/indices</code>, например <code>cmw_cmw-study</code>.</p>
<div class="screenshot_with_caption" style="font-size: 15px !important;">
<p><img alt="Определение имени экземпляра ПО" src="https://kb.comindware.ru/assets/Pasted image 20221229181253.png" style="letter-spacing: 0.2px;"/></p>
<p class="caption" style="font-size: 15px !important;"><span style="color: #222222; font-family: '??', '??', '??', '??', '??', ui-sans-serif, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Inter, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Microsoft YaHei Light', sans-serif; font-size: 19px; font-style: italic; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: center; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; caret-color: #222222; background-color: #ffffff; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">Определение имени экземпляра ПО</span></p>
</div>
<p>1.2. Папка с базой данных экземпляра ПО. По умолчанию используется папка <code>/var/www/comindware/data/Database/</code>. Но может быть задан другой путь с помощью директивы <code>&lt;workDirectory&gt;</code> в файле конфигурации <code>/var/www/comindware/Ignite.config</code>. Если в файле конфигурации директива <code>&lt;workDirectory&gt;</code> не содержит пути, используется путь по умолчанию.</p>
<p>1.3. Путь для сохранения снимков базы данных Apache Ignite, по умолчанию: <code>/var/www/comindware/data/Database/snapshots/</code></p>
<p>1.4 <code>elastic_search_repo_name</code> — имя репозитория Elasticsearch, заданное при его регистрации.</p>
<p>1.5. Путь для сохранения резервных копий Elasticsearch. Должен быть указан в директиве <code>path.repo:</code> в файле <code>/etc/elasticsearch/elasticsearch.yml</code>, например <code>/var/www/backups/elasticsearch</code></p>
<div class="screenshot_with_caption" style="font-size: 15px !important;">
<p><img alt="Определение пути для резервных копий Elasticsearch" src="https://kb.comindware.ru/assets/Pasted image 20221229181640.png" style="letter-spacing: 0.2px;"/></p>
<p class="caption" style="font-size: 15px !important;"><span style="color: #222222; font-family: '??', '??', '??', '??', '??', ui-sans-serif, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Inter, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Microsoft YaHei Light', sans-serif; font-size: 19px; font-style: italic; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: center; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; caret-color: #222222; background-color: #ffffff; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">Определение пути для резервных копий Elasticsearch</span></p>
</div>
<p>1.6. <code>snapshot_name</code> — выбранное пользователем имя снимка, лучше в формате <code>&lt;InstanceName&gt;&lt;Date&gt;&lt;Time&gt;</code></p>
<h2 id="mcetoc_1grg4sonu4">2. Установка и настройка исполняемых скриптов Apache Ignite</h2>
<p>2.1. Для установки исполняемых скриптов перейдите в режим суперпользователя <code>root</code>:</p>
<div class="highlight">
<pre><code>sudo -i </code></pre>
</div>
<p>2.2. Проверьте наличие пакета <code>apache-ignite</code> на машине:</p>
<div class="highlight">
<pre><code>dpkg -s apache-ignite </code></pre>
</div>
<p>Если пакет имеется, пропустите шаги 2.3–2.7.</p>
<p>2.3. Если пакета нет, загрузите zip-архив со скриптами:</p>
<div class="highlight">
<pre><code>wget -P /tmp/ https://archive.apache.org/dist/ignite/2.14.0/apache-ignite-2.14.0-bin.zip </code></pre>
</div>
<p>2.4. Если на машине ранее не был установлен пакет <code>zip</code>, установите его:</p>
<div class="highlight">
<pre><code>apt install zip </code></pre>
</div>
<p>2.5. Разархивируйте пакет в папку <code>/var/www/</code>:</p>
<div class="highlight">
<pre><code>unzip /tmp/apache-ignite-2.14.0-bin.zip -d /var/www </code></pre>
</div>
<p>2.6. Переименуйте получившуюся папку со скриптами <code>Apache Ignite</code> в <code>apache-ignite</code>:</p>
<div class="highlight">
<pre><code>mv /var/www/apache-ignite-2.14.0-bin /var/www/apache-ignite </code></pre>
</div>
<p>2.7. Прейдите в папку <code>/var/www/</code>:</p>
<div class="highlight">
<pre><code><span class="nb">cd</span> /var/www/ </code></pre>
</div>
<p>2.8. Назначьте папке <code>apache-ignite</code> права на чтение-запись <code>rwxrwxrwx</code>:</p>
<div class="highlight">
<pre><code>chmod -R <span class="m">777</span> apache-ignite/ </code></pre>
</div>
<p>2.9. Смените владельца папки <code>apache-ignite</code> на <code>www-data</code>:</p>
<div class="highlight">
<pre><code>chown -R www-data:www-data apache-ignite/ </code></pre>
</div>
<div class="screenshot_with_caption" style="font-size: 15px !important;">
<p><img alt="Смена владельца папки apache-ignite" src="https://kb.comindware.ru/assets/Pasted image 20221226120157.png" style="letter-spacing: 0.2px;"/></p>
<p class="caption" style="font-size: 15px !important;"><span style="color: #222222; font-family: '??', '??', '??', '??', '??', ui-sans-serif, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Inter, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Microsoft YaHei Light', sans-serif; font-size: 19px; font-style: italic; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: center; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; caret-color: #222222; background-color: #ffffff; text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">Смена владельца папки apache-ignite</span></p>
</div>
<p>2.10. Создайте папки для сохранения резервных копий:</p>
<div class="highlight">
<pre><code>mkdir /var/www/backups/ </code></pre>
</div>
<p>2.11. Создайте папку репозитория Elasticsearch:</p>
<div class="highlight">
<pre><code>mkdir /var/www/backups/elasticsearch </code></pre>
</div>
<p>2.12. Присвойте папке <code>backups</code> права на чтение-запись <code>rwxrwxrwx</code>:</p>
<div class="highlight">
<pre><code>chmod -R <span class="m">777</span> backups/ </code></pre>
</div>
<p>2.13. Смените владельца папки <code>backups</code> на <code>www-data</code>:</p>
<div class="highlight">
<pre><code>chown -R www-data:www-data backups/ </code></pre>
</div>
<h2 id="mcetoc_1grg4sonu5">3. Создание резервной копии</h2>
<p>При создании снимка после перезагрузки машины необходимо убедиться в том, что экземпляр ПО запущен и Apache Ignite работает. Для этого достаточно в браузере открыть веб-сайт с экземпляром ПО.</p>
<p>3.1. Задайте переменную <code>now</code>:</p>
<div class="highlight">
<pre><code><span class="nv">now</span><span class="o">=</span><span class="k">$(</span>date  %Y_%m_%d_%H_%M<span class="k">)</span> </code></pre>
</div>
<p>3.2. Проверьте окружение и сделайте снимок состояния Apache Ignite:</p>
<div class="highlight">
<pre><code>bash /var/www/apache-ignite/bin/control.sh —baseline bash /var/www/apache-ignite/bin/control.sh —snapshot create snapshot_<span class="nv">$now</span> </code></pre>
</div>
<p>3.3. Зарегистрируйте репозиторий Elasticsearch. Вместо <code>elastic_search_repo_name</code> и <code>/var/www/backups/elasticsearch</code> подставьте своё имя репозитория и путь к его папке:</p>
<div class="highlight">
<pre><code>curl -X PUT <span class="s2">"localhost:9200/_snapshot/elastic_search_repo_name?pretty"</span> -H <span class="s1">'Content-Type: application/json'</span> -d<span class="s1">' {"type": "fs", "settings": {"location": "/var/www/backups/elasticsearch"}}'</span> </code></pre>
</div>
<p>3.4. Сделайте снимок состояния Elasticsearch, заменив <code>elastic_search_repo_name</code>, <code>snapshot-$now</code> и <code>InstanceName</code> на свои значения:</p>
<div class="highlight">
<pre><code>curl -X PUT <span class="s2">"localhost:9200/_snapshot/elastic_search_repo_name/snapshot-</span><span class="nv">$now</span><span class="s2">?wait_for_completion=true&amp;pretty"</span> -H <span class="s1">'Content-Type: application/json'</span> -d<span class="s1">' {"indices": "InstanceName*", "ignore_unavailable": true, "include_global_state": false}'</span> </code></pre>
</div>
<p>3.5. Создайте папки для хранения компонентов резервной копии:</p>
<div class="highlight">
<pre><code>mkdir /var/www/backups/backup_<span class="nv">$now</span> mkdir /var/www/backups/backup_<span class="nv">$now</span>/Database mkdir /var/www/backups/backup_<span class="nv">$now</span>/elastic mkdir /var/www/backups/backup_<span class="nv">$now</span>/Streams mkdir /var/www/backups/backup_<span class="nv">$now</span>/Scripts mkdir /var/www/backups/backup_<span class="nv">$now</span>/wal </code></pre>
</div>
<p>3.6. Перенесите и скопируйте компоненты в папку резервной копии:</p>
<div class="highlight">
<pre><code>mv /var/www/comindware/data/Database/snapshots/snapshot_<span class="nv">$now</span> /var/www/backups/backup_<span class="nv">$now</span>/Database cp -r /var/www/backups/elasticsearch/* /var/www/backups/backup_<span class="nv">$now</span>/elastic cp -r /var/www/comindware/data/Database/wal/* /var/www/backups/backup_<span class="nv">$now</span>/wal cp -r /var/www/comindware/data/Database/Scripts/* /var/www/backups/backup_<span class="nv">$now</span>/Scripts cp -r /var/www/comindware/data/Streams/* /var/www/backups/backup_<span class="nv">$now</span>/Streams </code></pre>
</div>
<p>3.7. Создайте архив с резервной копией:</p>
<div class="highlight">
<pre><code>tar -cvjf backup_<span class="nv">$now</span>.tar.bz2 /var/www/backups/backup_<span class="nv">$now</span> </code></pre>
</div>
<p>3.8. Перенесите архив с резервной копией во внешнее хранилище.</p>
</div>
</div>
<a class="md-top md-icon" href="#"> К началу </a></div>
<div class="md-dialog">
<div class="md-dialog__inner md-typeset"> </div>
</div>