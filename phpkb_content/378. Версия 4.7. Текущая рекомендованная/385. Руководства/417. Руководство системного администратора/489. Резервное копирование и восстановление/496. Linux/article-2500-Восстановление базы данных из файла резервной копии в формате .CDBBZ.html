<h1>Восстановление базы данных из файла резервной копии в формате .CDBBZ</h1><div class="md-container">
<div class="md-main__inner md-grid">
<div class="mce-toc">
<h2 class="toc-heading">Содержание</h2>
<ul>
<li><a href="#mcetoc_1gs760qqh1">Введение</a></li>
<li><a href="#mcetoc_1gs760qqh4">Восстановление базы данных и скриптов</a></li>
<li><a href="#mcetoc_1grg5gft87">Восстановление индексов Elasticsearch из файла резервной копии репозитория</a></li>
<li><a href="#mcetoc_1hub0jkce1">Запуск и проверка конфигурации экземпляра ПО</a></li>
<li><a href="#mcetoc_1hpqjbccb0">Связанные статьи</a></li>
</ul>
</div>
<h2 id="mcetoc_1gs760qqh1">Введение</h2>
<p>В данном разделе представлены инструкции по восстановлению на чистом экземпляре ПО <strong>Comindware Business Application Platform </strong>(далее — ПО, экземпляр ПО) под управлением ОС Linux  базы данных из файла резервной копии с расширением <code>
            .CDBBZ
            </code> , созданного с помощью встроенной в ПО функции «<strong>Резервное копирование</strong> ». См. <em>«<samp data-name="aid" data-title="" data-value="2190"><img src="https://kb.comindware.ru/images/marker.png"/>Резервное копирование. Настройка и запуск, просмотр журнала сеансов {Article-ID:2190}</samp></em><em>»</em><em>. </em></p>
<p>См. также инструкции по полному резервному копированию и восстановлению базы данных внешними средствами:</p>
<ul>
<li><em><samp data-name="aid" data-title="" data-value="2117"><img src="https://kb.comindware.ru/images/marker.png"/>Создание полной резервной копии (базы данных, вложенных файлов и журналов) без остановки экземпляра ПО в Linux{Article-ID:2117}</samp></em></li>
<li><em><samp data-name="aid" data-title="" data-value="2335"><img src="https://kb.comindware.ru/images/marker.png"/>Восстановление базы данных, вложенных файлов и журналов из полной резервной копии в Linux{Article-ID:2335}</samp></em></li>
</ul>
<h2 id="mcetoc_1gs760qqh4">Восстановление базы данных и скриптов</h2>
<ol class="colored_numbers_list">
<li>Перейдите в режим суперпользователя:
<pre><code>su -</code></pre>
<p>или</p>
<pre><code>sudo -i</code></pre>
</li>
<li>Разверните чистый экземпляр ПО <em>без демонстрационной базы данных </em>(с параметром <code>-d=clear</code>). См. <em>«<a href="https://kb.comindware.ru/category.php?id=491">Развертывание </a></em><a href="https://kb.comindware.ru/category.php?id=491"><em>Comindware Business Application Platform</em></a><em><em>». Например:</em> </em>
<div>
<pre class="source_code_container"><code>sh install.sh -k -p [-i=<em><strong>&lt;instanceName</strong><strong>&gt;</strong></em>] [-e] <em><strong>-d=clear</strong></em> [-u=www-data] [-g=www-data]</code></pre>
<p>Скрипт <code>install.sh</code> поддерживает следующие ключи:</p>
<ul>
<li><code>k</code> — установить ПО Kafka;</li>
<li><code>e</code> — установить ПО Elasticsearch;</li>
<li><code>p</code> — установить ПО Comindware Business Application Platform;</li>
<li><code></code><code><em><strong>d=clear</strong></em></code> <em>— создать экземпляр ПО Comindware Business Application Platform без демонстрационной базы данных;</em><code></code></li>
<li><code>d=demo</code> — создать экземпляр ПО Comindware Business Application Platform c демонстрационной базой данных (не обязательный ключ по умолчанию);</li>
<li><code>u</code> — пользователь (необязательный ключ);</li>
<li><code>g</code> — группа (необязательный ключ);</li>
<li><code>h</code> — вызов краткой справки по использованию скрипта (этот ключ следует указывать без остальных ключей);</li>
<li><code>kh=hostname</code> — использовать указанный хост для подключения к ПО Kafka (необязательный ключ);</li>
<li><code>kp=portnumber</code> — использовать указанный порт для подключения к ПО Kafka (необязательный ключ);</li>
<li><code>i=<em><strong>&lt;instanceName</strong><strong>&gt;</strong></em></code> — создать экземпляр ПО с указанным именем (необязательный ключ). Имя экземпляра по умолчанию: <code>cmwdata</code>.</li>
</ul>
</div>
</li>
<li>Инициализируйте экземпляр ПО. См. <em>«<a href="https://kb.comindware.ru/category.php?id=491">Развертывание </a></em><a href="https://kb.comindware.ru/category.php?id=491"><em>Comindware Business Application Platform</em></a><em>»</em>.</li>
<li>Остановите сервисы NGINX и comindware<code><strong><em>&lt;instanceName&gt;</em></strong></code> (где <code><strong><em>&lt;instanceName&gt;</em></strong></code> — имя экземпляра ПО) и удостоверьтесь, что они остановлены:
<pre><code>systemctl stop nginx comindware<strong><em>&lt;instanceName</em></strong></code><strong><em>&gt;</em></strong> <br/><code>systemctl status nginx comindware<strong><em>&lt;instanceName</em></strong><strong><em>&gt;</em></strong></code></pre>
</li>
<li><a id="unpack_backup"></a>Распакуйте архив резервной копии в каталог <code>/var/lib/comindware/<strong><em>&lt;instanceName</em></strong><strong><em>&gt;</em></strong>/</code>:
<pre><code>unzip /tmp/BackupFileName.202302161625.cdbbz -d /var/lib/comindware/<strong><em>&lt;instanceName</em></strong><strong><em>&gt;</em></strong>/</code></pre>
</li>
<li>Если в папке резервной копии (<code>/var/lib/comindware/<em><strong>&lt;instanceName</strong><strong>&gt;</strong></em>/</code>) имеется каталог <code>Ignite</code>, переименуйте его в <code>Database</code>:
<pre><code>cd /var/lib/comindware/<strong><em>&lt;instanceName</em></strong><strong><em>&gt;</em></strong>/</code> <br/><code>mv Ignite Database</code></pre>
</li>
<li>Перенесите каталог <code>Scripts</code> резервной копии в каталог <code>Database</code>:
<pre><code>mv Scripts /var/lib/comindware/<strong><em>&lt;instanceName</em></strong><strong><em>&gt;</em></strong>/Database/</code></pre>
</li>
<li>Назначьте перенесённым каталогам права <code>rwxrw-rw-</code>:
<pre><code>chmod -R 766 /var/lib/comindware/<em><strong>&lt;instanceName</strong><strong>&gt;</strong></em></code></pre>
</li>
<li>Назначьте перенесенным каталогам владельца:
<p><strong>Astra Linux, Ubuntu, Rocky</strong></p>
<pre><code>chown -R www-data:www-data /var/lib/comindware/<em><strong>&lt;instanceName</strong><strong>&gt;</strong></em></code></pre>
<p><strong>Альт Сервер</strong></p>
<pre><code>chown -R _nginx:_nginx /var/lib/comindware/<em><strong>&lt;instanceName</strong><strong>&gt;</strong></em></code></pre>
</li>
</ol>
</div>
</div>
<h2 id="mcetoc_1grg5gft87">Восстановление индексов Elasticsearch из файла резервной копии репозитория</h2>
<ol class="colored_numbers_list">
<li>Остановите службу Elasticsearch и удостоверьтесь, что она остановлена:
<pre><code>systemctl stop elasticsearch</code> <br/><code>systemctl status elasticsearch</code></pre>
</li>
<li>Создайте папку репозитория Elasticsearch (например, <code>/var/www/backups/elasticsearch/</code>) и перенесите в неё файлы из каталога <code>History</code> ранее <a href="#unpack_backup">распакованной резервной копии</a>:
<pre><code>mkdir /var/www/backups/elasticsearch/ <br/>mv /var/lib/comindware/<em><strong>&lt;instanceName</strong><strong>&gt;</strong></em>/History/* /var/www/backups/elasticsearch/</code></pre>
</li>
<li>
<p>Назначьте папке репозитория и её содержимому права <code>rwxr-xr-x</code>:</p>
<pre><code>chmod -R <span class="m">755</span> /var/www/backups/ </code></pre>
</li>
<li>
<p>Назначьте владельца <code>elasticsearch</code> папке репозитория и её содержимому:</p>
<div class="highlight">
<pre><code>chown -R elasticsearch:elasticsearch /var/www/backups/ </code></pre>
</div>
</li>
<li>
<p>В файле конфигурации <code>/etc/elasticsearch/elasticsearch.yml</code> укажите путь к созданному репозиторию:</p>
<pre><code>path.repo: /var/www/backups/elasticsearch</code></pre>
</li>
<li>
<p>Запустите службу Elasticsearch:</p>
<div class="highlight">
<pre><code>systemctl start elasticsearch.service </code></pre>
</div>
</li>
<li>
<p>Зарегистрируйте репозиторий (например, <code><span class="s1">repostory_backup</span></code>) с резервной копией снимка Elasticsearch:</p>
<div class="highlight">
<pre><code><span class="s1">curl -X PUT "localhost:9200/_snapshot/repostory_backup?pretty" -H ’Content-Type: application/json’ -d’<br/>{<br/>"type": "fs",<br/>"settings": {<br/>            "location": "/var/www/backups/elasticsearch"<br/>            }<br/>}<br/></span></code></pre>
</div>
<div class="notice notice-info">
<p class="admonition-title"><a id="s3_repository"></a>Примечание</p>
<p>Шаги 7 и 8 не требуются при восстановлении снимка из хранилища S3.</p>
<p>Для восстановления снимка из хранилища S3 используйте репозиторий с именем, совпадающим с префиксом индекса Elasticsearch.</p>
<p>Этот репозиторий создаётся автоматически при запуске резервного копирования</p>
<p>Префикс индекса задаётся в <a href="https://kb.comindware.ru/article.php?id=2593">свойствах подключения к Elasticsearch</a>, используемого по умолчанию.</p>
</div>
</li>
<li>
<p>Проверьте содержимое зарегистрированного репозитория:</p>
<div class="highlight">
<pre><code>curl -X GET <span class="s2">"localhost:9200/_cat/snapshots/<span class="s1">repostory_backup</span>?pretty"</span></code></pre>
</div>
</li>
<li>
<p>Восстановите снимок Elasticsearch:</p>
<div class="highlight">
<pre><code>curl -X POST "localhost:9200/_snapshot/<span class="s1">repostory_backup</span>/backupSession123/_restore?pretty" </code></pre>
</div>
<ul>
<li>
<p>В качестве репозитория укажите имя репозитория, созданного на шаге 7, или префикс индекса Elasticsearch (см. <a href="#s3_repository">примечание</a> выше).</p>
</li>
<li>
<p>В качестве имени снимка укажите идентификатор резервной копии <strong>без точки перед номером</strong> (например, <code>backupSession</code><code>.123</code> указывайте как <code>backupSession</code><code>123</code>) со страницы <a href="https://kb.comindware.ru/article.php?id=2190#mcetoc_1gjrihkcn1">«Администрирование» – «Инфраструктура» – «Резервное копирование» – «Журнал»</a>:</p>
</li>
</ul>
</li>
<li>
<p>Проверьте наличие индексов в восстановленном каталоге:</p>
<div class="highlight">
<pre><code>curl -X GET "localhost:9200/_cat/indices?pretty"</code></pre>
</div>
</li>
</ol>
<h2 id="mcetoc_1hub0jkce1">Запуск и проверка конфигурации экземпляра ПО</h2>
<ol class="colored_numbers_list">
<li>Запустите необходимые службы и проверьте их статус: <br/>
<pre><code>systemctl start nginx comindware<em><strong>&lt;</strong><strong><em>instanceName&gt;</em></strong></em></code> <br/><code>systemctl status nginx comindware<em><strong>&lt;</strong><strong>instanceName&gt;</strong></em></code></pre>
</li>
<li>Откройте веб-сайт экземпляра ПО.</li>
<li>Дождитесь инициализации экземпляра ПО. Этот процесс может занять некоторое время. Может потребоваться обновить страницу браузера.</li>
<li>Удостоверьтесь, что все данные из резервной копии восстановлены.</li>
<li>Проверьте и исправьте конфигурацию экземпляра. См. <em style="letter-spacing: 0.2px;">«<samp data-name="aid" data-title="" data-value="2618"><span style="color: #0066bc; font-family: Tahoma;"><img src="https://kb.comindware.ru/images/marker.png"/>Проверка и настройка конфигурации экземпляра ПО после восстановления из резервной копии {Article-ID:2618}</span></samp>».</em><code></code></li>
</ol>
<h2 id="mcetoc_1hpqjbccb0">Связанные статьи</h2>
<p><strong><samp data-name="aid" data-title="" data-value="2117"><img src="https://kb.comindware.ru/images/marker.png"/>Создание полной резервной копии (базы данных, вложенных файлов и журналов) без остановки экземпляра ПО в Linux{Article-ID:2117}</samp></strong></p>
<p><strong><samp data-name="aid" data-title="" data-value="2335"><img src="https://kb.comindware.ru/images/marker.png"/>Восстановление базы данных, вложенных файлов и журналов из полной резервной копии в Linux{Article-ID:2335}</samp>».</strong></p>
<p><strong><samp data-name="aid" data-title="" data-value="2190"><img src="https://kb.comindware.ru/images/marker.png"/>Резервное копирование. Настройка и запуск, просмотр журнала сеансов {Article-ID:2190}</samp></strong></p>
<p><strong><a href="https://kb.comindware.ru/category.php?id=491">Развертывание </a><a href="https://kb.comindware.ru/category.php?id=491">Comindware Business Application Platform</a></strong></p>
<p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-filesystem-repository.html">Регистрация репозитория Elasticsearch (официальное руководство, английский язык)</a></strong></p>
<p><strong><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/restore-snapshot-api.html">Восстановление снимка Elasticsearch (официальное руководство, английский язык)</a></strong></p>
<p><strong><samp data-name="aid" data-title="" data-value="2593"><span style="color: #0066bc; font-family: Tahoma;"><img src="https://kb.comindware.ru/images/marker.png" style="vertical-align: middle;"/>Elasticsearch. Настройка подключения {Article-ID:2593}</span></samp> </strong></p>
<div class="md-container">
<p><a class="md-top md-icon mkdocs_imported_link" href="#"><em class="fa-light fa-arrow-up">‌</em> К началу </a></p>
</div>