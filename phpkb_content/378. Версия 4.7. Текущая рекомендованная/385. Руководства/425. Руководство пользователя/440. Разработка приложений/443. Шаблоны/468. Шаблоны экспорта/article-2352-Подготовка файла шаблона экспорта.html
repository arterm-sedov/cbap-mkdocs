<h1>Подготовка файла шаблона экспорта</h1><div class="md-container">
<div class="md-main__inner md-grid">
<div class="mce-toc">
<h2 class="toc-heading">Содержание</h2>
<ul>
<li><a href="#mcetoc_1h1patrmb1">Определения</a></li>
<li><a href="#mcetoc_1h1p7o4cm1">Создание файла шаблона экспорта</a></li>
<li><a href="#mcetoc_1h1p7o4cm2">Синтаксис полей шаблона экспорта</a>
<ul>
<li><a href="#mcetoc_1h1p7o4cm3">Синтаксис для экспорта с использованием формул</a></li>
<li><a href="#mcetoc_1h1p7o4cm4">Синтаксис для экспорта с использованием C#</a>
<ul>
<li><a href="#mcetoc_1h1p7o4cm5">Синтаксис для XLSX-файлов</a></li>
<li><a href="#mcetoc_1h1p7o4cm6">Синтаксис для DOCX-файлов</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mcetoc_1hkdp7acq3">Использование шрифтов в шаблонах экспорта в формате PDF</a>
<ul>
<li><a href="#mcetoc_1hkdplq1p5">Решение для Word</a></li>
<li><a href="#mcetoc_1hkdpmh3a6">Решение для Excel</a>
<ul>
<li><a href="#mcetoc_1hkdqmpmn7">Вариант 1</a></li>
<li><a href="#mcetoc_1hkdqnmi28">Вариант 2</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#mcetoc_1hkdp50gn1">Связанные статьи</a></li>
</ul>
</div>
<div class="md-content">
<div class="notice notice-success">
<h3 id="mcetoc_1h1patrmb1">Определения</h3>
<ul>
<li><strong>Файл шаблона экспорта</strong> представляет собой макет для выгрузки данных записи с требуемым визуальным оформлением.</li>
<li>Файл шаблона можно сформировать в формате <code>DOCX</code> или <code>XLSX</code>.</li>
<li>В файл шаблона экспорта необходимо вставить поля согласно определённому <a href="#синтаксис-полей-шаблона-экспорта">синтаксису</a>. Эти поля будут заменены на экспортируемые данные.</li>
</ul>
</div>
<h2 id="mcetoc_1h1p7o4cm1">Создание файла шаблона экспорта</h2>
<ol>
<li>Создайте документ Excel (<code>XLSX</code>) или Word (<code>DOCX</code>).</li>
<li>Введите в документ требуемые сведения.</li>
<li>Отформатируйте документ обычным образом.</li>
<li>Введите <a href="#mcetoc_1h1p7o4cm2">поля</a> в те места документа, куда требуется экспортировать данные записи.</li>
<li>
<p>Должен получиться документ следующего вида (см. <a href="https://kb.comindware.ru/article.php?id=2353">пример</a>):</p>
<div class="screenshot_with_caption"><a class="glightbox" href="https://kb.comindware.ru/assets/export_template_file_example.png"><img alt="Пример простейшего файла шаблона экспорта" src="https://kb.comindware.ru/assets/export_template_file_example.png"/></a>
<p class="caption">Пример простейшего файла шаблона экспорта</p>
</div>
</li>
</ol>
<h2 id="mcetoc_1h1p7o4cm2">Синтаксис полей шаблона экспорта</h2>
<p>В файле шаблона экспорта используются поля-заполнители. При экспорте данных записи поля заменяются значениями атрибутов, а остальной текст остаётся без изменений.</p>
<p>Синтаксис полей зависит от того, используется ли для экспорта данных <a href="#mcetoc_1h1p7o4cm4">скрипт C#</a>.</p>
<h3 id="mcetoc_1h1p7o4cm3">Синтаксис для экспорта с использованием формул</h3>
<ul>
<li>В документ введите поля вида <code>{AttributeSystemName}</code> ( <em>без пробелов</em> в фигурных скобках), где <code>AttributeSystemName</code> — системное имя атрибута, значение которого необходимо экспортировать в файл. Значение атрибута будет экспортировано в формате отображения, заданном в свойствах атрибута.</li>
<li><code>{RecordAttribute.LinkedTemplateAttribute}</code> — чтобы экспортировать значение атрибута связанного шаблона, укажите его системное имя через точку <em>без пробела</em> после системного имени атрибута типа «<strong>Запись</strong>».</li>
<li><code>{#LinkedTemplateAttribute}</code> — чтобы экспортировать значение атрибута типа «<strong>Запись</strong>» в виде гиперссылки на запись связанного шаблона, укажите системное атрибута с префиксом <code>#</code>. Гиперссылка будет содержать идентификатор или заголовок записи (если в шаблоне указан <a href="https://kb.comindware.ru/article.php?id=2255">атрибут-заголовок</a>).</li>
<li>
<p><code>{foreach:RecordAttribute} {#LinkedAttribute1} {LinkedAttribute2} {end:RecordAttribute}</code> — для экспорта данных из нескольких записей связанного шаблона используйте операторы <code>foreach</code> и <code>end</code> в строке таблицы:</p>
<ul style="list-style-type: circle;">
<li>Строка таблицы с операторами <code>foreach</code> и <code>end</code> будет преобразована в несколько строк с данными записей связанного шаблона.</li>
<li>В первом столбце строки введите в фигурных скобках оператор <code>foreach</code> и через двоеточие <em>без пробела</em> системное имя атрибута типа «<strong>Запись</strong>».</li>
<li>В последнем столбце строки введите в фигурных скобках оператор <code>end</code> и через двоеточие <em>без пробела</em> системное имя атрибута типа «<strong>Запись</strong>»;</li>
<li>Между операторами <code>foreach</code> и <code>end</code> введите системные имена атрибутов связанного шаблона в фигурных скобках.</li>
</ul>
</li>
<li>
<p><strong><code>{AttributeSystemName} полужирный текст</code></strong><em><code>{AttributeSystemName2} курсив</code></em> — между полями можно располагать произвольный текст. Текст и поля можно форматировать (курсивом, полужирным шрифтом и т. п.). Экспортируемые данные будут отформатированы соответствующим образом.</p>
</li>
<li>
<p><code>{ImageAttributeSystemName}</code> — если в поле указано системное имя атрибута типа «<a href="https://kb.comindware.ru/article.php?id=2253"><strong>Изображение</strong></a>», поле будет заменено на изображение, хранящееся в атрибуте.</p>
</li>
<li>
<p><code>{QRCodeAttributeSystemName:200:100}</code> — если в поле указано системное имя атрибута типа «<a href="https://kb.comindware.ru/article.php?id=2393"><strong>Штрихкод</strong></a>», поле будет заменено на изображение штрихкода, сформированного по значению атрибута. Для штрихкода можно указать ширину и высоту через двоеточие после системного имени атрибута. Если указать только ширину, то штрихкод будет квадратным. Если не указывать ширину и высоту, то будет использоваться стандартный размер штрихкода.</p>
<div class="screenshot_with_caption"><a class="glightbox" href="https://kb.comindware.ru/assets/export_template_file_advanced_syntax_example.png"><img alt="Пример синтаксиса полей шаблона экспорта" src="https://kb.comindware.ru/assets/export_template_file_advanced_syntax_example.png"/></a>
<p class="caption">Пример синтаксиса полей шаблона экспорта</p>
</div>
</li>
</ul>
<h3 id="mcetoc_1h1p7o4cm4">Синтаксис для экспорта с использованием C#</h3>
<p>Экспортировать данные посредством шаблона экспорта можно с помощью скрипта C#. Это позволяет более гибко настроить параметры экспорта, например с дополнительной фильтрацией, заменой информации, форматированным выводом <a href="https://kb.comindware.ru/article.php?id=2243">атрибутов типа «<strong>Запись</strong>»</a> с несколькими значениями (коллекций).</p>
<p>Скрипт C# для шаблона экспорта следует ввести на вкладке «<strong>Скрипт</strong>» <a href="https://kb.comindware.ru/article.php?id=2348">кнопки экспорта</a>, которая автоматически создаётся для каждого шаблона экспорта.</p>
<p>Примеры скриптов C# для экспорта данных см. в статьях <em>«<a href="https://kb.comindware.ru/article.php?id=1942">Настройка шаблона экспорта с использованием C#</a>»</em>, и <em>«<a href="https://kb.comindware.ru/article.php?id=1944">Настройка выгрузки нескольких коллекций и изображений</a>».</em></p>
<p>При экспорте данных с помощью С# синтаксис полей шаблона экспорта различается в зависимости от формата файла шаблона экспорта:</p>
<h4 id="mcetoc_1h1p7o4cm5">Синтаксис для XLSX-файлов</h4>
<ul>
<li>
<p>Скрипт C# должен передавать данные в функцию:<code></code></p>
<div class="highlight">
<pre class="source_code_container"><code><span class="n">Api</span><span class="p">.</span><span class="n">TeamNetwork</span><span class="p">.</span><span class="n">ObjectAppExportService</span><span class="p">.</span><span class="n">ExecuteExcelExportTemplate</span><span class="p">(</span><span class="s">"exportTemplate.N"</span><span class="p">,</span> <span class="n">dataToExport</span><span class="p">)</span> </code></pre>
</div>
<p>Здесь:</p>
<ul style="list-style-type: circle;">
<li><code>exportTemplate.N</code> — ID шаблона экспорта;</li>
<li><code>dataToExport</code> — массив объектов с экспортируемыми данными.</li>
</ul>
</li>
<li>
<p>В ячейки введите поля вида <code>&amp;=data.propertyName</code>.</p>
<ul style="list-style-type: circle;">
<li>Здесь <code>data</code> — массив экспортируемых данных, переданный скриптом C#.</li>
<li><code>propertyName</code> — имя свойства элемента массива <code>data</code>, значение которого необходимо поместить в ячейку.</li>
</ul>
</li>
<li>
<p>В одной ячейке может быть только одно поле.</p>
</li>
<li>Для корректного экспорта данных необходимо указать формат ячейки, соответствующий типу экспортируемого значения.</li>
<li>
<p>Объявлять циклы <code>foreach</code> не требуется: для массивов строки на листе формируются автоматически.</p>
<div class="notice notice-warning">
<p class="admonition-title"><strong>Внимание!</strong></p>
<ul>
<li>
<p>Если поле обращается к свойству, имеющему тип массива (например, <code>LIST&lt;T&gt;</code>), то это свойство не может быть <code>null</code> и <code>undefined</code> (то есть массив обязательно должен быть объявлен), <em>в противном случае экспорт не будет выполнен</em>.</p>
</li>
<li>
<p>Например, если <code>&amp;=data.Contract</code> имеет тип <code>LIST&lt;T&gt;</code>, то у каждого объекта в массиве <code>data</code> должно быть объявлено свойство <code>Contract</code>.</p>
</li>
</ul>
</div>
<p> </p>
<div class="screenshot_with_caption"><a class="glightbox" href="https://kb.comindware.ru/assets/export_template_file_c_syntax_example_xlsx.png"><img alt="Пример XSLX-файла шаблона экспорта для C#" src="https://kb.comindware.ru/assets/export_template_file_c_syntax_example_xlsx.png"/></a>
<p class="caption">Пример XSLX-файла шаблона экспорта для C#</p>
</div>
</li>
</ul>
<h4 id="mcetoc_1h1p7o4cm6">Синтаксис для DOCX-файлов</h4>
<ul>
<li>
<p>Скрипт C# должен передавать данные в функцию:</p>
<div class="highlight">
<pre class="source_code_container"><code>Api.TeamNetwork.ObjectAppExportService.ExecuteWordExportTemplate("exportTemplate.N", dataToExport) </code></pre>
</div>
<p>Здесь:</p>
<ul style="list-style-type: circle;">
<li><code>exportTemplate.N</code> — ID шаблона экспорта;</li>
<li><code>dataToExport</code> — объект класса <code>RESULT</code>, содержащий экспортируемые данные.</li>
</ul>
</li>
<li>
<p>В документ введите поля вида <code>&lt;&lt;[propertyName]&gt;&gt;</code>, где <code>propertyName</code> — имя свойства объекта <code>dataToExport</code>, значение которого необходимо поместить в текст.</p>
</li>
<li>
<p>Чтобы экспортировать массив данных, используйте в строке таблицы или абзаце следующую конструкцию:</p>
<div class="highlight">
<pre class="source_code_container"><code>&lt;&lt;foreach [row in dataArray]&gt;&gt;&lt;&lt;[row.property0]&gt;&gt; &lt;&lt;[row.property1]&gt;&gt; ... &lt;&lt;[row.propertyN]&gt;&gt;&lt;&lt;/foreach&gt;&gt; </code></pre>
</div>
или
<div class="highlight">
<pre class="source_code_container"><code>&lt;&lt;foreach [in dataArray]&gt;&gt;&lt;&lt;[property0]&gt;&gt; &lt;&lt;[property1]&gt;&gt; ... &lt;&lt;[propertyN]&gt;&gt;&lt;&lt;/foreach&gt;&gt; </code></pre>
</div>
Здесь:
<ul style="list-style-type: circle;">
<li><code>foreach</code> — оператор цикла по массиву <code>dataArray</code></li>
<li><code>row</code> — переменная-итератор цикла (<em>необязательная</em>);</li>
<li><code>dataArray</code> — имя массива, переданного в объекте <code>dataToExport</code>.</li>
<li><code>property0</code>...<code>propertyN</code> — имена свойств элементов массива <code>dataArray</code>, значения которых необходимо поместить в текст.</li>
</ul>
</li>
<li>
<p>Чтобы экспортировать изображение, введите поле вида <code>&lt;&lt;image [imageData]&gt;&gt;</code>, где <code>imageData</code> — имя массива типа <code>byte</code> с данными изображения, переданного в объекте <code>dataToExport</code>.</p>
<div class="screenshot_with_caption"><a class="glightbox" href="https://kb.comindware.ru/assets/export_template_file_c_syntax_example_docx.png"><img alt="Пример DOCX-файла шаблона экспорта для C#" src="https://kb.comindware.ru/assets/export_template_file_c_syntax_example_docx.png"/></a>
<p class="caption">Пример DOCX-файла шаблона экспорта для C#</p>
</div>
</li>
</ul>
<h2 id="mcetoc_1hkdp7acq3">Использование шрифтов в шаблонах экспорта в формате PDF</h2>
<p>Если в <a href="https://kb.comindware.ru/article.php?id=2349">свойствах шаблона экспорта</a> установлен флажок «<strong>Экспортировать как PDF</strong>», файлы PDF формируются с использованием шрифтов, установленных на сервере c экземпляром ПО <strong>Comindware Business Application Platform</strong> (далее «<strong>Сервер</strong>»).</p>
<p>При формировании файлов PDF из шаблонов экспорта Сервер может подставлять произвольные шрифты с другим начертанием, что может привести к некорректному форматированию файлов PDF.</p>
<p>Это может быть связано с тем, что <span style="letter-spacing: 0.2px;">Сервере отсутствуют шрифты, которые используются в файле шаблона экспорта:</span></p>
<ul>
<li>На Сервере с Windows в некоторых случаях могут отсутствовать стандартные шрифты Times New Roman и Arial;</li>
<li>На Сервере с Linux могут отсутствовать какие бы то ни было шрифты, либо могут использоваться шрифты, отличные от шрифтов Windows.</li>
</ul>
<p>Набор шрифтов, доступных на Сервере, известен администратору операционной системы.</p>
<h3 id="mcetoc_1hkdplq1p5">Решение для Word</h3>
<p>Чтобы файлы PDF правильно форматировались при экспорте, в файлы DOCX шаблонов экспорта следует внедрять шрифты:</p>
<ol>
<li>В меню «<strong>Файл</strong>» выберите пункт «<strong>Параметры</strong>».</li>
<li>В окне «<strong>Параметры Word</strong>» перейдите на вкладку «<strong>Сохранение</strong>».</li>
<li>В разделе «<strong>Сохранение качества при совместном использовании документа</strong>»:
<ul>
<li>установите флажок «<strong>Внедрить шрифты в файл</strong>»;</li>
<li>снимите флажок «<strong>Не внедрять обычные системные шрифты</strong>».</li>
</ul>
</li>
<li>Нажмите кнопку «<strong>OK</strong>».</li>
<li>Сохраните файл DOCX и используйте его в качестве шаблона экспорта.</li>
</ol>
<h3 id="mcetoc_1hkdpmh3a6">Решение для Excel</h3>
<p>Чтобы файлы PDF правильно форматировались при экспорте из шаблонов экспорта в формате XSLX используйте один из двух подходов:</p>
<ul>
<li>установить шрифты, используемые в файле Excel, на сервер CBAP;</li>
<li>установить шрифты с сервера CBAP в Windows и использовать их в файле Excel.</li>
</ul>
<h4 id="mcetoc_1hkdqmpmn7">Вариант 1</h4>
<ol>
<li>Составьте список шрифтов, которые используются в файле Excel шаблона экспорта.</li>
<li>Выберите необходимые файлы шрифтов в папке <code>C:\Windows\Fonts</code> (требуется доступ администратора).</li>
<li>Создайте архив с файлами шрифтов, например, в своей папке <code>Downloads</code>.</li>
<li>Перенесите архив с шрифтами на сервер с экземпляром ПО CBAP.</li>
<li>Установите шрифты на сервер с экземпляром ПО CBAP.</li>
</ol>
<h4 id="mcetoc_1hkdqnmi28">Вариант 2</h4>
<ol>
<li>Соберите все шрифты на сервере CBAP:<br/>
<ul>
<li>папка <code>C:\Windows\Fonts</code> — Windows</li>
<li>каталог <code>/usr/share/fonts</code> — Linux</li>
</ul>
</li>
<li>Установите шрифты с сервера CBAP на компьютер, где вы редактируете файл Excel шаблона экспорта:
<ul>
<li>поместите шрифты в папку в папку <code>C:\Windows\Fonts</code>;<br/><strong>или</strong></li>
<li>откройте каждый файл шрифта и нажмите в окне просмотра шрифта кнопку «<strong>Установить</strong>».</li>
</ul>
</li>
<li>Используйте в файле Excel шаблона экспорта только шрифты, перенесённые с сервера CBAP.</li>
</ol>
<h2 id="mcetoc_1hkdp50gn1">Связанные статьи</h2>
<p><strong><a href="https://kb.comindware.ru/article.php?id=2353">Пример настройки и использования шаблона экспорта авансового отчёта</a></strong></p>
<p><strong><a href="https://kb.comindware.ru/article.php?id=1944">Настройка выгрузки нескольких коллекций и изображений</a></strong></p>
<p><strong><a href="https://kb.comindware.ru/article.php?id=1942">Настройка шаблона экспорта с использованием C#</a></strong></p>
<p><strong><a href="https://kb.comindware.ru/article.php?id=2349">Настройка шаблона экспорта</a></strong></p>
<p><strong><a href="https://kb.comindware.ru/article.php?id=2348">Настройка кнопки экспорта</a></strong></p>
</div>
</div>
<a class="md-top md-icon" href="#"> К началу </a></div>
<div class="md-dialog">
<div class="md-dialog__inner md-typeset"> </div>
</div>